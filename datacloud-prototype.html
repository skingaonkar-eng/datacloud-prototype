<!DOCTYPE html>
<!-- Last Updated: 2026-02-16 17:00 IST - Conversational Filters + AI Recommendations - DEPLOYED -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Cloud - Segment Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
            overflow-x: hidden;
        }

        /* Data Cloud Navigation */
        .datacloud-nav-wrapper {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
        }

        /* Logo Section - Spans Both Bars */
        .dc-logo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-right: 1px solid #e5e7eb;
            background: white;
            min-width: 140px;
        }

        .dc-cloud-icon {
            width: 40px;
            height: 40px;
        }

        .dc-brand {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            white-space: nowrap;
        }

        /* Content Section */
        .dc-content-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        .dc-top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            height: 44px;
        }

        .dc-search-container {
            flex: 1;
            display: flex;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .dc-search {
            display: flex;
            align-items: center;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            gap: 0.5rem;
            width: 100%;
            max-width: 400px;
        }

        .dc-search input {
            background: none;
            border: none;
            outline: none;
            font-size: 0.875rem;
            color: #1f2937;
            flex: 1;
        }

        .dc-search input::placeholder {
            color: #9ca3af;
        }

        .dc-top-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dc-status-badges {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dc-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .dc-badge-yellow {
            background: #fef3c7;
            color: #92400e;
        }

        .dc-badge-green {
            background: #d1fae5;
            color: #065f46;
        }

        .dc-icons {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .dc-icon-btn {
            background: none;
            border: none;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .dc-icon-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .dc-user-avatar {
            background: #e5e7eb;
            border-radius: 50%;
        }

        /* Bottom Bar */
        .dc-bottom-bar {
            display: flex;
            align-items: center;
            padding: 0 1rem;
            height: 44px;
        }

        .dc-tabs {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            overflow-x: auto;
            flex: 1;
        }

        .dc-tab {
            background: none;
            border: none;
            padding: 0.5rem 0.875rem;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            height: 44px;
            position: relative;
        }

        .dc-tab:hover {
            color: #1f2937;
            background: #f9fafb;
        }

        .dc-tab-active {
            color: #0B3A5D;
            border-bottom-color: #0B3A5D;
            font-weight: 600;
        }

        /* Segment Builder Header */
        .app-header {
            background: #0B3A5D;
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }


        .segment-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .datacloud-icon {
            width: 20px;
            height: 20px;
        }

        .segment-icon {
            width: 24px;
            height: 24px;
        }

        .segment-name {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-icons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-icon-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .header-icon-btn svg {
            width: 20px;
            height: 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .audience-count {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .count-number {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .count-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .count-percentage {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: white;
            color: #0B3A5D;
        }

        .btn-secondary:hover {
            background: #f9fafb;
        }

        .btn-primary {
            background: #1d72f3;
            color: white;
        }

        .btn-primary:hover {
            background: #1557c7;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .tab-item {
            padding: 1rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }

        .tab-item:hover {
            color: #1f2937;
            background: #f9fafb;
        }

        .tab-item.active {
            color: #1d72f3;
            border-bottom-color: #1d72f3;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* Segments List Landing Page */
        .segments-list-page {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Hide all navigation buttons when segments list is showing */
        #segmentsListPage ~ * .nav-buttons,
        #segmentsListPage ~ * .btn-nav {
            display: none !important;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.875rem;
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 1.75rem;
            line-height: 1;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .create-button-container {
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
        }

        .btn-create-segment {
            background: linear-gradient(135deg, #1d72f3 0%, #1557b0 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(29, 114, 243, 0.3);
            transition: all 0.2s;
        }

        .btn-create-segment:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 114, 243, 0.4);
        }

        .segments-list-container {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .list-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .btn-view-all {
            background: none;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: #1d72f3;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-view-all:hover {
            background: #f9fafb;
            border-color: #1d72f3;
        }

        .segments-table {
            overflow-x: auto;
        }

        .segments-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .segments-table th {
            background: #f9fafb;
            padding: 0.875rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }

        .segments-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
            color: #374151;
        }

        .segments-table tbody tr {
            transition: background 0.15s;
        }

        .segments-table tbody tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }

        .btn-table-action {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .btn-table-action:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        /* Creation Modal */
        .creation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .modal-body {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .creation-option {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .creation-option:hover {
            border-color: #1d72f3;
            background: #f0f7ff;
            transform: translateX(4px);
        }

        .option-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.375rem;
        }

        .option-description {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.5;
        }

        .option-arrow {
            font-size: 1.5rem;
            color: #1d72f3;
            font-weight: 600;
        }

        /* Welcome State - Agentic Layout */
        .welcome-state {
            min-height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }

        .agent-main {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 1rem;
            padding: 2.5rem 3rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 2rem;
        }

        .agent-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .agent-avatar {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #1d72f3 0%, #1557b0 100%);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            box-shadow: 0 6px 16px rgba(29, 114, 243, 0.25);
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
            color: #1d72f3;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .welcome-subtitle {
            font-size: 1.0625rem;
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .goal-suggestions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.875rem;
            margin-bottom: 1.25rem;
        }

        .goal-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.625rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .goal-card:hover {
            border-color: #1d72f3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(29, 114, 243, 0.15);
        }

        .goal-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.625rem;
        }

        .goal-card-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.375rem;
        }

        .goal-card-description {
            font-size: 0.8125rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .divider-or {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }

        .divider-or::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: #e5e7eb;
        }

        .divider-or span {
            position: relative;
            background: white;
            padding: 0 1rem;
            font-size: 0.8125rem;
            color: #9ca3af;
            font-weight: 500;
        }

        .goal-input-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .goal-input-container:focus-within {
            border-color: #1d72f3;
        }

        .goal-input {
            flex: 1;
            padding: 0.875rem 1.125rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.625rem;
            outline: none;
            font-size: 0.9375rem;
            transition: all 0.2s;
        }

        .goal-input:focus {
            border-color: #1d72f3;
            box-shadow: 0 0 0 3px rgba(29, 114, 243, 0.1);
        }

        .goal-submit {
            padding: 0.875rem 1.75rem;
            background: #1d72f3;
            color: white;
            border: none;
            border-radius: 0.625rem;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .goal-submit:hover {
            background: #1557b0;
        }

        /* Conversation-style Follow-up */
        .followup-container {
            display: none;
            animation: fadeIn 0.3s ease-out;
            margin-top: 2rem;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 1rem;
        }

        .followup-container::-webkit-scrollbar {
            width: 8px;
        }

        .followup-container::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        .followup-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .followup-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Chat Messages Scrollbar */
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }

        #chatMessages::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        #chatMessages::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .chat-message {
            display: flex;
            gap: 0.875rem;
            margin-bottom: 1.5rem;
            animation: slideIn 0.4s ease-out;
        }

        .chat-message.user-message {
            justify-content: flex-end;
        }

        .chat-message.user-message .chat-bubble {
            background: #eff6ff;
            border-color: #1d72f3;
            margin-left: auto;
            max-width: 70%;
        }

        .chat-message.user-message .chat-bubble-text {
            color: #1d72f3;
            font-weight: 500;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1d72f3 0%, #1557b0 100%);
            border-radius: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(29, 114, 243, 0.2);
        }

        .chat-bubble {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.875rem;
            padding: 1.25rem 1.5rem;
            flex: 1;
        }

        .chat-bubble-text {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .chat-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .chat-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.625rem;
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.9375rem;
            color: #374151;
            font-weight: 500;
            white-space: nowrap;
            flex: 0 0 auto;
        }

        .chat-option:hover {
            border-color: #1d72f3;
            background: #eff6ff;
        }

        .chat-option.selected {
            border-color: #1d72f3;
            background: #eff6ff;
            color: #1d72f3;
            font-weight: 600;
        }

        .proceed-btn {
            width: 100%;
            padding: 1rem;
            background: #1d72f3;
            color: white;
            border: none;
            border-radius: 0.625rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1.5rem;
        }

        .proceed-btn:hover:not(:disabled) {
            background: #1557b0;
        }

        .proceed-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Strategy Selection Cards */
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            margin-top: 1.5rem;
        }

        .strategy-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .strategy-card:hover {
            border-color: #1d72f3;
            background: #eff6ff;
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(29, 114, 243, 0.15);
        }

        .strategy-icon {
            font-size: 2.5rem;
            margin-bottom: 0.875rem;
        }

        .strategy-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }

        .strategy-description {
            font-size: 0.9375rem;
            color: #374151;
            font-weight: 500;
            margin-bottom: 0.625rem;
            line-height: 1.5;
        }

        .strategy-details {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 500px;
            }
        }

        /* Global Agentic Command Bar */
        .global-agent-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: none; /* Hidden on landing page */
            animation: slideUpFade 0.4s ease-out;
        }

        .global-agent-bar.active {
            display: block;
        }

        .agent-command-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid #e5e7eb;
            border-radius: 2rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 600px;
            max-width: 700px;
            transition: all 0.3s ease;
        }

        .agent-command-container:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.16);
            border-color: #1d72f3;
        }

        .agent-bar-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #1d72f3 0%, #1557b0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .agent-command-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 0.9375rem;
            color: #1f2937;
            outline: none;
            font-weight: 500;
        }

        .agent-command-input::placeholder {
            color: #9ca3af;
        }

        .agent-status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(29, 114, 243, 0.08);
            border-radius: 1rem;
            font-size: 0.8125rem;
            color: #1d72f3;
            font-weight: 600;
        }

        .sparkle-icon {
            width: 16px;
            height: 16px;
            animation: sparkle 2s infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* Action Feedback Animation */
        @keyframes highlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(29, 114, 243, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(29, 114, 243, 0);
            }
        }

        .action-highlight {
            animation: highlightPulse 0.6s ease-out;
        }

        /* Agent Chat Expansion (expands from bottom bar) */
        .agent-chat-expansion {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10002;
            display: none;
            width: 700px;
            max-width: calc(100vw - 4rem);
        }

        .agent-chat-expansion.show {
            display: block;
            animation: expandUp 0.3s ease-out;
        }

        .agent-chat-expansion.collapsed {
            display: none;
        }

        .agent-chat-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 231, 235, 0.6);
            border-radius: 1.5rem 1.5rem 0 0;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .agent-chat-header-bar {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            padding: 0.625rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(229, 231, 235, 0.3);
        }

        .agent-chat-header-left {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .agent-typing-indicator {
            display: none;
            align-items: center;
            gap: 0.375rem;
        }

        .agent-typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #1d72f3;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .agent-chat-collapse-icon {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            border-radius: 0.25rem;
        }

        .agent-chat-collapse-icon:hover {
            color: #6b7280;
            background: rgba(156, 163, 175, 0.1);
        }

        .agent-chat-messages-container {
            padding: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.125rem;
        }

        .agent-chat-messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .agent-chat-messages-container::-webkit-scrollbar-track {
            background: rgba(243, 244, 246, 0.3);
            border-radius: 3px;
        }

        .agent-chat-messages-container::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.4);
            border-radius: 3px;
        }

        .agent-chat-message {
            display: flex;
            gap: 0.875rem;
            animation: slideIn 0.3s ease-out;
        }

        .agent-chat-message.user-msg {
            flex-direction: row-reverse;
        }

        .agent-msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .agent-msg-avatar.agent {
            background: linear-gradient(135deg, #1d72f3 0%, #1557b0 100%);
            box-shadow: 0 2px 8px rgba(29, 114, 243, 0.3);
        }

        .agent-msg-avatar.user {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #6b7280;
        }

        .agent-msg-bubble {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(229, 231, 235, 0.5);
            border-radius: 1rem;
            padding: 0.875rem 1.25rem;
            max-width: 480px;
            font-size: 0.9375rem;
            color: #1f2937;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .agent-chat-message.user-msg .agent-msg-bubble {
            background: rgba(239, 246, 255, 0.95);
            border-color: rgba(191, 219, 254, 0.6);
            color: #1e40af;
        }

        .agent-msg-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.625rem;
        }

        .agent-suggestion-chip {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(29, 114, 243, 0.3);
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #1d72f3;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .agent-suggestion-chip:hover {
            background: rgba(29, 114, 243, 0.1);
            border-color: #1d72f3;
            transform: translateY(-1px);
        }

        @keyframes expandUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }


        /* Stats Bottom Bar */
        .stats-sidebar {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .stat-mini {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }

        .stat-mini-icon {
            width: 32px;
            height: 32px;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
        }

        .stat-mini-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .stat-mini-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
            font-size: 1rem;
            color: #1f2937;
        }

        .goal-input::placeholder {
            color: #9ca3af;
        }

        .goal-submit {
            background: #1d72f3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .goal-submit:hover {
            background: #1557c7;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Header */
        .section-header {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .section-description {
            font-size: 1rem;
            color: #6b7280;
        }

        /* Segment Definition Cards */
        .filter-list {
            display: grid;
            grid-template-columns: 1fr 80px;
            gap: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .filters-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .and-column {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .filter-and-slab {
            background: #d1fae5;
            color: #065f46;
            font-size: 0.875rem;
            font-weight: 700;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }

        /* Excludes Section */
        .excludes-section {
            margin-top: 2rem;
            background: linear-gradient(to bottom, rgba(243, 244, 246, 0.5), rgba(249, 250, 251, 0.3));
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .excludes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .excludes-label {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #6b7280;
        }

        .add-exclusion-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.125rem;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-exclusion-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .excludes-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .exclude-card {
            background: white;
            border: 2px dashed #d1d5db;
            border-left: 4px solid #9ca3af;
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .exclude-card:hover {
            border-color: #9ca3af;
            box-shadow: 0 4px 12px rgba(156, 163, 175, 0.12);
        }

        .exclude-content {
            flex: 1;
        }

        .exclude-text {
            font-size: 0.9375rem;
            color: #6b7280;
            line-height: 1.6;
        }

        .exclude-text strong {
            color: #4b5563;
            font-weight: 600;
        }

        .exclude-actions {
            display: flex;
            gap: 0.5rem;
        }

        .filter-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            border-left: 4px solid #1d72f3;
            min-height: 60px;
            position: relative;
            perspective: 1000px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #1d72f3;
        }

        .filter-card.highlight {
            border-left-color: #fbbf24;
        }
        
        .filter-card.flipped .filter-card-inner {
            transform: rotateY(180deg);
        }
        
        .filter-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .filter-face {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        
        .filter-face-front {
            position: relative;
        }
        
        .filter-face-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
            background: #f9fafb;
        }

        /* Filter Type Badges */
        .filter-type-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 0.375rem;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-right: 0.625rem;
        }

        .badge-attribute {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .badge-filter {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #86efac;
        }

        .badge-metric {
            background: #fce7f3;
            color: #be185d;
            border: 1px solid #fbcfe8;
        }

        .badge-segment {
            background: #e0e7ff;
            color: #4338ca;
            border: 1px solid #a5b4fc;
        }

        .badge-score {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .filter-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .filter-text {
            font-size: 0.9375rem;
            color: #1f2937;
        }

        .filter-text strong {
            font-weight: 600;
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: none;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        /* Quick Filters Panel */
        /* Filter Builder Section */
        .filter-builder-section {
            margin-bottom: 2rem;
        }

        .filter-builder-trigger {
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f3ff 100%);
            border: 2px solid #1d72f3;
            border-radius: 0.5rem;
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(29, 114, 243, 0.15);
        }

        .filter-builder-trigger:hover {
            border-color: #1557b0;
            background: linear-gradient(135deg, #e8f3ff 0%, #daeeff 100%);
            box-shadow: 0 4px 12px rgba(29, 114, 243, 0.25);
        }

        .trigger-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .trigger-icon {
            width: 24px;
            height: 24px;
            color: #1d72f3;
        }

        .trigger-text {
            font-size: 1.0625rem;
            font-weight: 600;
            color: #1557b0;
        }

        .trigger-arrow {
            width: 20px;
            height: 20px;
            color: #1d72f3;
            transition: transform 0.3s;
        }

        .trigger-arrow.open {
            transform: rotate(180deg);
        }

        .filter-builder-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0;
            margin-top: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: none;
        }

        .filter-builder-panel.open {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .filter-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .filter-tab:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .filter-tab.active {
            background: white;
            color: #1d72f3;
            border-bottom-color: #1d72f3;
            font-weight: 600;
        }

        .filter-tab svg {
            width: 16px;
            height: 16px;
        }

        /* Filter Tab Content */
        .filter-tab-content {
            display: none;
            padding: 1.5rem;
        }

        .filter-tab-content.active {
            display: block;
        }

        .filter-panel-header {
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-panel-header h3 {
            font-size: 1.0625rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .filter-panel-header p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .filter-search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9375rem;
            color: #1f2937;
            outline: none;
            transition: all 0.2s;
        }

        .filter-search-input:focus {
            border-color: #1d72f3;
            box-shadow: 0 0 0 3px rgba(29,114,243,0.1);
        }

        .filter-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .filter-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filter-item:hover {
            background: #f0f7ff;
            border-color: #1d72f3;
            box-shadow: 0 2px 6px rgba(29, 114, 243, 0.15);
            transform: translateY(-1px);
        }

        .filter-icon {
            font-size: 1.75rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .filter-info {
            flex: 1;
        }

        .filter-name {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .filter-detail {
            font-size: 0.8125rem;
            color: #6b7280;
        }

        /* Keep old classes for compatibility */
        .quick-filter-item-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quick-filter-icon {
            font-size: 1.75rem;
            line-height: 1;
        }

        .quick-filter-info {
            flex: 1;
        }

        .quick-filter-name {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .quick-filter-detail {
            font-size: 0.8125rem;
            color: #6b7280;
        }

        .quick-filter-item:hover {
            background: #eff6ff;
            border-color: #1d72f3;
            box-shadow: 0 2px 4px rgba(29, 114, 243, 0.1);
        }

        .quick-filter-item-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quick-filter-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .quick-filter-info {
            flex: 1;
        }

        .quick-filter-name {
            font-size: 0.9375rem;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .quick-filter-detail {
            font-size: 0.8125rem;
            color: #6b7280;
        }

        /* Channel Affinity */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .channel-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.25rem 1.5rem;
        }

        .channel-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .channel-icon {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: #eff6ff;
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .channel-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: #1d72f3;
            color: white;
            margin-left: 0.5rem;
        }

        .channel-engagement {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .channel-bar-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .channel-bar {
            flex: 1;
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
        }

        .channel-bar-fill {
            height: 100%;
            background: #1d72f3;
            transition: width 0.6s ease-out;
        }

        .channel-percentage {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            min-width: 50px;
            text-align: right;
        }

        .channel-insight {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #1e40af;
        }

        .channel-source {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-left: 3px solid #1d72f3;
            border-radius: 0.375rem;
            padding: 0.875rem 1rem;
            margin-top: 1rem;
            font-size: 0.8125rem;
            color: #6b7280;
        }

        /* Smart Splits */
        .split-controls-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .split-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .split-controls-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .reset-link {
            font-size: 0.875rem;
            color: #1d72f3;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }

        .reset-link:hover {
            background: #eff6ff;
        }

        .split-slider-wrapper {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .split-display {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .split-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .split-emoji {
            font-size: 1.25rem;
        }

        .split-percentage-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            min-width: 60px;
        }

        .split-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #1d72f3 0%, #1d72f3 50%, #10b981 50%, #10b981 100%);
            outline: none;
            cursor: pointer;
        }

        .split-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid #1d72f3;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .split-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid #1d72f3;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .splits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .split-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .split-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .split-name-section {
            flex: 1;
        }

        .split-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .split-label {
            font-size: 0.8125rem;
            color: #6b7280;
        }

        .split-size {
            text-align: right;
        }

        .split-size-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .split-size-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
        }

        .split-offer {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .split-offer-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .split-offer-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .split-offer-channel {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .split-audience {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .split-audience-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .split-audience-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.375rem;
            background: #eff6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-change {
            font-size: 0.8125rem;
            color: #10b981;
            margin-top: 0.5rem;
        }

        .insights-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .insight-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .insight-card-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }

        .insight-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .insight-item {
            background: #f9fafb;
            border-left: 3px solid #1d72f3;
            border-radius: 0.25rem;
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            color: #1f2937;
        }

        .insight-item strong {
            font-weight: 600;
            color: #1d72f3;
        }

        /* Performance Cards */
        .performance-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .performance-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: #1f2937;
        }

        .performance-badge {
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
        }

        .performance-items {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .performance-item {
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 1rem;
        }

        .performance-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .performance-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .performance-name {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .performance-emoji {
            font-size: 1.5rem;
        }

        .performance-text {
            font-size: 0.9375rem;
            font-weight: 500;
            color: #1f2937;
        }

        .performance-result {
            text-align: right;
        }

        .performance-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .performance-delta {
            font-size: 0.8125rem;
            color: #10b981;
        }

        .performance-bar-bg {
            height: 10px;
            background: #f3f4f6;
            border-radius: 5px;
            overflow: hidden;
        }

        .performance-bar-fill {
            height: 100%;
            background: #1d72f3;
            transition: width 0.6s ease-out;
        }

        .winner-banner {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: #065f46;
        }

        .winner-banner strong {
            font-weight: 600;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .btn-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-nav-secondary {
            background: white;
            border: 1px solid #e5e7eb;
            color: #1f2937;
        }

        .btn-nav-secondary:hover {
            background: #f9fafb;
        }

        .btn-nav-primary {
            background: #1d72f3;
            border: none;
            color: white;
        }

        .btn-nav-primary:hover {
            background: #1557c7;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tab-navigation {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .quick-filters-grid {
                grid-template-columns: 1fr;
            }

            .splits-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .insights-section {
                grid-template-columns: 1fr;
            }
        }

        /* Validation Overlay Styles */
        .validation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }

        .validation-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease-out forwards;
        }

        .validation-overlay-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .validation-overlay-content {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .validation-overlay.active .validation-overlay-content {
            transform: translateX(0);
        }

        .validation-overlay-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(249,250,251,0.98) 100%);
            border-bottom: 2px solid #e5e7eb;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .validation-back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.125rem;
            background: linear-gradient(135deg, #1d72f3 0%, #1557b0 100%);
            border: none;
            border-radius: 0.625rem;
            color: white;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(29, 114, 243, 0.2);
        }

        .validation-back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(29, 114, 243, 0.3);
        }

        .validation-breadcrumb {
            display: flex;
            align-items: center;
            font-size: 0.9375rem;
            flex: 1;
            justify-content: center;
        }

        .validation-close-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .validation-close-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        .validation-overlay-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: #f9fafb;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <!-- Data Cloud Full Navigation (Only for Landing Page) -->
    <div id="dataCloudNav" class="datacloud-nav-wrapper">
        <!-- Logo Section (Spans Both Bars) -->
        <div class="dc-logo-section">
            <svg class="dc-cloud-icon" viewBox="0 0 24 24" fill="#0B3A5D">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
            <div class="dc-brand">Data Cloud</div>
        </div>

        <!-- Content Section (Two Bars) -->
        <div class="dc-content-section">
            <!-- Top Bar: Search and Icons -->
            <div class="dc-top-bar">
                <div class="dc-search-container">
                    <div class="dc-search">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text" placeholder="Search..." />
                    </div>
                </div>
                <div class="dc-top-right">
                    <div class="dc-status-badges">
                        <span class="dc-badge dc-badge-yellow">EPT: 0.31 s</span>
                        <span class="dc-badge dc-badge-green">ART: 0 s</span>
                        <span class="dc-badge dc-badge-green">8802.97 KB</span>
                    </div>
                    <div class="dc-icons">
                        <button class="dc-icon-btn" title="Setup">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v6m0 6v6M1 12h6m6 0h6"/>
                            </svg>
                        </button>
                        <button class="dc-icon-btn" title="Help">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </button>
                        <button class="dc-icon-btn" title="Settings">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </button>
                        <button class="dc-icon-btn" title="Notifications">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                        </button>
                        <button class="dc-icon-btn dc-user-avatar" title="User">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Bar: Tabs -->
            <div class="dc-bottom-bar">
                <div class="dc-tabs">
                    <button class="dc-tab">Home</button>
                    <button class="dc-tab">Data Streams</button>
                    <button class="dc-tab">Data Model</button>
                    <button class="dc-tab">Identity Resolutions</button>
                    <button class="dc-tab">Data Explorer</button>
                    <button class="dc-tab">Calculated Insights</button>
                    <button class="dc-tab dc-tab-active">Segments</button>
                    <button class="dc-tab">Activation Targets</button>
                    <button class="dc-tab">Activations</button>
                    <button class="dc-tab">More</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Segment Builder Header (Hidden on Landing Page) -->
    <div class="app-header" style="display: none;">
        <div class="header-left">
            <div class="segment-title">
                <svg class="segment-icon" viewBox="0 0 24 24" fill="white" stroke="none" style="width: 24px; height: 24px;">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                <span class="segment-name" id="segmentName">Data Cloud Segment Builder</span>
            </div>
        </div>
        <div class="header-right">
            <div class="header-icons">
                <button class="header-icon-btn" title="Search">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                </button>
                <button class="header-icon-btn" title="Recent Activity">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </button>
                <button class="header-icon-btn" title="Notifications">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </button>
                <button class="header-icon-btn" title="Data Sources">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <ellipse cx="12" cy="5" rx="9" ry="3"/>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </svg>
                </button>
                <button class="header-icon-btn" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                    </svg>
                </button>
                <button class="header-icon-btn" title="Help & Support">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </button>
                <button class="header-icon-btn" title="User Profile">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Segment Toolbar -->
    <div id="segmentToolbar" style="background: white; border-bottom: 1px solid #e5e7eb; padding: 1rem 1.5rem; display: none; align-items: center; justify-content: space-between;">
        <!-- Left Side: Population Metrics -->
        <div style="display: flex; align-items: center; gap: 1.5rem;">
            <!-- Action Buttons -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button style="width: 36px; height: 36px; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'" title="Undo">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6"/>
                        <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
                    </svg>
                </button>
                <button style="width: 36px; height: 36px; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'" title="Redo">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6"/>
                        <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"/>
                    </svg>
                </button>
            </div>

            <!-- Population Count -->
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button style="width: 36px; height: 36px; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'" title="Refresh">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0118.8-4.3M22 12.5a10 10 0 01-18.8 4.2"/>
                    </svg>
                </button>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="font-size: 1.75rem; font-weight: 700; color: #1f2937;" id="toolbarAudienceCount">12,487</div>
                    <div style="font-size: 0.9375rem; color: #6b7280;">Unified Individuals</div>
                </div>
            </div>

            <!-- Percentage Badge -->
            <div style="display: flex; align-items: center; gap: 0.5rem; background: #eff6ff; padding: 0.5rem 1rem; border-radius: 0.375rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#3b82f6">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span style="font-size: 0.9375rem; color: #1e40af; font-weight: 500;">0.4% of 3,286,468 total population</span>
            </div>
        </div>

        <!-- Right Side: Action Buttons -->
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <button style="padding: 0.5rem 1.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; color: #374151; font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                Edit Properties
            </button>
            <button style="padding: 0.5rem 1.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; color: #374151; font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'" onclick="alert('Closing segment builder...')">
                Close
            </button>
            <button style="padding: 0.5rem 1.25rem; border: none; border-radius: 0.375rem; background: #1d72f3; color: white; font-size: 0.9375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" onmouseover="this.style.background='#1557b0'" onmouseout="this.style.background='#1d72f3'" onclick="alert('Segment saved successfully!')">
                Save
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div id="tabNavigation" class="tab-navigation" style="display: none;">
        <button class="tab-item" onclick="switchTab(0)" id="tab0">Segment Definition</button>
        <button class="tab-item" onclick="switchTab(1)" id="tab1">
            Rank and Limit
            <span style="margin-left: 0.375rem; padding: 0.125rem 0.5rem; background: #fef3c7; color: #92400e; font-size: 0.6875rem; border-radius: 0.25rem; font-weight: 600;">OPTIONAL</span>
        </button>
        <button class="tab-item" onclick="switchTab(2)" id="tab2">
            Channel Affinity
            <span style="margin-left: 0.375rem; padding: 0.125rem 0.5rem; background: #fef3c7; color: #92400e; font-size: 0.6875rem; border-radius: 0.25rem; font-weight: 600;">OPTIONAL</span>
        </button>
        <button class="tab-item" onclick="switchTab(3)" id="tab3">
            Smart Splits
            <span style="margin-left: 0.375rem; padding: 0.125rem 0.5rem; background: #fef3c7; color: #92400e; font-size: 0.6875rem; border-radius: 0.25rem; font-weight: 600;">OPTIONAL</span>
        </button>
        <button class="tab-item" onclick="switchTab(4)" id="tab4">Activate</button>
        <button class="tab-item" onclick="switchTab(5)" id="tab5">Segment Performance</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Segments List Landing Page -->
        <div id="segmentsListPage" class="segments-list-page">
            <!-- Stats Panel -->
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-content">
                        <div class="stat-value">248</div>
                        <div class="stat-label">Total Segments</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-content">
                        <div class="stat-value">186</div>
                        <div class="stat-label">Published</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-content">
                        <div class="stat-value">62</div>
                        <div class="stat-label">Draft</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-content">
                        <div class="stat-value">125K</div>
                        <div class="stat-label">Avg Audience</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-content">
                        <div class="stat-value">18</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"></div>
                    <div class="stat-content">
                        <div class="stat-value">42</div>
                        <div class="stat-label">Active Now</div>
                    </div>
                </div>
            </div>

            <!-- Create Button Container -->
            <div class="create-button-container">
                <button class="btn-create-segment" onclick="showCreationModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    Create New Segment
                </button>
            </div>

            <!-- Segments List -->
            <div class="segments-list-container">
                <div class="list-header">
                    <h2>Recently Viewed</h2>
                    <button class="btn-view-all" onclick="alert('View All functionality')">View All (248)</button>
                </div>

                <div class="segments-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 3%;">#</th>
                                <th style="width: 25%;">Segment Name</th>
                                <th style="width: 12%;">Data Space</th>
                                <th style="width: 10%;">Type</th>
                                <th style="width: 10%;">Status</th>
                                <th style="width: 10%;">Size</th>
                                <th style="width: 12%;">Last Modified</th>
                                <th style="width: 10%;">Modified By</th>
                                <th style="width: 8%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><strong>High Value Outdoor Enthusiasts</strong></td>
                                <td>Default</td>
                                <td>Standard</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>45.7K</td>
                                <td>2 hours ago</td>
                                <td>sking</td>
                                <td><button class="btn-table-action"></button></td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td><strong>Churn Risk Segment</strong></td>
                                <td>Default</td>
                                <td>Standard</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>12.3K</td>
                                <td>1 day ago</td>
                                <td>mileb</td>
                                <td><button class="btn-table-action"></button></td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td><strong>Email Engagement Outreach</strong></td>
                                <td>Default</td>
                                <td>Standard</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>89.2K</td>
                                <td>2 days ago</td>
                                <td>sking</td>
                                <td><button class="btn-table-action"></button></td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td><strong>Draft Win-back Segment</strong></td>
                                <td>Default</td>
                                <td>Standard</td>
                                <td><span class="status-badge status-draft">Draft</span></td>
                                <td>0</td>
                                <td>3 days ago</td>
                                <td>BWrig</td>
                                <td><button class="btn-table-action"></button></td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td><strong>Top Spenders Q4</strong></td>
                                <td>Default</td>
                                <td>Standard</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>5.4K</td>
                                <td>5 days ago</td>
                                <td>mileb</td>
                                <td><button class="btn-table-action"></button></td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td><strong>Loyalty Tier Gold Members</strong></td>
                                <td>Default</td>
                                <td>Standard</td>
                                <td><span class="status-badge status-active">Active</span></td>
                                <td>28.9K</td>
                                <td>1 week ago</td>
                                <td>sking</td>
                                <td><button class="btn-table-action"></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Creation Modal Overlay -->
        <div id="creationModal" class="creation-modal" style="display: none;">
            <div class="modal-backdrop" onclick="closeCreationModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Segment</h2>
                    <button class="modal-close" onclick="closeCreationModal()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <button class="creation-option" onclick="startWithAgent()">
                        <div class="option-icon"></div>
                        <div class="option-content">
                            <div class="option-title">Guide Me with AI Assistant</div>
                            <div class="option-description">Let me ask you a few questions to build the perfect segment</div>
                        </div>
                        <div class="option-arrow"></div>
                    </button>

                    <button class="creation-option" onclick="startManualBuilder()">
                        <div class="option-icon"></div>
                        <div class="option-content">
                            <div class="option-title">I'll Build It Manually</div>
                            <div class="option-description">Take me to the empty segment builder</div>
                        </div>
                        <div class="option-arrow"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Welcome State -->
        <div id="welcomeState" class="welcome-state" style="display: none;">
            <!-- Main Agent Container -->
            <div class="agent-main">
                <div class="agent-header">
                    <div class="agent-avatar">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                    </div>
                    <h1 class="welcome-title">What's your goal for today?</h1>
                    <p class="welcome-subtitle">Select a common goal or describe your own</p>
                </div>

                <!-- Follow-up Questions View - Conversation with Chat Input (AT TOP) -->
                <div id="followupView" class="followup-container">
                    <!-- Dynamic Questions Container -->
                    <div id="dynamicQuestion" style="display: none;">
                        <!-- Questions will be dynamically inserted here -->
                    </div>

                    <!-- Strategies Container -->
                    <div id="strategiesContainer" style="display: none;">
                        <!-- Strategies will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Goal Selection View (AT BOTTOM) -->
                <div id="goalSelectionView">
                    <!-- Custom Goal Input First -->
                    <div class="goal-input-container" style="margin-bottom: 1.5rem;">
                        <input type="text" class="goal-input" id="customGoalInput" placeholder="Describe your goal (e.g., Target outdoor enthusiasts in cold climates)">
                        <button type="button" class="goal-submit" onclick="startWithCustomGoal()">Continue</button>
                    </div>

                    <div class="divider-or">
                        <span>OR SELECT A COMMON GOAL</span>
                    </div>

                    <!-- Auto-suggested Goals Below -->
                    <div class="goal-suggestions">
                        <div class="goal-card" onclick="selectGoal('Win-back')">
                            <div class="goal-card-icon" style="background: #fef3c7;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                                    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
                                </svg>
                            </div>
                            <div class="goal-card-title">Win-back</div>
                            <div class="goal-card-description">Win back recently churned customers</div>
                        </div>

                        <div class="goal-card" onclick="selectGoal('Growth & Monetization')">
                            <div class="goal-card-icon" style="background: #fae8ff;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2">
                                    <line x1="12" y1="19" x2="12" y2="5"/>
                                    <polyline points="5 12 12 5 19 12"/>
                                </svg>
                            </div>
                            <div class="goal-card-title">Growth & Monetization</div>
                            <div class="goal-card-description">Increase share of wallet from existing customers</div>
                        </div>

                        <div class="goal-card" onclick="selectGoal('Acquisition')">
                            <div class="goal-card-icon" style="background: #f0fdf4;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="8.5" cy="7" r="4"/>
                                    <line x1="20" y1="8" x2="20" y2="14"/>
                                    <line x1="23" y1="11" x2="17" y2="11"/>
                                </svg>
                            </div>
                            <div class="goal-card-title">Acquisition</div>
                            <div class="goal-card-description">Find prospects similar to my best customers</div>
                        </div>

                        <div class="goal-card" onclick="selectGoal('Service Led Marketing')">
                            <div class="goal-card-icon" style="background: #dbeafe;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                                </svg>
                            </div>
                            <div class="goal-card-title">Service Led Marketing</div>
                            <div class="goal-card-description">Proactively engage customers frustrated with recent cases</div>
                        </div>

                        <div class="goal-card" onclick="selectGoal('Churn Prevention')">
                            <div class="goal-card-icon" style="background: #fee2e2;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 8v4l3 3"/>
                                </svg>
                            </div>
                            <div class="goal-card-title">Churn Prevention</div>
                            <div class="goal-card-description">Target at-risk customers with retention offers</div>
                        </div>

                        <div class="goal-card" onclick="selectGoal('Cross-sell & Upsell')">
                            <div class="goal-card-icon" style="background: #ede9fe;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2">
                                    <polyline points="18 15 12 9 6 15"/>
                                </svg>
                            </div>
                            <div class="goal-card-title">Cross-sell & Upsell</div>
                            <div class="goal-card-description">Drive additional revenue with product recommendations</div>
                        </div>
                    </div>

                    <!-- AI-Recommended Segments Section -->
                    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div>
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #111827; margin: 0 0 0.25rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                                    </svg>
                                    AI-Recommended Segments
                                </h3>
                                <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Based on your data, insights from past segments, and performance trends</p>
                            </div>
                            <span style="padding: 0.375rem 0.75rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.375rem;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                Ready to Use
                            </span>
                        </div>

                        <!-- Recommended Segments Grid -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <!-- Segment Card 1 -->
                            <div onclick="useRecommendedSegment('High-Value At-Risk Customers')" style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='#1d72f3'; this.style.boxShadow='0 8px 20px rgba(29, 114, 243, 0.15)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 0.375rem; font-size: 0.6875rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                    </svg>
                                    High Impact
                                </div>
                                <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 0.75rem;">
                                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 0.5rem; flex-shrink: 0;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                            <line x1="12" y1="9" x2="12" y2="13"/>
                                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                                        </svg>
                                    </div>
                                    <div style="flex: 1;">
                                        <h4 style="font-size: 0.9375rem; font-weight: 600; color: #111827; margin: 0 0 0.375rem 0;">High-Value At-Risk Customers</h4>
                                        <p style="font-size: 0.8125rem; color: #6b7280; margin: 0; line-height: 1.4;">LTV >$2,500 but declining engagement by 40% in last 30 days</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                                    <div style="display: flex; gap: 1rem;">
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Estimated Size</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #111827;">1,847</div>
                                        </div>
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Potential Value</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #059669;">$4.6M</div>
                                        </div>
                                    </div>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Segment Card 2 -->
                            <div onclick="useRecommendedSegment('Winter Campaign - Cold Climate Enthusiasts')" style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='#1d72f3'; this.style.boxShadow='0 8px 20px rgba(29, 114, 243, 0.15)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem 0.5rem; background: #e0f2fe; color: #075985; border-radius: 0.375rem; font-size: 0.6875rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 6v6l4 2"/>
                                    </svg>
                                    Trending
                                </div>
                                <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 0.75rem;">
                                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 0.5rem; flex-shrink: 0;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                            <path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/>
                                            <path d="M9 22V12h6v10M2 10.6L12 2l10 8.6"/>
                                        </svg>
                                    </div>
                                    <div style="flex: 1;">
                                        <h4 style="font-size: 0.9375rem; font-weight: 600; color: #111827; margin: 0 0 0.375rem 0;">Winter Campaign - Cold Climate</h4>
                                        <p style="font-size: 0.8125rem; color: #6b7280; margin: 0; line-height: 1.4;">Outdoor enthusiasts in regions with winter sports activity + recent browsing</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                                    <div style="display: flex; gap: 1rem;">
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Estimated Size</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #111827;">12,453</div>
                                        </div>
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Conv. Rate</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #059669;">18.4%</div>
                                        </div>
                                    </div>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Segment Card 3 -->
                            <div onclick="useRecommendedSegment('Repeat Buyers - Loyalty Upgrade Opportunity')" style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='#1d72f3'; this.style.boxShadow='0 8px 20px rgba(29, 114, 243, 0.15)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem 0.5rem; background: #f0fdf4; color: #065f46; border-radius: 0.375rem; font-size: 0.6875rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <polyline points="5 12 12 5 19 12"/>
                                    </svg>
                                    High ROI
                                </div>
                                <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 0.75rem;">
                                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #fae8ff 0%, #f3e8ff 100%); border-radius: 0.5rem; flex-shrink: 0;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                            <circle cx="12" cy="7" r="4"/>
                                            <path d="M22 11v6"/>
                                            <path d="M19 14h6"/>
                                        </svg>
                                    </div>
                                    <div style="flex: 1;">
                                        <h4 style="font-size: 0.9375rem; font-weight: 600; color: #111827; margin: 0 0 0.375rem 0;">Loyalty Upgrade Opportunity</h4>
                                        <p style="font-size: 0.8125rem; color: #6b7280; margin: 0; line-height: 1.4;">3+ purchases, $500+ spent, not in loyalty program yet</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                                    <div style="display: flex; gap: 1rem;">
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Estimated Size</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #111827;">5,329</div>
                                        </div>
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Avg LTV Lift</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #059669;">+45%</div>
                                        </div>
                                    </div>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Segment Card 4 -->
                            <div onclick="useRecommendedSegment('Email Re-Engagement - Inactive 90 Days')" style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.25rem; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.borderColor='#1d72f3'; this.style.boxShadow='0 8px 20px rgba(29, 114, 243, 0.15)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="position: absolute; top: 0.75rem; right: 0.75rem; padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 0.375rem; font-size: 0.6875rem; font-weight: 600;">
                                    Similar +22% open
                                </div>
                                <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 0.75rem;">
                                    <div style="padding: 0.75rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 0.5rem; flex-shrink: 0;">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                            <polyline points="22,6 12,13 2,6"/>
                                        </svg>
                                    </div>
                                    <div style="flex: 1;">
                                        <h4 style="font-size: 0.9375rem; font-weight: 600; color: #111827; margin: 0 0 0.375rem 0;">Email Re-Engagement</h4>
                                        <p style="font-size: 0.8125rem; color: #6b7280; margin: 0; line-height: 1.4;">Previously engaged, no opens/clicks in 90 days, high past conversion</p>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 0.75rem; border-top: 1px solid #f3f4f6;">
                                    <div style="display: flex; gap: 1rem;">
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Estimated Size</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #111827;">8,942</div>
                                        </div>
                                        <div style="text-align: left;">
                                            <div style="font-size: 0.6875rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.125rem;">Win-back Rate</div>
                                            <div style="font-size: 0.9375rem; font-weight: 700; color: #059669;">12.8%</div>
                                        </div>
                                    </div>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; padding: 0.75rem; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                            <p style="font-size: 0.8125rem; color: #6b7280; margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="16" x2="12" y2="12"/>
                                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                                </svg>
                                These segments are generated based on your data patterns, historical segment performance, and current business trends
                            </p>
                        </div>
                    </div>

                    <!-- Manual Segment Builder Option -->
                    <div class="divider-or" style="margin-top: 2rem;">
                        <span>OR BUILD MANUALLY</span>
                    </div>

                    <div style="margin-top: 1.5rem; text-align: center; margin-bottom: 2rem;">
                        <button onclick="goToManualBuilder()" style="padding: 1rem 2rem; background: linear-gradient(135deg, #374151 0%, #1f2937 100%); color: white; border: none; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.75rem; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M12 2v6m0 0v6m0-6h6m-6 0H6"/>
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                            </svg>
                            Manual Segment Builder
                        </button>
                        <p style="margin-top: 0.75rem; font-size: 0.875rem; color: #6b7280;">Skip AI assistance and build your segment with custom rules and filters</p>
                    </div>
                </div>
            </div>

            <!-- Stats Sidebar -->
            <div class="stats-sidebar">
                <div class="stat-mini">
                    <div class="stat-mini-icon" style="background: #eff6ff;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="stat-mini-value">3.2M</div>
                    <div class="stat-mini-label">Profiles</div>
                </div>

                <div class="stat-mini">
                    <div class="stat-mini-icon" style="background: #fef3c7;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                            <ellipse cx="12" cy="5" rx="9" ry="3"/>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                        </svg>
                    </div>
                    <div class="stat-mini-value">12</div>
                    <div class="stat-mini-label">Sources</div>
                </div>

                <div class="stat-mini">
                    <div class="stat-mini-icon" style="background: #f0fdf4;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6"/>
                        </svg>
                    </div>
                    <div class="stat-mini-value">847</div>
                    <div class="stat-mini-label">Segments</div>
                </div>

                <div class="stat-mini">
                    <div class="stat-mini-icon" style="background: #fae8ff;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                    </div>
                    <div class="stat-mini-value">400</div>
                    <div class="stat-mini-label">Activations</div>
                </div>
            </div>
        </div>

        <!-- Tab 0: Segment Definition -->
        <div id="tabContent0" class="tab-content">
            <div class="section-header">
                <h2 class="section-title" id="segmentTitle">High Value Outdoor Enthusiasts</h2>
                <p class="section-description" id="segmentDescription">Our most engaged outdoor enthusiasts who have a high history of premium purchases but haven't geared up recently</p>
            </div>

            <!-- Validation Buttons Bar -->
            <div style="background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(249,250,251,0.95) 100%); backdrop-filter: blur(10px); border: 2px solid #e5e7eb; border-radius: 0.875rem; padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <div style="font-size: 0.9375rem; font-weight: 700; color: #1f2937;">Validate Your Segment</div>
                            <div style="font-size: 0.8125rem; color: #6b7280; margin-top: 0.125rem;">Quick checks to refine your rules before proceeding</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="openValidationOverlay('preview')" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #93c5fd; border-radius: 0.625rem; color: #1d4ed8; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(29,114,243,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            Preview Sample
                        </button>
                        <button onclick="openValidationOverlay('insights')" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #86efac; border-radius: 0.625rem; color: #15803d; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="20" x2="12" y2="10"/>
                                <line x1="18" y1="20" x2="18" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="16"/>
                            </svg>
                            View Insights
                        </button>
                        <button onclick="openValidationOverlay('overlap')" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #fcd34d; border-radius: 0.625rem; color: #92400e; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245,158,11,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                            Check Overlap
                        </button>
                    </div>
                </div>
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span style="font-size: 1rem; font-weight: 600; color: #059669;">Includes</span>
                <span style="font-size: 0.875rem; color: #6b7280; margin-left: 0.25rem;">Criteria to match</span>
            </div>

            <div class="filter-list" id="filterList">
                <div class="filters-column" id="filtersColumn">
                    <div class="filter-card" id="filter1" onclick="toggleFilterView('filter1', event)">
                        <div class="filter-card-inner">
                            <!-- Front Face: Natural Language -->
                            <div class="filter-face filter-face-front">
                                <div class="filter-content">
                                    <span class="filter-text">These are our biggest spenders who've hit the $7k spend milestone</span>
                                </div>
                                <div class="filter-actions">
                                    <button class="icon-btn" onclick="removeFilter('filter1'); event.stopPropagation();">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                        </svg>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                        <span style="font-size: 0.6875rem; color: #6b7280;">Click for formula</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                            <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <!-- Back Face: Technical Formula -->
                            <div class="filter-face filter-face-back">
                                <div class="filter-content">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                        <span class="filter-label" style="padding: 0.25rem 0.625rem; background: #dbeafe; color: #1e40af; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">Lifetime Value</span>
                                        <span class="filter-operator" style="font-size: 0.875rem; color: #6b7280;">is equal to or greater than</span>
                                        <span class="filter-value" style="padding: 0.25rem 0.625rem; background: #fef3c7; color: #92400e; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">USD 7,000</span>
                                    </div>
                                </div>
                                <div class="filter-actions">
                                    <button class="icon-btn" onclick="removeFilter('filter1'); event.stopPropagation();">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                        </svg>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                        <span style="font-size: 0.6875rem; color: #6b7280;">Click to flip back</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                            <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-card highlight" id="filter2" onclick="toggleFilterView('filter2', event)" style="border-left: 4px solid #f59e0b;">
                        <div class="filter-card-inner">
                            <!-- Front Face: Natural Language -->
                            <div class="filter-face filter-face-front">
                                <div class="filter-content">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.375rem;">
                                        <span style="padding: 0.125rem 0.5rem; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border-radius: 0.25rem; font-size: 0.625rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.25rem;">
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                            </svg>
                                            Group
                                        </span>
                                        <span style="font-size: 0.6875rem; color: #9ca3af;">4 conditions</span>
                                    </div>
                                    <span class="filter-text">Outdoor trekking enthusiasts with active interest in adventure gear</span>
                                </div>
                                <div class="filter-actions">
                                    <button class="icon-btn" onclick="removeFilter('filter2'); event.stopPropagation();">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                        </svg>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                        <span style="font-size: 0.6875rem; color: #6b7280;">Click for formula</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                            <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <!-- Back Face: Technical Formula with Multiple Conditions -->
                            <div class="filter-face filter-face-back">
                                <div class="filter-content" style="flex-direction: column; align-items: flex-start; gap: 0.5rem; width: 100%;">
                                    <!-- Group Header -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding-bottom: 0.5rem; border-bottom: 2px solid #fbbf24;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5">
                                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                            </svg>
                                            <span style="font-size: 0.75rem; font-weight: 700; color: #92400e; text-transform: uppercase; letter-spacing: 0.05em;">Grouped Filter</span>
                                        </div>
                                        <span style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 0.25rem; font-size: 0.625rem; font-weight: 700;">Match ANY condition</span>
                                    </div>
                                    
                                    <!-- Condition 1 -->
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #fffbeb; border-left: 3px solid #fbbf24; border-radius: 0.375rem; width: 100%;">
                                        <span style="font-size: 0.6875rem; font-weight: 600; color: #78350f; min-width: 18px;">1.</span>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                            <span class="filter-label" style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 0.25rem; font-size: 0.6875rem; font-weight: 600;">Product Interest</span>
                                            <span style="font-size: 0.75rem; color: #6b7280;">includes</span>
                                            <span class="filter-value" style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Trekking Boots</span>
                                        </div>
                                    </div>
                                    
                                    <!-- OR Connector -->
                                    <div style="text-align: center; width: 100%; margin: -0.125rem 0;">
                                        <span style="padding: 0.125rem 0.75rem; background: #f59e0b; color: white; border-radius: 1rem; font-size: 0.625rem; font-weight: 700; letter-spacing: 0.05em;">OR</span>
                                    </div>
                                    
                                    <!-- Condition 2 -->
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #fffbeb; border-left: 3px solid #fbbf24; border-radius: 0.375rem; width: 100%;">
                                        <span style="font-size: 0.6875rem; font-weight: 600; color: #78350f; min-width: 18px;">2.</span>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                            <span class="filter-label" style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 0.25rem; font-size: 0.6875rem; font-weight: 600;">Past Purchases</span>
                                            <span style="font-size: 0.75rem; color: #6b7280;">includes any</span>
                                            <span class="filter-value" style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Camping Gear, Skiing Equipment</span>
                                        </div>
                                    </div>
                                    
                                    <!-- OR Connector -->
                                    <div style="text-align: center; width: 100%; margin: -0.125rem 0;">
                                        <span style="padding: 0.125rem 0.75rem; background: #f59e0b; color: white; border-radius: 1rem; font-size: 0.625rem; font-weight: 700; letter-spacing: 0.05em;">OR</span>
                                    </div>
                                    
                                    <!-- Condition 3 -->
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #fffbeb; border-left: 3px solid #fbbf24; border-radius: 0.375rem; width: 100%;">
                                        <span style="font-size: 0.6875rem; font-weight: 600; color: #78350f; min-width: 18px;">3.</span>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                            <span class="filter-label" style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 0.25rem; font-size: 0.6875rem; font-weight: 600;">Magazine Subscription</span>
                                            <span style="font-size: 0.75rem; color: #6b7280;">is equal to</span>
                                            <span class="filter-value" style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Outdoor Adventure Magazine</span>
                                        </div>
                                    </div>
                                    
                                    <!-- OR Connector -->
                                    <div style="text-align: center; width: 100%; margin: -0.125rem 0;">
                                        <span style="padding: 0.125rem 0.75rem; background: #f59e0b; color: white; border-radius: 1rem; font-size: 0.625rem; font-weight: 700; letter-spacing: 0.05em;">OR</span>
                                    </div>
                                    
                                    <!-- Condition 4 -->
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #fffbeb; border-left: 3px solid #fbbf24; border-radius: 0.375rem; width: 100%;">
                                        <span style="font-size: 0.6875rem; font-weight: 600; color: #78350f; min-width: 18px;">4.</span>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                            <span class="filter-label" style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 0.25rem; font-size: 0.6875rem; font-weight: 600;">Web Activity</span>
                                            <span style="font-size: 0.75rem; color: #6b7280;">viewed categories</span>
                                            <span class="filter-value" style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Outdoor Equipment (last 30 days)</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-actions">
                                    <button class="icon-btn" onclick="removeFilter('filter2'); event.stopPropagation();">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                        </svg>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                        <span style="font-size: 0.6875rem; color: #6b7280;">Click to flip back</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                            <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-card" id="filter3" onclick="toggleFilterView('filter3', event)">
                        <div class="filter-card-inner">
                            <!-- Front Face: Natural Language -->
                            <div class="filter-face filter-face-front">
                                <div class="filter-content">
                                    <span class="filter-text">Customers we haven't seen in over six months</span>
                                </div>
                                <div class="filter-actions">
                                    <button class="icon-btn" onclick="removeFilter('filter3'); event.stopPropagation();">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                        </svg>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                        <span style="font-size: 0.6875rem; color: #6b7280;">Click for formula</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                            <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <!-- Back Face: Technical Formula -->
                            <div class="filter-face filter-face-back">
                                <div class="filter-content">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                        <span class="filter-label" style="padding: 0.25rem 0.625rem; background: #dbeafe; color: #1e40af; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">Last Activity</span>
                                        <span class="filter-operator" style="font-size: 0.875rem; color: #6b7280;">is more than</span>
                                        <span class="filter-value" style="padding: 0.25rem 0.625rem; background: #fef3c7; color: #92400e; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">180 Days ago</span>
                                    </div>
                                </div>
                                <div class="filter-actions">
                                    <button class="icon-btn" onclick="removeFilter('filter3'); event.stopPropagation();">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                        </svg>
                                    </button>
                                    <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                        <span style="font-size: 0.6875rem; color: #6b7280;">Click to flip back</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                            <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State Placeholder -->
                    <div id="emptyStateFilters" style="display: none; text-align: center; padding: 3rem 2rem; color: #9ca3af;">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1rem; opacity: 0.4;">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                        </svg>
                        <div style="font-size: 1.125rem; font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">No filters added yet</div>
                        <div style="font-size: 0.9375rem; color: #9ca3af;">Click "Add Rules & Filters" below to start building your segment</div>
                    </div>
                </div>

                <div class="and-column" id="andColumn">
                    <div class="filter-and-slab">AND</div>
                </div>
            </div>

            <!-- Filter Builder Section -->
            <div class="filter-builder-section">
                <div class="filter-builder-trigger" onclick="toggleFilterBuilder()">
                    <div class="trigger-content">
                        <svg class="trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        <span class="trigger-text">Add Rules & Filters to Build Segment</span>
                    </div>
                    <svg class="trigger-arrow" id="filterBuilderArrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                
                <div class="filter-builder-panel" id="filterBuilderPanel">
                    <!-- Tabs Navigation -->
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="switchFilterTab('attributes')" id="tab-attributes">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Quick Attributes
                        </button>
                        <button class="filter-tab" onclick="switchFilterTab('filters')" id="tab-filters">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                            </svg>
                            Quick Filters
                        </button>
                        <button class="filter-tab" onclick="switchFilterTab('metrics')" id="tab-metrics">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                            Metrics
                        </button>
                        <button class="filter-tab" onclick="switchFilterTab('scores')" id="tab-scores">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Predictive Scores
                        </button>
                        <button class="filter-tab" onclick="switchFilterTab('segments')" id="tab-segments">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                            Other Segments
                        </button>
                    </div>

                    <!-- Tab Panels -->
                    <div class="filter-tab-content active" id="content-attributes">
                        <div class="filter-panel-header">
                            <h3>Quick Attributes</h3>
                            <p>Select data model attributes to create custom filter rules</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" placeholder="Search attributes..." class="filter-search-input">
                        </div>
                        <div class="filter-items-grid">
                            <!-- Attributes List -->
                            <div class="filter-item" onclick="addQuickFilter('Age', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Age</div>
                                    <div class="filter-detail">Numeric  Customer attribute</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Location', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Location</div>
                                    <div class="filter-detail">Text  Geographic attribute</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Gender', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Gender</div>
                                    <div class="filter-detail">Select  Demographic attribute</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Email Status', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Email Status</div>
                                    <div class="filter-detail">Select  Communication attribute</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Last Purchase Date', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Last Purchase Date</div>
                                    <div class="filter-detail">Date  Transaction attribute</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Device Type', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Device Type</div>
                                    <div class="filter-detail">Select  Behavior attribute</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Income Level', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Income Level</div>
                                    <div class="filter-detail">Numeric  Financial attribute</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Language Preference', '', exclusionMode, 'attribute')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Language Preference</div>
                                    <div class="filter-detail">Select  Preference attribute</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Filters Tab -->
                    <div class="filter-tab-content" id="content-filters">
                        <div class="filter-panel-header">
                            <h3>Quick Filters</h3>
                            <p>Pre-configured filters with attribute values already set</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" placeholder="Search filters..." class="filter-search-input">
                        </div>
                        <div class="filter-items-grid">
                            <div class="filter-item" onclick="addQuickFilter('Millennials: Age 25-40', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Millennials (Age 25-40)</div>
                                    <div class="filter-detail">Age between 25 and 40</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Region: Pacific Northwest', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">PNW Residents</div>
                                    <div class="filter-detail">WA, OR, ID states</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Total Spend: > $5,000', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Spenders</div>
                                    <div class="filter-detail">Total spend > $5,000</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Device: Mobile', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Mobile Only Users</div>
                                    <div class="filter-detail">Primary device = Mobile</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Email Opens: Last 30 days', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Email Engaged</div>
                                    <div class="filter-detail">Opened email in last 30 days</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Loyalty Tier: Gold or Platinum', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Loyalty Gold+</div>
                                    <div class="filter-detail">Gold or Platinum tier</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Purchase Date: Last 60 days', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Recent Purchasers</div>
                                    <div class="filter-detail">Purchased in last 60 days</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Interest: Winter Sports', '', exclusionMode, 'filter')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Winter Enthusiasts</div>
                                    <div class="filter-detail">Interest in winter sports</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Tab -->
                    <div class="filter-tab-content" id="content-metrics">
                        <div class="filter-panel-header">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <h3>Metrics</h3>
                                    <p>Calculated metrics using multiple attributes with formulas</p>
                                </div>
                                <button onclick="toggleMetricBuilder()" id="createMetricBtn" style="background: #1d72f3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 0.375rem;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Create New Metric
                                </button>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" placeholder="Search metrics..." class="filter-search-input">
                        </div>
                        <div class="filter-items-grid">
                            <div class="filter-item" onclick="addQuickFilter('Customer Lifetime Value: > $100', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High LTV Customers</div>
                                    <div class="filter-detail">Total Spend + Projected Value > $100</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Engagement Score: > 75', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Highly Engaged</div>
                                    <div class="filter-detail">(Email Opens + Clicks + Site Visits) / 3 > 75</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Average Order Value: > $150', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High AOV Shoppers</div>
                                    <div class="filter-detail">Total Spend / Order Count > $150</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Churn Risk Score: > 0.7', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Churn Risk</div>
                                    <div class="filter-detail">Predicted churn probability > 70%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Purchase Frequency: > 3/month', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Frequent Buyers</div>
                                    <div class="filter-detail">Order Count / Months Active > 3</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Customer Health Score: > 80', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Healthy Customers</div>
                                    <div class="filter-detail">Composite score (LTV + Engagement + Recency) > 80</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('ROI Score: > 5x', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High ROI Customers</div>
                                    <div class="filter-detail">Revenue / Marketing Cost > 5</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Product Affinity Score: > 0.8', '', exclusionMode, 'metric')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Brand Loyalists</div>
                                    <div class="filter-detail">Repeat Purchase Rate + NPS / 2 > 0.8</div>
                                </div>
                            </div>
                        </div>

                        <!-- Inline Metric Builder (Hidden by default) -->
                        <div id="inlineMetricBuilder" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #f9fafb; border: 2px solid #1d72f3; border-radius: 0.5rem; animation: slideDown 0.3s ease-out;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
                                    </svg>
                                    Build Your Custom Metric
                                </h4>
                                <button onclick="closeMetricBuilder()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 0.25rem;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Quick Metric Suggestions -->
                            <div style="margin-bottom: 1.25rem; padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 0.625rem; text-transform: uppercase; letter-spacing: 0.05em;">Common Marketing Metrics</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    <button onclick="addQuickMetric('Average Basket Size', 'TotalSpend', 'OrderCount', 'divide', '>', '150', 'all')" style="padding: 0.4375rem 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #0c4a6e;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                         Avg Basket Size
                                    </button>
                                    <button onclick="addQuickMetric('Recent Interest Level', 'SiteVisits', '', 'none', '>=', '3', '7days')" style="padding: 0.4375rem 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #0c4a6e;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                         Recent Interest
                                    </button>
                                    <button onclick="addQuickMetric('Communication Engagement', 'EmailOpens', '', 'none', '>=', '5', '90days')" style="padding: 0.4375rem 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #0c4a6e;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                         Email Engaged
                                    </button>
                                    <button onclick="addQuickMetric('LTV Trend', 'TotalSpend', 'LifetimeValue', 'divide', '>', '20', '90days')" style="padding: 0.4375rem 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #0c4a6e;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                         LTV Trend
                                    </button>
                                    <button onclick="addQuickMetric('Content Engagement', 'Downloads', 'WebinarAttendance', 'add', '>=', '3', 'all')" style="padding: 0.4375rem 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #0c4a6e;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                         Content Engaged
                                    </button>
                                    <button onclick="addQuickMetric('Loyalty Tier Progress', 'OrderAmount', '', 'none', '>=', '1000', 'currentyear')" style="padding: 0.4375rem 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #0c4a6e;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                         Loyalty Progress
                                    </button>
                                    <button onclick="addQuickMetric('Product Affinity Score', 'CategoryPurchases', 'TotalPurchases', 'divide', '>', '0.3', 'all')" style="padding: 0.4375rem 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-weight: 600; color: #0c4a6e;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                         Product Affinity
                                    </button>
                                </div>
                            </div>

                            <!-- Initial Agentic Input Section -->
                            <div id="metricInitialInput" style="margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                                        </svg>
                                        <label style="font-size: 0.8125rem; font-weight: 600; color: #1d72f3;">Describe Your Metric (AI-Powered)</label>
                                    </div>
                                    <button onclick="toggleMetricExamples()" style="background: none; border: none; color: #6b7280; font-size: 0.75rem; cursor: pointer; text-decoration: underline;">
                                        See examples
                                    </button>
                                </div>
                                <textarea id="metricAgentInput" placeholder="Describe what you want to measure (e.g., 'average order value greater than 500')" style="width: 100%; padding: 0.75rem; border: 2px solid #1d72f3; border-radius: 0.375rem; font-size: 0.875rem; min-height: 70px; resize: vertical; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;" onkeydown="if(event.key === 'Enter' && (event.metaKey || event.ctrlKey)) { parseMetricFromAgent(); event.preventDefault(); }"></textarea>
                                <div id="metricExamples" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; font-size: 0.75rem; color: #6b7280;">
                                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Try these examples:</div>
                                    <div style="display: flex; flex-direction: column; gap: 0.375rem;">
                                        <div style="cursor: pointer; padding: 0.375rem; border-radius: 0.25rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" onclick="document.getElementById('metricAgentInput').value = this.textContent; parseMetricFromAgent();">
                                             average order value greater than 500
                                        </div>
                                        <div style="cursor: pointer; padding: 0.375rem; border-radius: 0.25rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" onclick="document.getElementById('metricAgentInput').value = this.textContent; parseMetricFromAgent();">
                                             average lifetime value above 1000
                                        </div>
                                        <div style="cursor: pointer; padding: 0.375rem; border-radius: 0.25rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" onclick="document.getElementById('metricAgentInput').value = this.textContent; parseMetricFromAgent();">
                                             total revenue divided by marketing cost greater than 5
                                        </div>
                                        <div style="cursor: pointer; padding: 0.375rem; border-radius: 0.25rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" onclick="document.getElementById('metricAgentInput').value = this.textContent; parseMetricFromAgent();">
                                             purchase frequency more than 3 per month
                                        </div>
                                        <div style="cursor: pointer; padding: 0.375rem; border-radius: 0.25rem; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'" onclick="document.getElementById('metricAgentInput').value = this.textContent; parseMetricFromAgent();">
                                             engagement score at least 75
                                        </div>
                                    </div>
                                </div>
                                <button onclick="parseMetricFromAgent()" style="margin-top: 0.5rem; padding: 0.625rem 1.25rem; background: linear-gradient(135deg, #1d72f3 0%, #0d52c4 100%); color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 2px 4px rgba(29, 114, 243, 0.2);">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                                    </svg>
                                    Generate Metric
                                </button>
                                <div style="font-size: 0.6875rem; color: #9ca3af; margin-top: 0.375rem;">
                                     Tip: Press Cmd/Ctrl + Enter to generate
                                </div>
                            </div>

                            <!-- Unified Conversational Refinement View (Hidden initially, shown after first metric is built) -->
                            <div id="metricConversationalView" style="display: none; margin-bottom: 1rem;">
                                <!-- Single unified panel with gradient border -->
                                <div style="background: white; border: 2px solid #1d72f3; border-radius: 0.5rem; padding: 0.875rem; box-shadow: 0 2px 8px rgba(29, 114, 243, 0.1);">
                                    <!-- Header with instruction -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; padding-bottom: 0.625rem; border-bottom: 1px solid #e5e7eb;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                                <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                                            </svg>
                                            <h5 style="font-size: 0.8125rem; font-weight: 600; color: #1d72f3;">AI Metric Builder</h5>
                                        </div>
                                        <div style="font-size: 0.6875rem; color: #6b7280; font-style: italic;">
                                            Chat with agent  Formula updates instantly
                                        </div>
                                    </div>
                                    
                                    <!-- Two-column layout: Chat LEFT, Formula RIGHT -->
                                    <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 0.75rem;">
                                        <!-- LEFT: Chat Interface with conversation history -->
                                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; display: flex; flex-direction: column; height: 280px;">
                                            <div style="padding: 0.5rem 0.625rem; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                                                <div style="font-size: 0.6875rem; font-weight: 600; color: #0c4a6e; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.375rem;">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                                    </svg>
                                                    Conversation with Agent
                                                </div>
                                            </div>
                                            
                                            <!-- Scrollable chat history -->
                                            <div id="metricChatHistory" style="flex: 1; padding: 0.625rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; background: white;">
                                                <!-- Chat messages will be populated here -->
                                                <div style="padding: 0.5rem; color: #9ca3af; font-size: 0.6875rem; text-align: center; font-style: italic;">
                                                    Chat history will appear here...
                                                </div>
                                            </div>
                                            
                                            <!-- Chat input at bottom of panel -->
                                            <div style="padding: 0.5rem 0.625rem; border-top: 1px solid #e5e7eb; background: white; border-radius: 0 0 0.375rem 0.375rem;">
                                                <div style="display: flex; gap: 0.375rem; align-items: center;">
                                                    <input type="text" id="metricRefinementInput" placeholder="Type to refine your metric..." style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.75rem; background: white;" onkeydown="if(event.key === 'Enter') { refineMetricFromChat(); event.preventDefault(); }">
                                                    <button onclick="refineMetricFromChat()" style="padding: 0.5rem 0.875rem; background: linear-gradient(135deg, #1d72f3 0%, #0d52c4 100%); color: white; border: none; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle;">
                                                            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div style="font-size: 0.625rem; color: #9ca3af; margin-top: 0.25rem; text-align: center;">
                                                    Press Enter to send
                                                </div>
                                            </div>
                                        </div>

                                        <!-- RIGHT: Formula Preview Panel -->
                                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.625rem; display: flex; flex-direction: column;">
                                            <div style="padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); margin: -0.625rem -0.625rem 0.625rem -0.625rem; padding: 0.5rem 0.625rem; border-radius: 0.375rem 0.375rem 0 0;">
                                                <div style="font-size: 0.6875rem; font-weight: 600; color: #92400e; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.375rem;">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                                                        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>
                                                    </svg>
                                                    Formula Preview
                                                </div>
                                            </div>
                                            <div id="metricFormulaPreview" style="font-size: 0.8125rem; color: #374151; line-height: 1.5; flex: 1; overflow-y: auto;">
                                                <!-- Formula details will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Manual Builder Toggle -->
                            <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <button onclick="toggleManualForm()" id="toggleManualBtn" style="background: none; border: none; color: #6b7280; font-size: 0.8125rem; cursor: pointer; text-decoration: underline; padding: 0.5rem 1rem; transition: color 0.2s;">
                                    Need more control? Build Manually 
                                </button>
                            </div>

                            <!-- Manual Form (Hidden by default) -->
                            <div id="manualMetricForm" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #d1d5db;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h5 style="font-size: 0.875rem; font-weight: 600; color: #374151;">Manual Metric Builder</h5>
                                    <button onclick="toggleManualForm()" style="background: none; border: none; color: #6b7280; font-size: 0.75rem; cursor: pointer;">
                                        Hide manual builder 
                                    </button>
                                </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <!-- Metric Name -->
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">Metric Name</label>
                                    <input type="text" id="metricNameInput" placeholder="e.g., High Value Shoppers" style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                </div>

                                <!-- Select Attributes -->
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">Select Attributes</label>
                                    <select id="metricAttribute1" style="width: 48%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; margin-right: 1%;">
                                        <option value="">Choose first attribute...</option>
                                        <option value="TotalSpend">Total Spend</option>
                                        <option value="OrderCount">Order Count</option>
                                        <option value="EmailOpens">Email Opens</option>
                                        <option value="SiteVisits">Site Visits</option>
                                        <option value="LifetimeValue">Lifetime Value</option>
                                        <option value="ProjectedValue">Projected Value</option>
                                        <option value="MonthsActive">Months Active</option>
                                        <option value="MarketingCost">Marketing Cost</option>
                                        <option value="Revenue">Revenue</option>
                                    </select>
                                    <select id="metricAttribute2" style="width: 48%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; margin-left: 1%;">
                                        <option value="">Choose second attribute (optional)...</option>
                                        <option value="TotalSpend">Total Spend</option>
                                        <option value="OrderCount">Order Count</option>
                                        <option value="EmailOpens">Email Opens</option>
                                        <option value="SiteVisits">Site Visits</option>
                                        <option value="LifetimeValue">Lifetime Value</option>
                                        <option value="ProjectedValue">Projected Value</option>
                                        <option value="MonthsActive">Months Active</option>
                                        <option value="MarketingCost">Marketing Cost</option>
                                        <option value="Revenue">Revenue</option>
                                    </select>
                                </div>

                                <!-- Formula -->
                                <div>
                                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">Formula</label>
                                    <select id="metricFormula" style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                        <option value="">Choose formula...</option>
                                        <option value="SUM">SUM - Add attributes</option>
                                        <option value="AVG">AVG - Average of attributes</option>
                                        <option value="DIVIDE">DIVIDE - Attr1 / Attr2</option>
                                        <option value="MULTIPLY">MULTIPLY - Attr1  Attr2</option>
                                        <option value="COUNT">COUNT - Count of records</option>
                                        <option value="MIN">MIN - Minimum value</option>
                                        <option value="MAX">MAX - Maximum value</option>
                                    </select>
                                </div>

                                <!-- Operator & Threshold -->
                                <div>
                                    <label style="display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">Condition</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <select id="metricOperator" style="flex: 1; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <option value=">">Greater than (>)</option>
                                            <option value="<">Less than (<)</option>
                                            <option value=">=">Greater than or equal ()</option>
                                            <option value="<=">Less than or equal ()</option>
                                            <option value="=">Equal to (=)</option>
                                        </select>
                                        <input type="number" id="metricThreshold" placeholder="Value" style="flex: 1; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                </div>
                            </div>

                            <!-- Preview Formula -->
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.875rem; margin-bottom: 1rem;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 0.375rem;">FORMULA PREVIEW</div>
                                <div id="formulaPreview" style="font-family: 'Courier New', monospace; font-size: 0.875rem; color: #1f2937; font-weight: 600;">
                                    Select attributes and formula to see preview
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button onclick="closeMetricBuilder()" style="padding: 0.625rem 1.25rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; color: #374151; cursor: pointer;">
                                    Cancel
                                </button>
                                <button onclick="saveCustomMetric()" style="padding: 0.625rem 1.25rem; border: none; background: #1d72f3; color: white; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Save & Add to Segment
                                </button>
                            </div>
                            </div>
                            <!-- End Manual Form -->
                        </div>
                    </div>

                    <!-- Other Segments Tab -->
                    <div class="filter-tab-content" id="content-segments">
                        <div class="filter-panel-header">
                            <h3>Other Segments</h3>
                            <p>Include or exclude existing segments as nested conditions</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" placeholder="Search segments..." class="filter-search-input">
                        </div>
                        <div class="filter-items-grid">
                            <div class="filter-item" onclick="addQuickFilter('VIP Customers Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">VIP Customers</div>
                                    <div class="filter-detail">45.2K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Churn Risk Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Churn Risk</div>
                                    <div class="filter-detail">12.8K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Holiday Shoppers Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Holiday Shoppers</div>
                                    <div class="filter-detail">89.5K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Email Subscribers Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Email Subscribers</div>
                                    <div class="filter-detail">156K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('New Customers (30 days) Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">New Customers (30 days)</div>
                                    <div class="filter-detail">8.3K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Win-back Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Win-back Segment</div>
                                    <div class="filter-detail">22.1K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Premium Tier Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Premium Tier</div>
                                    <div class="filter-detail">34.7K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Mobile App Users Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Mobile App Users</div>
                                    <div class="filter-detail">67.9K members  Active</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Recently Contacted (30 days) Segment', '', exclusionMode, 'segment')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Recently Contacted (30 days)</div>
                                    <div class="filter-detail">24.3K members  Active  Common exclusion</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Predictive Scores Tab -->
                    <div class="filter-tab-content" id="content-scores">
                        <div class="filter-panel-header">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <h3>Predictive Scores</h3>
                                    <p>AI-powered propensity and affinity scores from Model Builder</p>
                                </div>
                                <button onclick="alert('Navigate to Model Builder')" style="background: #1d72f3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 0.375rem;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Create New Score
                                </button>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" placeholder="Search predictive scores..." class="filter-search-input">
                        </div>
                        <div class="filter-items-grid">
                            <div class="filter-item" onclick="addQuickFilter('Purchase Propensity: > 0.7', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Purchase Propensity</div>
                                    <div class="filter-detail">ML Score: Likelihood to purchase in next 30 days > 70%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Churn Propensity: > 0.6', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Churn Risk</div>
                                    <div class="filter-detail">ML Score: Likelihood to churn in next 90 days > 60%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Product Affinity - Outdoor Gear: > 0.8', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Outdoor Gear Affinity</div>
                                    <div class="filter-detail">ML Score: Interest in outdoor products > 80%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Product Affinity - Electronics: > 0.75', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Electronics Affinity</div>
                                    <div class="filter-detail">ML Score: Interest in electronics > 75%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Upsell Propensity: > 0.65', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Upsell Potential</div>
                                    <div class="filter-detail">ML Score: Likelihood to upgrade/buy premium > 65%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Cross-sell Propensity: > 0.7', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Cross-sell Potential</div>
                                    <div class="filter-detail">ML Score: Likelihood to buy complementary products > 70%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Brand Affinity: > 0.85', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Brand Loyalty</div>
                                    <div class="filter-detail">ML Score: Brand preference and loyalty > 85%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Response Propensity - Email: > 0.6', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Email Response Propensity</div>
                                    <div class="filter-detail">ML Score: Likelihood to engage with email > 60%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Conversion Propensity: > 0.75', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Conversion Likelihood</div>
                                    <div class="filter-detail">ML Score: Probability to convert from lead > 75%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Win-back Propensity: > 0.55', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Win-back Opportunity</div>
                                    <div class="filter-detail">ML Score: Likelihood lapsed customers will return > 55%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Product Recommendation Score - Premium: > 0.8', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">Premium Product Fit</div>
                                    <div class="filter-detail">ML Score: Fit for premium products > 80%</div>
                                </div>
                            </div>
                            <div class="filter-item" onclick="addQuickFilter('Referral Propensity: > 0.7', '', exclusionMode, 'score')">
                                <span class="filter-icon"></span>
                                <div class="filter-info">
                                    <div class="filter-name">High Referral Likelihood</div>
                                    <div class="filter-detail">ML Score: Likelihood to refer friends > 70%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excludes Section -->
            <div class="excludes-section" id="excludesSection">
                <div class="excludes-header">
                    <div class="excludes-label">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <span>Excludes</span>
                        <span style="font-size: 0.875rem; color: #9ca3af; font-weight: 400; margin-left: 0.25rem;">Criteria to filter out</span>
                    </div>
                    <button class="add-exclusion-btn" onclick="toggleQuickFiltersForExclusion()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Exclusion
                    </button>
                </div>
                
                <div class="excludes-list" id="excludesList">
                    <!-- Empty State Placeholder for Exclusions (shown by default) -->
                    <div id="emptyStateExclusions" style="text-align: center; padding: 2rem 1rem; color: #9ca3af;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 0.75rem; opacity: 0.4;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <div style="font-size: 0.9375rem; color: #9ca3af;">No exclusions added. Click "Add Exclusion" to filter out specific criteria.</div>
                    </div>
                </div>
            </div>

            <div class="nav-buttons" style="display: flex; justify-content: flex-end; align-items: center; gap: 0.75rem; margin-top: 2rem;">
                <button class="btn-nav btn-nav-primary" onclick="switchTab(1)" style="font-size: 0.875rem; padding: 0.625rem 1.25rem;">
                    Next: Rank & Limit
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 0.375rem;">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
                <button class="btn-nav btn-nav-secondary" onclick="switchTab(4)" style="font-size: 0.875rem; padding: 0.625rem 1.25rem;">
                    Skip to Activate
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 0.375rem;">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tab 1: Rank and Limit -->
        <div id="tabContent1" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Rank and Limit</h2>
                <p class="section-description">Transform your broad segment into highly specific, actionable audiences</p>
            </div>

            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 2rem;">
                <h4 style="font-size: 1rem; font-weight: 600; color: #1e40af; margin-bottom: 0.75rem;">What is Group, Rank, and Limit (GRL)?</h4>
                <p style="font-size: 0.875rem; color: #1e3a8a; line-height: 1.6;">
                    GRL allows you to organize records into meaningful groups, prioritize them based on defined business rules, and control segment sizes. 
                    This transforms broad segments into the <strong>best-of-the-best</strong> audiences for high-value targeting.
                </p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                    <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Group (The Bucket)</div>
                    <div style="font-size: 0.8125rem; color: #6b7280;">Gather members into buckets by City (London, Tokyo, etc.)</div>
                </div>
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                    <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Rank (The Priority)</div>
                    <div style="font-size: 0.8125rem; color: #6b7280;">Sort members by Lifetime Points within each city</div>
                </div>
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                    <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Limit (The Quantity)</div>
                    <div style="font-size: 0.8125rem; color: #6b7280;">Select only the Top 5 from each city</div>
                </div>
            </div>

            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 1.25rem;">Configure Your GRL Rules</h4>
                
                <!-- Step 1: Group -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                        <span style="color: #1d72f3; margin-right: 0.25rem;">1.</span> Group By
                    </label>
                    <select style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9375rem; color: #1f2937; background: white; cursor: pointer;">
                        <option value="">Select attribute to group by...</option>
                        <option value="region" selected>Geographic Region</option>
                        <option value="city">City</option>
                        <option value="account">Account ID</option>
                        <option value="loyalty">Loyalty Tier</option>
                    </select>
                    <div style="font-size: 0.8125rem; color: #6b7280; margin-top: 0.5rem;">
                        Example: Group by <strong>Geographic Region</strong> to ensure fair distribution across all areas
                    </div>
                </div>

                <!-- Step 2: Rank -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                        <span style="color: #1d72f3; margin-right: 0.25rem;">2.</span> Rank By
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.75rem;">
                        <select style="padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9375rem; color: #1f2937; background: white; cursor: pointer;">
                            <option value="">Select ranking attribute...</option>
                            <option value="ltv" selected>Lifetime Value (LTV)</option>
                            <option value="points">Loyalty Points</option>
                            <option value="recency">Last Purchase Date</option>
                            <option value="engagement">Engagement Score</option>
                        </select>
                        <select style="padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9375rem; color: #1f2937; background: white; cursor: pointer;">
                            <option value="desc" selected>Descending (Highest First)</option>
                            <option value="asc">Ascending (Lowest First)</option>
                        </select>
                    </div>
                    <div style="font-size: 0.8125rem; color: #6b7280; margin-top: 0.5rem;">
                        Example: Rank by <strong>Lifetime Value</strong> in descending order to prioritize highest-value customers
                    </div>
                </div>

                <!-- Step 3: Limit -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                        <span style="color: #1d72f3; margin-right: 0.25rem;">3.</span> Limit To
                    </label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="number" value="10" min="1" max="1000" style="width: 120px; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9375rem; color: #1f2937;">
                        <span style="font-size: 0.9375rem; color: #6b7280;">records per group</span>
                    </div>
                    <div style="font-size: 0.8125rem; color: #6b7280; margin-top: 0.5rem;">
                        Example: Limit to <strong>Top 10</strong> customers per region for a focused, high-value activation
                    </div>
                </div>
            </div>

            <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 2rem;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#92400e" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <div style="font-size: 0.875rem; color: #78350f; line-height: 1.6;">
                        <strong>Result Preview:</strong> Your segment of <strong>12,487 customers</strong> will be refined to approximately <strong>500 top customers</strong> 
                        (10 per region  ~50 regions). This ensures you target only the highest-value individuals while maintaining geographic balance.
                    </div>
                </div>
            </div>

            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                <h4 style="font-size: 0.9375rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Why Use Rank and Limit?</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; font-size: 0.875rem; color: #6b7280; line-height: 1.6;">
                    <div>
                        <strong style="color: #1f2937;"> Precision Targeting:</strong> Focus on best-fit customers instead of everyone who qualifies
                    </div>
                    <div>
                        <strong style="color: #1f2937;"> Resource Optimization:</strong> Control activation costs by limiting audience size
                    </div>
                    <div>
                        <strong style="color: #1f2937;"> Fair Distribution:</strong> Ensure representation across all groups (regions, accounts, etc.)
                    </div>
                    <div>
                        <strong style="color: #1f2937;"> No SQL Required:</strong> Simple point-and-click interface for complex logic
                    </div>
                </div>
            </div>

            <div class="nav-buttons" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-nav btn-nav-secondary" onclick="switchTab(0)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn-nav btn-nav-primary" onclick="switchTab(2)">
                        Channel Affinity (Optional)
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <button class="btn-nav btn-nav-secondary" onclick="switchTab(4)" style="border: 2px solid #1d72f3; color: #1d72f3; font-weight: 600;">
                        Skip to Activate
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Validation Content: Segment Preview (used in overlay) -->
        <div id="tabContentPreview" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Segment Preview</h2>
                <p class="section-description">Explore your segment population with detailed records and key insights</p>
            </div>

            <!-- High-Level Segment Summary Bar -->
            <div style="background: linear-gradient(135deg, #1d72f3 0%, #1e40af 100%); border-radius: 0.75rem; padding: 1.25rem 1.75rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 2.5rem; flex-wrap: wrap;">
                    <div>
                        <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">Total Audience</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: white;">45,700</div>
                    </div>
                    <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.2);"></div>
                    <div>
                        <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">Avg LTV</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: white;">$8,450</div>
                    </div>
                    <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.2);"></div>
                    <div>
                        <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">Top Tier</div>
                        <div style="font-size: 1.375rem; font-weight: 700; color: white;">Gold (47%)</div>
                    </div>
                    <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.2);"></div>
                    <div>
                        <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">Avg Age</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: white;">34.2</div>
                    </div>
                    <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.2);"></div>
                    <div>
                        <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">Gender Split</div>
                        <div style="font-size: 1.375rem; font-weight: 700; color: white;">60% M / 40% F</div>
                    </div>
                    <div style="width: 1px; height: 40px; background: rgba(255,255,255,0.2);"></div>
                    <div>
                        <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">Top Region</div>
                        <div style="font-size: 1.375rem; font-weight: 700; color: white;">US (53%)</div>
                    </div>
                </div>
            </div>

            <!-- Sample Data Table -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.75rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">
                            Sample Records
                        </h3>
                        <p style="font-size: 0.875rem; color: #6b7280;">Showing 50 records from your segment</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <input type="text" placeholder="Filter by name, email, region..." style="width: 300px; padding: 0.625rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                        <button style="padding: 0.625rem 1.25rem; background: #1d72f3; border: none; border-radius: 0.375rem; color: white; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
                            Export Sample
                        </button>
                    </div>
                </div>

                <!-- Table -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Customer ID</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Name</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">LTV</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Age</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Loyalty Tier</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Region</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Active Status</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Email</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Gender</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Annual Income</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Last Purchase</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Total Orders</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Avg Order Value</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Churn Risk</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;">Channel Pref</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.8125rem; white-space: nowrap;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-10281</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">Sarah Johnson</td>
                                <!-- Filter Criteria First -->
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$8,240</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">32</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Gold</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">Pacific NW</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <!-- Additional Attributes -->
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">sarah.j@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">F</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$95K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">245 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">18</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$458</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">High</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">Mobile Push</td>
                                <td style="padding: 0.875rem; text-align: center;">
                                    <button onclick="showRowActions(this)" style="background: none; border: none; cursor: pointer; padding: 0.25rem; color: #6b7280; transition: color 0.2s;" onmouseover="this.style.color='#1f2937'" onmouseout="this.style.color='#6b7280'">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="1"/>
                                            <circle cx="12" cy="5" r="1"/>
                                            <circle cx="12" cy="19" r="1"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-10742</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">Michael Chen</td>
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$12,100</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">28</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #e0e7ff; color: #3730a3; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Platinum</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">West Coast</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">m.chen@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">M</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$115K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">198 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">24</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$504</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef9c3; color: #854d0e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">Med</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">Email</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-11029</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">Emma Rodriguez</td>
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$7,520</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">41</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Gold</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">Southwest</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">emma.r@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">F</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$78K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">210 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">16</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$470</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">High</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">SMS</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-11384</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">David Park</td>
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$9,890</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">35</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Gold</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">Pacific NW</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">d.park@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">M</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$105K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">183 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">21</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$471</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef9c3; color: #854d0e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">Med</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">Mobile Push</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-11591</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">Olivia Martinez</td>
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$15,420</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">29</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #e0e7ff; color: #3730a3; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Platinum</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">Northeast</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">olivia.m@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">F</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$135K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">225 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">32</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$482</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">High</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">Email</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-11847</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">James Wilson</td>
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$6,780</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">38</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Gold</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">Midwest</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">j.wilson@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">M</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$72K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">267 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">14</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$484</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">High</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">In-App</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-12003</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">Sophia Lee</td>
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$11,200</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">26</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #e0e7ff; color: #3730a3; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Platinum</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">Pacific NW</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">sophia.lee@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">F</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$122K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">192 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">26</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$431</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef9c3; color: #854d0e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">Med</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">Mobile Push</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">CUST-12289</td>
                                <td style="padding: 0.875rem; color: #1f2937; font-weight: 500; white-space: nowrap;">Daniel Kim</td>
                                <td style="padding: 0.875rem; color: #059669; font-weight: 600; white-space: nowrap;">$8,650</td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">33</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Gold</span></td>
                                <td style="padding: 0.875rem; color: #1f2937; white-space: nowrap;">West Coast</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">Active</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">d.kim@email.com</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">M</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$91K</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">201 days ago</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">19</td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">$455</td>
                                <td style="padding: 0.875rem; white-space: nowrap;"><span style="background: #fef9c3; color: #854d0e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">Med</span></td>
                                <td style="padding: 0.875rem; color: #6b7280; white-space: nowrap;">Email</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        Showing 1-50 of 12,487 records
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; font-size: 0.875rem; color: #6b7280; cursor: pointer;">Previous</button>
                        <button style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; font-size: 0.875rem; color: #1f2937; font-weight: 600; cursor: pointer;">1</button>
                        <button style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; font-size: 0.875rem; color: #6b7280; cursor: pointer;">2</button>
                        <button style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; font-size: 0.875rem; color: #6b7280; cursor: pointer;">3</button>
                        <button style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; border-radius: 0.375rem; font-size: 0.875rem; color: #6b7280; cursor: pointer;">Next</button>
                    </div>
                </div>
            </div>

            <!-- Attribute Distribution Section -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">Attribute Distribution</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="loadAdditionalChart('region')" style="padding: 0.375rem 0.75rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.75rem; color: #4b5563; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">+ Region</button>
                        <button onclick="loadAdditionalChart('age')" style="padding: 0.375rem 0.75rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.75rem; color: #4b5563; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">+ Age</button>
                        <button onclick="loadAdditionalChart('city')" style="padding: 0.375rem 0.75rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.75rem; color: #4b5563; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">+ City</button>
                        <button onclick="loadAdditionalChart('income')" style="padding: 0.375rem 0.75rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.75rem; color: #4b5563; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">+ Income</button>
                        <button onclick="loadAdditionalChart('channel')" style="padding: 0.375rem 0.75rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.75rem; color: #4b5563; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">+ Channel</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem;">
                    <!-- Gender Distribution (Pie Chart) -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #4b5563; margin-bottom: 1rem; text-align: center;">Gender</div>
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <!-- Male: 60% -->
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#3b82f6" stroke-width="20" stroke-dasharray="188.5 314.16" transform="rotate(-90 60 60)" />
                                <!-- Female: 40% -->
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#ec4899" stroke-width="20" stroke-dasharray="125.66 314.16" stroke-dashoffset="-188.5" transform="rotate(-90 60 60)" />
                            </svg>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;">
                                <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                                <span style="color: #1f2937;">Male</span>
                                <span style="margin-left: auto; font-weight: 600; color: #1f2937;">60%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;">
                                <div style="width: 12px; height: 12px; background: #ec4899; border-radius: 2px;"></div>
                                <span style="color: #1f2937;">Female</span>
                                <span style="margin-left: auto; font-weight: 600; color: #1f2937;">40%</span>
                            </div>
                        </div>
                    </div>

                    <!-- LTV Distribution (Bar Chart) -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #4b5563; margin-bottom: 1rem; text-align: center;">LTV Distribution</div>
                        <div style="height: 140px; display: flex; align-items: flex-end; gap: 0.5rem; padding-top: 0.5rem;">
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <div style="font-size: 0.65rem; font-weight: 600; color: #1f2937;">32%</div>
                                <div style="width: 100%; height: 70px; background: linear-gradient(180deg, #10b981 0%, #059669 100%); border-radius: 0.25rem;"></div>
                                <div style="font-size: 0.65rem; color: #6b7280; text-align: center; line-height: 1.1;">High<br/>$8K+</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <div style="font-size: 0.65rem; font-weight: 600; color: #1f2937;">45%</div>
                                <div style="width: 100%; height: 95px; background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); border-radius: 0.25rem;"></div>
                                <div style="font-size: 0.65rem; color: #6b7280; text-align: center; line-height: 1.1;">Mid<br/>$3-8K</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <div style="font-size: 0.65rem; font-weight: 600; color: #1f2937;">23%</div>
                                <div style="width: 100%; height: 48px; background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); border-radius: 0.25rem;"></div>
                                <div style="font-size: 0.65rem; color: #6b7280; text-align: center; line-height: 1.1;">Low<br/><$3K</div>
                            </div>
                        </div>
                    </div>

                    <!-- Loyalty Tiers (Pie Chart) -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #4b5563; margin-bottom: 1rem; text-align: center;">Loyalty Tier</div>
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <!-- Gold: 47% -->
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#fbbf24" stroke-width="20" stroke-dasharray="147.65 314.16" transform="rotate(-90 60 60)" />
                                <!-- Platinum: 28% -->
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#9ca3af" stroke-width="20" stroke-dasharray="87.96 314.16" stroke-dashoffset="-147.65" transform="rotate(-90 60 60)" />
                                <!-- Silver: 25% -->
                                <circle cx="60" cy="60" r="50" fill="none" stroke="#c0c0c0" stroke-width="20" stroke-dasharray="78.54 314.16" stroke-dashoffset="-235.61" transform="rotate(-90 60 60)" />
                            </svg>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;">
                                <div style="width: 12px; height: 12px; background: #fbbf24; border-radius: 2px;"></div>
                                <span style="color: #1f2937;">Gold</span>
                                <span style="margin-left: auto; font-weight: 600; color: #1f2937;">47%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;">
                                <div style="width: 12px; height: 12px; background: #9ca3af; border-radius: 2px;"></div>
                                <span style="color: #1f2937;">Platinum</span>
                                <span style="margin-left: auto; font-weight: 600; color: #1f2937;">28%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;">
                                <div style="width: 12px; height: 12px; background: #c0c0c0; border-radius: 2px;"></div>
                                <span style="color: #1f2937;">Silver</span>
                                <span style="margin-left: auto; font-weight: 600; color: #1f2937;">25%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase Recency (Bar Chart) -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #4b5563; margin-bottom: 1rem; text-align: center;">Purchase Recency</div>
                        <div style="height: 140px; display: flex; align-items: flex-end; gap: 0.5rem; padding-top: 0.5rem;">
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <div style="font-size: 0.65rem; font-weight: 600; color: #1f2937;">28%</div>
                                <div style="width: 100%; height: 60px; background: linear-gradient(180deg, #10b981 0%, #059669 100%); border-radius: 0.25rem;"></div>
                                <div style="font-size: 0.65rem; color: #6b7280; text-align: center; line-height: 1.1;">0-30<br/>days</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <div style="font-size: 0.65rem; font-weight: 600; color: #1f2937;">35%</div>
                                <div style="width: 100%; height: 75px; background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%); border-radius: 0.25rem;"></div>
                                <div style="font-size: 0.65rem; color: #6b7280; text-align: center; line-height: 1.1;">31-60<br/>days</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <div style="font-size: 0.65rem; font-weight: 600; color: #1f2937;">22%</div>
                                <div style="width: 100%; height: 47px; background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); border-radius: 0.25rem;"></div>
                                <div style="font-size: 0.65rem; color: #6b7280; text-align: center; line-height: 1.1;">61-90<br/>days</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <div style="font-size: 0.65rem; font-weight: 600; color: #1f2937;">15%</div>
                                <div style="width: 100%; height: 32px; background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); border-radius: 0.25rem;"></div>
                                <div style="font-size: 0.65rem; color: #6b7280; text-align: center; line-height: 1.1;">90+<br/>days</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-buttons">
                <button class="btn-nav btn-nav-secondary" onclick="closeValidationOverlay()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Rules
                </button>
                <button class="btn-nav btn-nav-primary" onclick="openValidationOverlay('insights')">
                    Next: Insights
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Tab 2: Channel Affinity -->
        <div id="tabContent2" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Channel Affinity Analysis</h2>
                <p class="section-description">These channels perform best with your target audience</p>
            </div>

            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Why Look at Channel Affinity?</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem;">
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Optimize Engagement</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Reach your audience on channels where they're most active</div>
                    </div>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Reduce Waste</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Avoid spending on channels with low engagement potential</div>
                    </div>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Data-Driven Strategy</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Make informed decisions based on historical performance</div>
                    </div>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Perfect Timing</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Send messages when your audience is most likely to respond</div>
                    </div>
                </div>
            </div>

            <div class="channel-list">
                <div class="channel-card">
                    <div class="channel-header">
                        <div class="channel-icon"></div>
                        <div class="channel-info">
                            <div class="channel-name">
                                Mobile Push
                                <span class="channel-badge">Top Pick</span>
                            </div>
                            <div class="channel-engagement">High engagement potential</div>
                        </div>
                    </div>
                    <div class="channel-bar-container">
                        <div class="channel-bar">
                            <div class="channel-bar-fill" style="width: 70%"></div>
                        </div>
                        <div class="channel-percentage">70%</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding: 0.625rem; background: #eff6ff; border-radius: 0.375rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2" style="flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span style="font-size: 0.8125rem; color: #1e40af;">Best window: <strong>12:00 PM - 2:00 PM</strong></span>
                    </div>
                </div>

                <div class="channel-card">
                    <div class="channel-header">
                        <div class="channel-icon"></div>
                        <div class="channel-info">
                            <div class="channel-name">SMS</div>
                            <div class="channel-engagement">Medium engagement potential</div>
                        </div>
                    </div>
                    <div class="channel-bar-container">
                        <div class="channel-bar">
                            <div class="channel-bar-fill" style="width: 55%"></div>
                        </div>
                        <div class="channel-percentage">55%</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding: 0.625rem; background: #eff6ff; border-radius: 0.375rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2" style="flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span style="font-size: 0.8125rem; color: #1e40af;">Best window: <strong>10:00 AM - 12:00 PM</strong></span>
                    </div>
                </div>

                <div class="channel-card">
                    <div class="channel-header">
                        <div class="channel-icon"></div>
                        <div class="channel-info">
                            <div class="channel-name">Email</div>
                            <div class="channel-engagement">Lower engagement potential</div>
                        </div>
                    </div>
                    <div class="channel-bar-container">
                        <div class="channel-bar">
                            <div class="channel-bar-fill" style="width: 35%"></div>
                        </div>
                        <div class="channel-percentage">35%</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding: 0.625rem; background: #eff6ff; border-radius: 0.375rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2" style="flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span style="font-size: 0.8125rem; color: #1e40af;">Best window: <strong>6:00 PM - 8:00 PM</strong></span>
                    </div>
                </div>

                <div class="channel-card">
                    <div class="channel-header">
                        <div class="channel-icon"></div>
                        <div class="channel-info">
                            <div class="channel-name">In-App</div>
                            <div class="channel-engagement">Medium engagement potential</div>
                        </div>
                    </div>
                    <div class="channel-bar-container">
                        <div class="channel-bar">
                            <div class="channel-bar-fill" style="width: 18%"></div>
                        </div>
                        <div class="channel-percentage">18%</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding: 0.625rem; background: #eff6ff; border-radius: 0.375rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2" style="flex-shrink: 0;">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span style="font-size: 0.8125rem; color: #1e40af;">Best window: <strong>9:00 AM - 11:00 AM</strong></span>
                    </div>
                </div>
            </div>

            <div class="channel-insight">
                <strong>Insight:</strong> 70% of this segment responds better to Mobile Push notifications. Consider prioritizing this channel for maximum engagement.
            </div>

            <div class="channel-source">
                This data is based on performance analysis from <strong>847 previous segment activations</strong> targeting similar audience segments.
            </div>

            <div class="nav-buttons" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-nav btn-nav-secondary" onclick="switchTab(1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn-nav btn-nav-primary" onclick="switchTab(3)">
                        Smart Splits (Optional)
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <button class="btn-nav btn-nav-secondary" onclick="switchTab(4)" style="border: 2px solid #1d72f3; color: #1d72f3; font-weight: 600;">
                        Skip to Activate
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab 3: Smart Splits -->
        <div id="tabContent3" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Smart Splits</h2>
                <p class="section-description">Create optimized test variants to maximize segment performance</p>
            </div>

            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Why Use Smart Splits?</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem;">
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">A/B Testing</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Test different offers and messaging to find what resonates best</div>
                    </div>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Risk Mitigation</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Reduce activation risk by testing variants before full rollout</div>
                    </div>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Data-Driven Decisions</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Make informed choices based on real performance data</div>
                    </div>
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem;">
                        <div style="font-size: 1.25rem; margin-bottom: 0.5rem;"></div>
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">Maximize ROI</div>
                        <div style="font-size: 0.8125rem; color: #6b7280;">Identify the highest-performing variant to scale for better returns</div>
                    </div>
                </div>
            </div>

            <div class="split-controls-card">
                <div class="split-controls-header">
                    <h3 class="split-controls-title">Adjust Split Percentages</h3>
                    <button class="reset-link" onclick="resetSplit()">Reset to 50/50</button>
                </div>
                <div class="split-slider-wrapper">
                    <div class="split-display">
                        <div class="split-item">
                            <span class="split-emoji"></span>
                            <span class="split-percentage-text"><span id="splitA">50</span>%</span>
                        </div>
                    </div>
                    <input type="range" min="10" max="90" value="50" class="split-slider" id="splitSlider" oninput="updateSplit(this.value)">
                    <div class="split-display">
                        <div class="split-item">
                            <span class="split-emoji"></span>
                            <span class="split-percentage-text"><span id="splitB">50</span>%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="splits-grid">
                <div class="split-card">
                    <div class="split-card-header">
                        <div class="split-name-section">
                            <div class="split-name"> Push Discount</div>
                            <div class="split-label">Split 1 of 2</div>
                        </div>
                        <div class="split-size">
                            <div class="split-size-label">Split Size</div>
                            <div class="split-size-value"><span id="splitACard">50</span>%</div>
                        </div>
                    </div>
                    <div class="split-offer">
                        <div class="split-offer-icon"></div>
                        <div class="split-offer-title">15% Discount</div>
                        <div class="split-offer-channel">via Mobile Push</div>
                    </div>
                    <div class="split-audience">
                        <div class="split-audience-label">Audience</div>
                        <div class="split-audience-count" id="audienceA">6,244</div>
                    </div>
                </div>

                <div class="split-card">
                    <div class="split-card-header">
                        <div class="split-name-section">
                            <div class="split-name"> SMS Free Ship</div>
                            <div class="split-label">Split 2 of 2</div>
                        </div>
                        <div class="split-size">
                            <div class="split-size-label">Split Size</div>
                            <div class="split-size-value"><span id="splitBCard">50</span>%</div>
                        </div>
                    </div>
                    <div class="split-offer">
                        <div class="split-offer-icon"></div>
                        <div class="split-offer-title">Free Shipping</div>
                        <div class="split-offer-channel">via SMS</div>
                    </div>
                    <div class="split-audience">
                        <div class="split-audience-label">Audience</div>
                        <div class="split-audience-count" id="audienceB">6,243</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1.5rem; background: white; border: 2px dashed #d1d5db; border-radius: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1d72f3'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='white'" onclick="alert('Add Split functionality - You can create additional splits for multivariate testing!')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2" style="margin-bottom: 0.5rem;">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
                <div style="font-size: 0.9375rem; font-weight: 600; color: #1d72f3; margin-bottom: 0.25rem;">Add Another Split</div>
                <div style="font-size: 0.8125rem; color: #6b7280;">Create additional variants for multivariate testing</div>
            </div>

            <div class="nav-buttons" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-nav btn-nav-secondary" onclick="switchTab(2)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn-nav btn-nav-primary" onclick="switchTab(4)">
                        Activate
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Validation Content: Segment Insights (used in overlay) -->
        <div id="tabContentInsights" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Segment Insights</h2>
                <p class="section-description">Strategic understanding of your audience composition, behavior, and business impact</p>
            </div>

            <!-- A. Audience Composition -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Audience Composition</h3>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <!-- LTV Tier Distribution -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem; text-align: center;">LTV Tier Distribution</div>
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                            <svg width="120" height="120" viewBox="0 0 200 200">
                                <!-- High: 45% -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#10b981" stroke-width="30" stroke-dasharray="283 628" transform="rotate(-90 100 100)"/>
                                <!-- Medium: 35% -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#f59e0b" stroke-width="30" stroke-dasharray="220 628" stroke-dashoffset="-283" transform="rotate(-90 100 100)"/>
                                <!-- Low: 20% -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#ef4444" stroke-width="30" stroke-dasharray="126 628" stroke-dashoffset="-503" transform="rotate(-90 100 100)"/>
                            </svg>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.375rem; font-size: 0.875rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;"><span style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span><span>High 45%</span></div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;"><span style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></span><span>Medium 35%</span></div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;"><span style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></span><span>Low 20%</span></div>
                        </div>
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                            <div style="font-size: 0.8125rem; color: #6b7280; font-weight: 600;"> 45% High LTV  Premium positioning recommended</div>
                        </div>
                    </div>

                    <!-- Loyalty Status Breakdown -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem; text-align: center;">Loyalty Status</div>
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                            <svg width="120" height="120" viewBox="0 0 200 200">
                                <!-- Gold: 47% -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#fbbf24" stroke-width="30" stroke-dasharray="295 628" transform="rotate(-90 100 100)"/>
                                <!-- Silver: 28% -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#c0c0c0" stroke-width="30" stroke-dasharray="176 628" stroke-dashoffset="-295" transform="rotate(-90 100 100)"/>
                                <!-- Bronze: 25% -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#cd7f32" stroke-width="30" stroke-dasharray="157 628" stroke-dashoffset="-471" transform="rotate(-90 100 100)"/>
                            </svg>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.375rem; font-size: 0.875rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;"><span style="width: 12px; height: 12px; background: #fbbf24; border-radius: 2px;"></span><span>Gold 47%</span></div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;"><span style="width: 12px; height: 12px; background: #c0c0c0; border-radius: 2px;"></span><span>Silver 28%</span></div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;"><span style="width: 12px; height: 12px; background: #cd7f32; border-radius: 2px;"></span><span>Bronze 25%</span></div>
                        </div>
                    </div>

                    <!-- Customer Lifecycle Stages -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem; text-align: center;">Lifecycle Stages</div>
                        <div style="height: 200px; display: flex; align-items: flex-end; gap: 0.75rem; padding: 0.5rem;">
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">35%</div>
                                <div style="width: 100%; height: 140px; background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.8125rem; color: #6b7280; text-align: center;">New</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">40%</div>
                                <div style="width: 100%; height: 160px; background: linear-gradient(180deg, #10b981 0%, #059669 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.8125rem; color: #6b7280; text-align: center;">Growing</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">18%</div>
                                <div style="width: 100%; height: 72px; background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.8125rem; color: #6b7280; text-align: center;">Mature</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">7%</div>
                                <div style="width: 100%; height: 28px; background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.8125rem; color: #6b7280; text-align: center;">Veteran</div>
                            </div>
                        </div>
                    </div>

                    <!-- Engagement Levels -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem; text-align: center;">Engagement Levels</div>
                        <div style="height: 200px; display: flex; align-items: flex-end; gap: 0.75rem; padding: 0.5rem;">
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">28%</div>
                                <div style="width: 100%; height: 112px; background: linear-gradient(180deg, #10b981 0%, #059669 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.75rem; color: #6b7280; text-align: center; line-height: 1.2;">Highly<br/>Engaged</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">42%</div>
                                <div style="width: 100%; height: 168px; background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.75rem; color: #6b7280; text-align: center; line-height: 1.2;">Moderate</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">22%</div>
                                <div style="width: 100%; height: 88px; background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.75rem; color: #6b7280; text-align: center; line-height: 1.2;">At Risk</div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.375rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">8%</div>
                                <div style="width: 100%; height: 32px; background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); border-radius: 0.375rem;"></div>
                                <div style="font-size: 0.75rem; color: #6b7280; text-align: center; line-height: 1.2;">Dormant</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B. Behavioral Patterns & C. Revenue & Value Indicators -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <!-- B. Behavioral Patterns -->
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Behavioral Patterns</h3>
                    
                    <!-- Purchase Behavior -->
                    <div style="margin-bottom: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Purchase Behavior</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            <div style="background: #f9fafb; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Order Frequency</div>
                                <div style="font-size: 1.375rem; font-weight: 700; color: #1f2937;">3.2x/yr</div>
                            </div>
                            <div style="background: #f9fafb; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Favorite Category</div>
                                <div style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">Outdoor Gear</div>
                            </div>
                            <div style="background: #f9fafb; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Cross-Buy Propensity</div>
                                <div style="font-size: 1.375rem; font-weight: 700; color: #10b981;">68%</div>
                            </div>
                            <div style="background: #f9fafb; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Seasonal Pattern</div>
                                <div style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">Spring Peak</div>
                            </div>
                        </div>
                    </div>

                    <!-- Engagement Patterns -->
                    <div style="margin-bottom: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Engagement Patterns</div>
                        <div style="display: flex; flex-direction: column; gap: 0.625rem;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.875rem; color: #6b7280;">Email Open Rate</span>
                                    <span style="font-size: 0.9375rem; font-weight: 600; color: #1f2937;">42%</span>
                                </div>
                                <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: 42%; background: #10b981;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.875rem; color: #6b7280;">SMS Response Rate</span>
                                    <span style="font-size: 0.9375rem; font-weight: 600; color: #1f2937;">35%</span>
                                </div>
                                <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: 35%; background: #3b82f6;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.875rem; color: #6b7280;">App Engagement</span>
                                    <span style="font-size: 0.9375rem; font-weight: 600; color: #1f2937;">73%</span>
                                </div>
                                <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: 73%; background: #8b5cf6;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #bbf7d0;">
                            <div style="font-size: 0.8125rem; color: #166534; font-weight: 600;"> Best Time: 6:00 PM - 8:00 PM weekdays</div>
                        </div>
                    </div>
                </div>

                <!-- C. Revenue & Value Indicators -->
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Revenue & Value Indicators</h3>
                    
                    <!-- Key Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.25rem;">
                        <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.625rem; padding: 1.25rem; text-align: center;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.375rem;">Total Addressable Value</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #1f2937;">$38.6M</div>
                        </div>
                        <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 0.625rem; padding: 1.25rem; text-align: center;">
                            <div style="font-size: 0.875rem; color: #166534; margin-bottom: 0.375rem;">Avg LTV per Customer</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #15803d;">$8,450</div>
                        </div>
                        <div style="background: #fef3c7; border: 2px solid #fde68a; border-radius: 0.625rem; padding: 1.25rem; text-align: center;">
                            <div style="font-size: 0.875rem; color: #92400e; margin-bottom: 0.375rem;">Revenue at Risk</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #b45309;">$2.94M</div>
                        </div>
                        <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.625rem; padding: 1.25rem; text-align: center;">
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.375rem;">Projected Lifetime Value</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #1f2937;">$11.2K</div>
                        </div>
                    </div>

                    <!-- Spending Patterns -->
                    <div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Spending Patterns</div>
                        <div style="display: flex; flex-direction: column; gap: 0.875rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.875rem; background: #f9fafb; border-radius: 0.5rem;">
                                <span style="font-size: 0.875rem; color: #6b7280;">Average Order Value (AOV)</span>
                                <span style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">$425</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.875rem; background: #f9fafb; border-radius: 0.5rem;">
                                <span style="font-size: 0.875rem; color: #6b7280;">Purchase Frequency</span>
                                <span style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">3.2x/year</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.875rem; background: #f9fafb; border-radius: 0.5rem;">
                                <span style="font-size: 0.875rem; color: #6b7280;">Basket Composition</span>
                                <span style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">2.8 items avg</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- D. Risk & Opportunity Scores -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Risk & Opportunity Scores</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <!-- Churn Risk Distribution -->
                    <div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Churn Risk Distribution</div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.875rem; color: #6b7280;">High Risk</span>
                                    <span style="font-size: 0.9375rem; font-weight: 600; color: #ef4444;">65%</span>
                                </div>
                                <div style="height: 8px; background: #fee2e2; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 65%; background: linear-gradient(to right, #ef4444, #dc2626);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.875rem; color: #6b7280;">Medium Risk</span>
                                    <span style="font-size: 0.9375rem; font-weight: 600; color: #f59e0b;">23%</span>
                                </div>
                                <div style="height: 8px; background: #fef3c7; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 23%; background: linear-gradient(to right, #f59e0b, #d97706);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.875rem; color: #6b7280;">Low Risk</span>
                                    <span style="font-size: 0.9375rem; font-weight: 600; color: #10b981;">12%</span>
                                </div>
                                <div style="height: 8px; background: #d1fae5; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: 12%; background: linear-gradient(to right, #10b981, #059669);"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Opportunity Scores -->
                    <div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Opportunity Scores</div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #166534; margin-bottom: 0.25rem;">Upsell Potential</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #15803d;">High</div>
                                <div style="font-size: 0.8125rem; color: #16a34a;">78% likely to upgrade</div>
                            </div>
                            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #1e40af; margin-bottom: 0.25rem;">Cross-Sell Readiness</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1e3a8a;">68%</div>
                                <div style="font-size: 0.8125rem; color: #2563eb;">2+ category interest</div>
                            </div>
                            <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #92400e; margin-bottom: 0.25rem;">Win-Back Opportunity</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #b45309;">Medium</div>
                                <div style="font-size: 0.8125rem; color: #d97706;">45% recoverable</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sentiment Indicators -->
                    <div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Sentiment Indicators</div>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 0.625rem;">
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Net Promoter Score (NPS)</div>
                                <div style="font-size: 3rem; font-weight: 700; color: #10b981; line-height: 1;">72</div>
                                <div style="font-size: 0.875rem; color: #059669; font-weight: 600; margin-top: 0.375rem;">Excellent</div>
                            </div>
                            <div style="padding: 0.875rem; background: #f9fafb; border-radius: 0.5rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Satisfaction Trend</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5">
                                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                        <polyline points="17 6 23 6 23 12"/>
                                    </svg>
                                    <span style="font-size: 1.125rem; font-weight: 700; color: #10b981;">+8.5%</span>
                                    <span style="font-size: 0.875rem; color: #6b7280;">vs last quarter</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- E. Recommended Actions (Single Horizontal Bar) -->
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">AI-Powered Recommendations</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; align-items: start; gap: 0.875rem;">
                            <div style="width: 40px; height: 40px; background: #e5e7eb; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
                                    <circle cx="12" cy="8" r="7"/>
                                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                                </svg>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 0.9375rem;">Premium Positioning</div>
                                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.5;">
                                    45% High LTV segment. Emphasize quality & exclusivity. Target with premium product lines.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; align-items: start; gap: 0.875rem;">
                            <div style="width: 40px; height: 40px; background: #e5e7eb; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 0.9375rem;">Optimal Timing</div>
                                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.5;">
                                    Best engagement 6-8 PM weekdays. Spring seasonal peak. Schedule activations accordingly.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; align-items: start; gap: 0.875rem;">
                            <div style="width: 40px; height: 40px; background: #e5e7eb; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 0.9375rem;">Retention Focus</div>
                                <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.5;">
                                    65% high churn risk. Add retention incentive. Personalized win-back offers recommended.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="btn-nav btn-nav-secondary" onclick="closeValidationOverlay()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Rules
                </button>
                <button class="btn-nav btn-nav-primary" onclick="openValidationOverlay('overlap')">
                    Next: Overlap
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Validation Content: Overlap Analysis (used in overlay) -->
        <div id="tabContentOverlap" class="tab-content" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Overlap Analysis</h2>
                <p class="section-description">Visualize overlap with other active and historical segments</p>
            </div>

            <div class="analytics-grid" style="display: none;">
                <!-- Row 1 -->
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Total Reachable</div>
                    <div class="stat-value">12,487</div>
                    <div class="stat-change">+2.3% vs last activation</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Expected Reach</div>
                    <div class="stat-value">87.2%</div>
                    <div class="stat-change" style="color: #6b7280;">Based on channel affinity</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Gender Ratio</div>
                    <div class="stat-value">60:40</div>
                    <div class="stat-change" style="color: #6b7280;">Male : Female</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Average Age</div>
                    <div class="stat-value">34.2</div>
                    <div class="stat-change" style="color: #6b7280;">years old</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Top Age Group</div>
                    <div class="stat-value">25-34</div>
                    <div class="stat-change" style="color: #6b7280;">4,620 customers (37%)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Avg Lifetime Value</div>
                    <div class="stat-value">$3,240</div>
                    <div class="stat-change">+12% vs avg customer</div>
                </div>

                <!-- Row 2 -->
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Top Region</div>
                    <div class="stat-value">Pacific NW</div>
                    <div class="stat-change" style="color: #6b7280;">2,847 customers (23%)</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Avg Days Since Purchase</div>
                    <div class="stat-value">210</div>
                    <div class="stat-change" style="color: #6b7280;">~7 months inactive</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Past Purchase Rate</div>
                    <div class="stat-value">3.8x</div>
                    <div class="stat-change">Above average</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-icon"></div>
                    </div>
                    <div class="stat-label">Loyalty Status</div>
                    <div class="stat-value">Gold+</div>
                    <div class="stat-change" style="color: #6b7280;">89% are Gold or Platinum</div>
                </div>

            </div>

            <div style="background: white; border: 2px solid #1d72f3; border-radius: 0.75rem; padding: 1.75rem; margin: 2rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                <circle cx="12" cy="8" r="7"/>
                                <circle cx="12" cy="8" r="3"/>
                                <path d="M12 15v6"/>
                            </svg>
                            Segment Overlap Analysis
                        </h3>
                        <p style="font-size: 0.875rem; color: #6b7280;">Visualize overlap with other active and historical segments</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="filterOverlapSegments('week')" id="filterWeek" style="padding: 0.5rem 1rem; border: 2px solid #d1d5db; background: white; color: #6b7280; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Last Week
                        </button>
                        <button onclick="filterOverlapSegments('month')" id="filterMonth" style="padding: 0.5rem 1rem; border: 2px solid #d1d5db; background: white; color: #6b7280; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Last Month
                        </button>
                        <button onclick="filterOverlapSegments('all')" id="filterAll" style="padding: 0.5rem 1rem; border: 2px solid #1d72f3; background: #1d72f3; color: white; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            All Segments
                        </button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 2rem;">
                    <!-- Left: Venn Diagram Visualization -->
                    <div>
                        <div style="margin-bottom: 1.25rem;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">
                                Compare with segment:
                            </label>
                            <select id="overlapSegmentSelector" onchange="updateOverlapVisualization(this.value)" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9375rem; color: #1f2937; background: white; cursor: pointer;">
                                <option value="outdoor" data-period="week month">Outdoor Adventure Enthusiasts (Last Week + Last Month)</option>
                                <option value="winter" data-period="week">Winter Sports Promo (Last Week)</option>
                                <option value="holiday" data-period="month">Holiday Gift Guide (Last Month)</option>
                                <option value="premium" data-period="all">Premium Product Buyers (Active)</option>
                                <option value="loyalty" data-period="all">Loyalty Program - Gold Tier (Active)</option>
                                <option value="recentBuyers" data-period="all">Recent Buyers - 30 Days (Active)</option>
                            </select>
                        </div>

                        <!-- Venn Diagram -->
                        <div style="position: relative; height: 340px; background: #f9fafb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem;">
                            <svg width="100%" height="100%" viewBox="0 0 400 300" style="overflow: visible;">
                                <!-- Left Circle (Current Segment) -->
                                <circle id="vennCircle1" cx="140" cy="150" r="100" fill="#1d72f3" fill-opacity="0.3" stroke="#1d72f3" stroke-width="3"/>
                                
                                <!-- Right Circle (Comparison Segment) -->
                                <circle id="vennCircle2" cx="260" cy="150" r="100" fill="#10b981" fill-opacity="0.3" stroke="#10b981" stroke-width="3"/>
                                
                                <!-- Overlap region highlight (intersection) -->
                                <path id="vennOverlapPath" d="M 200 60 A 100 100 0 0 1 200 240 A 100 100 0 0 1 200 60" fill="#8b5cf6" fill-opacity="0.5"/>
                                
                                <!-- Labels -->
                                <text x="100" y="150" text-anchor="middle" font-size="14" font-weight="600" fill="#1e40af">
                                    <tspan x="100" dy="-10">Your</tspan>
                                    <tspan x="100" dy="20">Segment</tspan>
                                    <tspan x="100" dy="20" font-size="20" font-weight="700">12,487</tspan>
                                </text>
                                
                                <text id="vennCompareLabel" x="300" y="150" text-anchor="middle" font-size="14" font-weight="600" fill="#065f46">
                                    <tspan x="300" dy="-10">Outdoor</tspan>
                                    <tspan x="300" dy="20">Adventures</tspan>
                                    <tspan x="300" dy="20" font-size="20" font-weight="700">18,245</tspan>
                                </text>
                                
                                <text x="200" y="150" text-anchor="middle" font-size="16" font-weight="700" fill="#6b21a8">
                                    <tspan x="200" dy="-10">Overlap</tspan>
                                    <tspan x="200" dy="25" font-size="24">42%</tspan>
                                    <tspan x="200" dy="25" font-size="14" font-weight="600">5,244</tspan>
                                </text>
                            </svg>
                        </div>

                        <!-- Overlap Details -->
                        <div id="overlapDetails" style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 0.5rem; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                                <div style="font-weight: 600; color: #166534; font-size: 0.9375rem;">Outdoor Adventure Enthusiasts</div>
                            </div>
                            <div style="font-size: 0.875rem; color: #166534; line-height: 1.6; margin-bottom: 0.75rem;">
                                <strong>Activation History:</strong> Ran last week and last month with strong engagement
                            </div>
                            <div style="display: grid; gap: 0.5rem; font-size: 0.8125rem; color: #166534;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Last Week (Winter Sports Promo):</span>
                                    <strong>35% responded</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Last Month (Holiday Gift Guide):</span>
                                    <strong>52% responded</strong>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #86efac; font-size: 0.8125rem; color: #166534;">
                                <strong> Recommendation:</strong> Coordinate messaging timing to avoid message fatigue. Consider suppressing overlapping users for 2-3 weeks.
                            </div>
                        </div>
                    </div>

                    <!-- Right: Quick Segment List -->
                    <div>
                        <h4 style="font-size: 0.9375rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Quick Select</h4>
                        <div id="segmentOverlapList" style="display: grid; gap: 0.75rem; max-height: 520px; overflow-y: auto; padding-right: 0.5rem;">
                            <div onclick="document.getElementById('overlapSegmentSelector').value='outdoor'; updateOverlapVisualization('outdoor')" data-period="week month" class="overlap-list-item" style="padding: 1rem; background: #f0fdf4; border: 2px solid #86efac; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(16,185,129,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5rem;"></div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #166534; font-size: 0.875rem; margin-bottom: 0.125rem;">Outdoor Adventures</div>
                                        <div style="font-size: 0.75rem; color: #16a34a;">Last Week + Last Month</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 0.375rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">42%</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">5,244 overlap</div>
                                </div>
                            </div>

                            <div onclick="document.getElementById('overlapSegmentSelector').value='winter'; updateOverlapVisualization('winter')" data-period="week" class="overlap-list-item" style="padding: 1rem; background: #faf5ff; border: 2px solid #e9d5ff; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(139,92,246,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5rem;"></div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #6b21a8; font-size: 0.875rem; margin-bottom: 0.125rem;">Winter Sports Promo</div>
                                        <div style="font-size: 0.75rem; color: #9333ea;">Last Week</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 0.375rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">35%</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">4,370 overlap</div>
                                </div>
                            </div>

                            <div onclick="document.getElementById('overlapSegmentSelector').value='holiday'; updateOverlapVisualization('holiday')" data-period="month" class="overlap-list-item" style="padding: 1rem; background: #fdf2f8; border: 2px solid #fbcfe8; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(236,72,153,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5rem;"></div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #9f1239; font-size: 0.875rem; margin-bottom: 0.125rem;">Holiday Gift Guide</div>
                                        <div style="font-size: 0.75rem; color: #ec4899;">Last Month</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 0.375rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #ec4899;">52%</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">6,493 overlap</div>
                                </div>
                            </div>

                            <div onclick="document.getElementById('overlapSegmentSelector').value='premium'; updateOverlapVisualization('premium')" data-period="all" class="overlap-list-item" style="padding: 1rem; background: #fffbeb; border: 2px solid #fde68a; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(245,158,11,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5rem;"></div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #92400e; font-size: 0.875rem; margin-bottom: 0.125rem;">Premium Buyers</div>
                                        <div style="font-size: 0.75rem; color: #f59e0b;">Active</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 0.375rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">28%</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">3,496 overlap</div>
                                </div>
                            </div>

                            <div onclick="document.getElementById('overlapSegmentSelector').value='loyalty'; updateOverlapVisualization('loyalty')" data-period="all" class="overlap-list-item" style="padding: 1rem; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(59,130,246,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5rem;"></div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e40af; font-size: 0.875rem; margin-bottom: 0.125rem;">Gold Tier Loyalty</div>
                                        <div style="font-size: 0.75rem; color: #3b82f6;">Active</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 0.375rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">38%</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">4,745 overlap</div>
                                </div>
                            </div>

                            <div onclick="document.getElementById('overlapSegmentSelector').value='recentBuyers'; updateOverlapVisualization('recentBuyers')" data-period="all" class="overlap-list-item" style="padding: 1rem; background: #ecfeff; border: 2px solid #a5f3fc; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(6,182,212,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div style="font-size: 1.5rem;"></div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #155e75; font-size: 0.875rem; margin-bottom: 0.125rem;">Recent Buyers</div>
                                        <div style="font-size: 0.75rem; color: #06b6d4;">Active (30 Days)</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 0.375rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #06b6d4;">22%</div>
                                    <div style="font-size: 0.75rem; color: #6b7280;">2,747 overlap</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Fatigue Indicators (Segment-Specific) -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.75rem; margin-top: 2rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 0.75rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        Message Fatigue Indicators
                    </h3>
                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.375rem; padding: 0.5rem 1rem;">
                        <span style="font-size: 0.8125rem; color: #1e40af; font-weight: 600;"> For This Segment Only (12,487 customers)</span>
                    </div>
                </div>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1.25rem;">All metrics below show contact frequency and fatigue scores specifically for customers in this segment population</p>

                <!-- Prominent Fatigue Summary Cards -->
                <div id="fatigueCards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: #fefce8; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem; text-align: center;">
                        <div id="fatigue7days" style="font-size: 2rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">23%</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 0.25rem;">Contacted in Last 7 Days</div>
                        <div id="fatigue7daysCount" style="font-size: 0.8125rem; color: #6b7280;">2,847 customers from this segment</div>
                    </div>

                    <div style="background: #fff7ed; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem; text-align: center;">
                        <div id="fatigueHighFreq" style="font-size: 2rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">19%</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 0.25rem;">High Message Frequency</div>
                        <div id="fatigueHighFreqCount" style="font-size: 0.8125rem; color: #6b7280;">2,362 customers receiving 6+ msgs/month</div>
                    </div>

                    <div style="background: #fef2f2; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem; text-align: center;">
                        <div id="fatigueScore" style="font-size: 2rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">6.8/10</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 0.25rem;">Fatigue Risk Score</div>
                        <div id="fatigueRiskLevel" style="font-size: 0.8125rem; color: #6b7280;">Moderate-High Risk for this segment</div>
                    </div>
                </div>

                <!-- Detailed Breakdown -->
                <div id="fatigueDetails" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <!-- Contact Frequency -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;"> Contact Frequency Breakdown</div>
                        <div style="background: #f9fafb; border-radius: 0.5rem; padding: 0.875rem; margin-bottom: 0.75rem;">
                            <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem;">Of the <span id="segmentSizeText">12,487</span> customers in this segment:</div>
                        </div>
                        <div id="contactFreqDetails" style="display: grid; gap: 0.5rem; font-size: 0.8125rem; color: #6b7280;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                <span>Last 7 days:</span>
                                <strong style="color: #374151;">2,847 (23%)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                <span>Last 14 days:</span>
                                <strong style="color: #374151;">4,120 (33%)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                <span>Last 30 days:</span>
                                <strong style="color: #374151;">6,891 (55%)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                <span>Last 90 days:</span>
                                <strong style="color: #374151;">9,234 (74%)</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Message Volume -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;"> Message Volume Distribution</div>
                        <div style="background: #f9fafb; border-radius: 0.5rem; padding: 0.875rem; margin-bottom: 0.75rem;">
                            <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem;">Messages per month for this segment:</div>
                        </div>
                        <div id="msgVolumeDetails" style="display: grid; gap: 0.5rem; font-size: 0.8125rem; color: #6b7280;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                <span>Light (1-2 msgs):</span>
                                <strong style="color: #374151;">4,234 (34%)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                <span>Moderate (3-5 msgs):</span>
                                <strong style="color: #374151;">5,891 (47%)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; background: #fef2f2; padding: 0.625rem; border-radius: 0.375rem; margin-top: 0.375rem; border: 1px solid #fca5a5;">
                                <span style="font-weight: 600;"> High (6+ msgs):</span>
                                <strong style="font-size: 0.9375rem; color: #374151;">2,362 (19%)</strong>
                            </div>
                        </div>
                        <div id="msgVolumeWarning" style="margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; border: 1px solid #e5e7eb;">
                            <div style="font-size: 0.8125rem; color: #6b7280; font-weight: 500;">
                                890 customers contacted 5+ times in last 30 days
                            </div>
                        </div>
                    </div>

                    <!-- Fatigue Risk Score -->
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;"> Fatigue Risk Analysis</div>
                        
                        <div style="text-align: center; margin-bottom: 0.875rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                            <div id="fatigueScoreDetail" style="font-size: 2.5rem; font-weight: 600; color: #374151; line-height: 1;">6.8</div>
                            <div style="font-size: 0.8125rem; color: #6b7280; font-weight: 500; margin-top: 0.375rem;">out of 10</div>
                            <div id="fatigueRiskLevelDetail" style="font-size: 0.8125rem; color: #6b7280; margin-top: 0.25rem; font-weight: 500;">Moderate-High Risk</div>
                        </div>

                        <div id="fatigueWarning" style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 0.375rem; padding: 0.875rem;">
                            <div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.5;">
                                <strong> Warning:</strong> 19% of customers in this segment (2,362 people) have received high message frequency. Consider suppressing or reducing contact frequency to avoid fatigue.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI-Powered Optimization Suggestions -->
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.75rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin: 0;">Smart Optimization Suggestions</h3>
                </div>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1.25rem;">AI-recommended actions to reduce overlap and optimize activation effectiveness</p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <!-- Exclusion Suggestions -->
                    <div style="background: #f9fafb; border: 2px solid #d1d5db; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="15" y1="9" x2="9" y2="15"/>
                                <line x1="9" y1="9" x2="15" y2="15"/>
                            </svg>
                            <h4 style="font-size: 1rem; font-weight: 700; color: #374151; margin: 0;">Exclusion Suggestions</h4>
                        </div>
                        <p style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 1rem; line-height: 1.5;">Remove overlapping customers to prevent conflicts and over-messaging</p>
                        
                        <div style="display: grid; gap: 0.875rem;">
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">Exclude active VIP segment customers</div>
                                <div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.4; margin-bottom: 0.625rem;">234 customers overlap with ongoing VIP outreach</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.75rem; color: #6b7280;">Impact: -234 (1.9%)</span>
                                    <button onclick="addSuggestionFilter('In Active VIP Segment: Yes', true)" style="padding: 0.5rem 0.875rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                                        + Add
                                    </button>
                                </div>
                            </div>

                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">Exclude high-frequency contacted</div>
                                <div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.4; margin-bottom: 0.625rem;">890 customers received 5+ messages in last 30 days</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.75rem; color: #6b7280;">Impact: -890 (7.1%)</span>
                                    <button onclick="addSuggestionFilter('Contact Frequency (30 days): 5+ messages', true)" style="padding: 0.5rem 0.875rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                                        + Add
                                    </button>
                                </div>
                            </div>

                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">Exclude recent converters (14 days)</div>
                                <div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.4; margin-bottom: 0.625rem;">423 customers made recent purchases</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.75rem; color: #6b7280;">Impact: -423 (3.4%)</span>
                                    <button onclick="addSuggestionFilter('Purchase Recency: Within 14 days', true)" style="padding: 0.5rem 0.875rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                                        + Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Addition Suggestions -->
                    <div style="background: #f9fafb; border: 2px solid #d1d5db; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            <h4 style="font-size: 1rem; font-weight: 700; color: #374151; margin: 0;">Filter Addition Suggestions</h4>
                        </div>
                        <p style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 1rem; line-height: 1.5;">Add criteria to reduce overlap and create more unique segments</p>
                        
                        <div style="display: grid; gap: 0.875rem;">
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">Add Region = "West Coast"</div>
                                <div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.4; margin-bottom: 0.625rem;">Would reduce overlap with "Outdoor Adventures" by 28%</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.75rem; color: #6b7280;">Impact: -1,470 customers (11.8%)</span>
                                    <button onclick="addSuggestionFilter('Region: West Coast', false)" style="padding: 0.5rem 0.875rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                                        + Add Filter
                                    </button>
                                </div>
                            </div>

                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">Add Age Range 35-45</div>
                                <div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.4; margin-bottom: 0.625rem;">Would reduce overlap with "Holiday Gift Guide" by 22%</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.75rem; color: #6b7280;">Impact: -3,245 customers (26.0%)</span>
                                    <button onclick="addSuggestionFilter('Age Range: 35-45', false)" style="padding: 0.5rem 0.875rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                                        + Add Filter
                                    </button>
                                </div>
                            </div>

                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">Add Product Category = "Trail Running"</div>
                                <div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.4; margin-bottom: 0.625rem;">Creates more specific segment focused on trail runners</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 0.75rem; color: #6b7280;">Impact: -4,680 customers (37.5%)</span>
                                    <button onclick="addSuggestionFilter('Product Category: Trail Running', false)" style="padding: 0.5rem 0.875rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                                        + Add Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-buttons" style="justify-content: center;">
                <button class="btn-nav btn-nav-primary" onclick="closeValidationOverlay()" style="min-width: 200px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Rules
                </button>
            </div>
        </div>

        <!-- Tab 4: Activate Segment -->
        <div id="tabContent4" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Activate Your Segment</h2>
                <p class="section-description">Choose an activation template and launch your segment</p>
            </div>

            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Segment Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.375rem;">
                    <div>
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Segment Name</div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937;">High Value Outdoor Enthusiasts</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Audience Size</div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937;">12,487</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Avg. LTV</div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937;">$3,240</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.25rem;">Smart Splits</div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937;">2 Variants (50/50)</div>
                    </div>
                </div>
            </div>

            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">Select Activation Template</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1.25rem;">Choose a pre-configured template with channels and personalization attributes ready to activate</p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;">
                    <!-- Template 1: Standard Email & SMS Activation -->
                    <label style="display: block; padding: 1rem; border: 2px solid #10b981; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background: #f0fdf4; position: relative;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <input type="radio" name="activation" value="reengagement" checked style="position: absolute; top: 0.875rem; right: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.625rem;">
                            <div style="font-size: 1.5rem;"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #065f46; font-size: 0.9375rem;">Standard Email & SMS Activation</div>
                                <div style="font-size: 0.75rem; color: #166534; margin-top: 0.125rem;">GDPR-compliant multi-channel messaging</div>
                            </div>
                            <span style="background: #bbf7d0; color: #065f46; font-size: 0.625rem; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-weight: 600;">RECOMMENDED</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            <!-- Platform & Contact Points -->
                            <div style="background: white; border-radius: 0.375rem; padding: 0.625rem;">
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Platform</div>
                                <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; color: #1f2937; font-weight: 600; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem;"></span> Marketing Cloud
                                </div>
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Contact Points</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem;">
                                    <span style="background: #f3f4f6; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem;"> Email</span>
                                    <span style="background: #f3f4f6; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem;"> Mobile</span>
                                    <span style="background: #f3f4f6; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem;"> SMS</span>
                                </div>
                            </div>
                            
                            <!-- Membership & Personalization -->
                            <div style="background: white; border-radius: 0.375rem; padding: 0.625rem;">
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Membership</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem; margin-bottom: 0.5rem;">
                                    <span style="background: #ecfdf5; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #86efac; color: #065f46;"> GDPR</span>
                                    <span style="background: #ecfdf5; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #86efac; color: #065f46;"> Active</span>
                                </div>
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Personalization</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem;">
                                    <span style="background: #f3f4f6; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem;">Name</span>
                                    <span style="background: #f3f4f6; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem;">LTV</span>
                                    <span style="background: #f3f4f6; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem;">Category</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Template 2: Smart Product Recommendations -->
                    <label style="display: block; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background: white; position: relative;" onmouseover="this.style.borderColor='#6b7280'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <input type="radio" name="activation" value="emailsocial" style="position: absolute; top: 0.875rem; right: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.625rem;">
                            <div style="font-size: 1.5rem;"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #1f2937; font-size: 0.9375rem;">Smart Product Recommendations</div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.125rem;">AI-powered personalized product suggestions</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            <!-- Platform & Contact Points -->
                            <div style="background: #f9fafb; border-radius: 0.375rem; padding: 0.625rem;">
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Platform</div>
                                <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; color: #1f2937; font-weight: 600; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem;"></span> Data Cloud
                                </div>
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Contact Points</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem;">
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;"> Email</span>
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;"> Mobile</span>
                                </div>
                            </div>
                            
                            <!-- Membership & Personalization -->
                            <div style="background: #f9fafb; border-radius: 0.375rem; padding: 0.625rem;">
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Membership</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem; margin-bottom: 0.5rem;">
                                    <span style="background: #ecfdf5; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #86efac; color: #065f46;"> Active</span>
                                    <span style="background: #ecfdf5; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #86efac; color: #065f46;"> Valid Email</span>
                                </div>
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Personalization</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem;">
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;">Products</span>
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;">Browse</span>
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;">Cart</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Template 3: Premium Account Engagement -->
                    <label style="display: block; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background: white; position: relative;" onmouseover="this.style.borderColor='#6b7280'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <input type="radio" name="activation" value="vip" style="position: absolute; top: 0.875rem; right: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.625rem;">
                            <div style="font-size: 1.5rem;"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: #1f2937; font-size: 0.9375rem;">Premium Account Engagement</div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.125rem;">High-value customer outreach with account insights</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            <!-- Platform & Contact Points -->
                            <div style="background: #f9fafb; border-radius: 0.375rem; padding: 0.625rem;">
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Platform</div>
                                <div style="display: flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; color: #1f2937; font-weight: 600; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem;"></span> Data Cloud
                                </div>
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Contact Points</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem;">
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;"> Email</span>
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;"> Phone</span>
                                </div>
                            </div>
                            
                            <!-- Membership & Personalization -->
                            <div style="background: #f9fafb; border-radius: 0.375rem; padding: 0.625rem;">
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Membership</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem; margin-bottom: 0.5rem;">
                                    <span style="background: #ecfdf5; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #86efac; color: #065f46;"> GDPR</span>
                                    <span style="background: #ecfdf5; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #86efac; color: #065f46;"> Valid Email</span>
                                </div>
                                <div style="font-size: 0.625rem; font-weight: 700; color: #6b7280; margin-bottom: 0.375rem; text-transform: uppercase;">Personalization</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; font-size: 0.6875rem;">
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;">Account Value</span>
                                    <span style="background: white; padding: 0.1875rem 0.375rem; border-radius: 0.1875rem; border: 1px solid #e5e7eb;">VIP Benefits</span>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Create Custom Template -->
                    <label style="display: block; padding: 1rem; border: 2px dashed #d1d5db; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; background: white; position: relative; display: flex; align-items: center; justify-content: center; text-align: center;" onmouseover="this.style.borderColor='#6b7280'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='white'" onclick="showCustomTemplateConfig()">
                        <input type="radio" name="activation" value="custom" style="position: absolute; top: 0.875rem; right: 0.875rem;">
                        <div>
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                            <div style="font-weight: 700; color: #1f2937; font-size: 0.9375rem; margin-bottom: 0.375rem;">Create Custom Template</div>
                            <span style="background: #fef3c7; color: #92400e; font-size: 0.625rem; padding: 0.1875rem 0.5rem; border-radius: 0.1875rem; font-weight: 600; display: inline-block; margin-bottom: 0.5rem;">BUILD YOUR OWN</span>
                            <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4;">
                                Configure custom channels, filters & personalization
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Custom Template Configuration (Hidden by default) -->
            <div id="customTemplateConfig" style="display: none; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                    <button onclick="hideCustomTemplateConfig()" style="background: #f3f4f6; border: none; padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; display: flex; align-items: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937;">Configure Custom Template</h3>
                        <p style="font-size: 0.875rem; color: #6b7280;">Build your activation template with channels and personalization</p>
                    </div>
                </div>

                <!-- Step 1: Channels & Contact Points -->
                <div style="background: #fafbfc; border-left: 3px solid #bfdbfe; border-radius: 0.375rem; padding: 0.875rem 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 22px; height: 22px; background: #93c5fd; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; flex-shrink: 0;">1</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Channels & Contact Points</div>
                    </div>
                    <p style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.75rem;">Select activation platform and choose which contact points to include</p>
                    
                    <!-- Activation Platform -->
                    <div style="margin-bottom: 0.875rem;">
                        <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">Activation Platform</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 0.875rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; flex: 1;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="platform" value="mc" checked>
                                <div style="font-size: 1rem;"></div>
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #1f2937;">Marketing Cloud</div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 0.875rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; flex: 1;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="this.style.borderColor='#e5e7eb'">
                                <input type="radio" name="platform" value="dc">
                                <div style="font-size: 1rem;"></div>
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #1f2937;">Data Cloud</div>
                            </label>
                        </div>
                    </div>

                    <!-- Contact Point Selection -->
                    <div>
                        <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">Contact Point Selection</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.8125rem;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="contactPoint" value="email" checked onchange="if(this.checked) { this.parentElement.style.borderColor='#93c5fd'; this.parentElement.style.background='#f0f9ff'; } else { this.parentElement.style.borderColor='#e5e7eb'; this.parentElement.style.background='white'; }">
                                <div></div>
                                <div style="font-weight: 600; color: #1f2937;">Email</div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.8125rem;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="contactPoint" value="phone" checked onchange="if(this.checked) { this.parentElement.style.borderColor='#93c5fd'; this.parentElement.style.background='#f0f9ff'; } else { this.parentElement.style.borderColor='#e5e7eb'; this.parentElement.style.background='white'; }">
                                <div></div>
                                <div style="font-weight: 600; color: #1f2937;">Phone</div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.8125rem;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="contactPoint" value="mobile" checked onchange="if(this.checked) { this.parentElement.style.borderColor='#93c5fd'; this.parentElement.style.background='#f0f9ff'; } else { this.parentElement.style.borderColor='#e5e7eb'; this.parentElement.style.background='white'; }">
                                <div></div>
                                <div style="font-weight: 600; color: #1f2937;">Mobile</div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.8125rem;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="contactPoint" value="sms" onchange="if(this.checked) { this.parentElement.style.borderColor='#93c5fd'; this.parentElement.style.background='#f0f9ff'; } else { this.parentElement.style.borderColor='#e5e7eb'; this.parentElement.style.background='white'; }">
                                <div></div>
                                <div style="font-weight: 600; color: #1f2937;">SMS</div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.8125rem;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="contactPoint" value="push" onchange="if(this.checked) { this.parentElement.style.borderColor='#93c5fd'; this.parentElement.style.background='#f0f9ff'; } else { this.parentElement.style.borderColor='#e5e7eb'; this.parentElement.style.background='white'; }">
                                <div></div>
                                <div style="font-weight: 600; color: #1f2937;">Push</div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.8125rem;" onmouseover="this.style.borderColor='#93c5fd'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='#e5e7eb'">
                                <input type="checkbox" name="contactPoint" value="whatsapp" onchange="if(this.checked) { this.parentElement.style.borderColor='#93c5fd'; this.parentElement.style.background='#f0f9ff'; } else { this.parentElement.style.borderColor='#e5e7eb'; this.parentElement.style.background='white'; }">
                                <div></div>
                                <div style="font-weight: 600; color: #1f2937;">WhatsApp</div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Activation Membership Filtering -->
                <div style="background: #fafbfc; border-left: 3px solid #ddd6fe; border-radius: 0.375rem; padding: 0.875rem 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 22px; height: 22px; background: #c4b5fd; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; flex-shrink: 0;">2</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Activation Membership Filtering</div>
                    </div>
                    <p style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.75rem;">Apply compliance and membership filters</p>
                    
                    <!-- Quick Safety Filters -->
                    <div style="margin-bottom: 0.75rem;">
                        <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.375rem;">Quick Safety Filters</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="gdpr">
                                <span style="font-weight: 600;"> GDPR</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="active_subs">
                                <span style="font-weight: 600;"> Active Subscribers</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="ccpa">
                                <span style="font-weight: 600;"> CCPA</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="email_consent">
                                <span style="font-weight: 600;"> Email Consent</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="exclude_unsubs">
                                <span style="font-weight: 600;"> Exclude Unsubs</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="no_contact_7days">
                                <span style="font-weight: 600;"> No Contact 7d</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="sms_consent">
                                <span style="font-weight: 600;"> SMS Consent</span>
                            </label>
                            <label style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-size: 0.75rem;" onmouseover="this.style.borderColor='#a7f3d0'" onmouseout="if(!this.querySelector('input').checked) {this.style.borderColor='#e5e7eb'}">
                                <input type="checkbox" name="safety" value="valid_email">
                                <span style="font-weight: 600;"> Valid Email</span>
                            </label>
                        </div>
                    </div>

                    <!-- Add Custom Filter -->
                    <button onclick="showActivationFilterModal()" style="background: white; border: 1px solid #d1d5db; color: #374151; padding: 0.5rem 0.875rem; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.375rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Custom Filter
                    </button>
                </div>

                <!-- Step 3: Personalization Attributes -->
                <div style="background: #fafbfc; border-left: 3px solid #bbf7d0; border-radius: 0.375rem; padding: 0.875rem 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 22px; height: 22px; background: #86efac; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; flex-shrink: 0;">3</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">Add Personalization Attributes & Metrics</div>
                    </div>
                    <p style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.75rem;">Select attributes to personalize your messages</p>
                    
                    <!-- Selected Attributes -->
                    <div id="selectedAttributes" style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.625rem;">
                        <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
                            <input type="checkbox" name="attribute" value="name" checked>
                            <span>Customer Name</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
                            <input type="checkbox" name="attribute" value="ltv" checked>
                            <span>LTV Tier</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.4375rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
                            <input type="checkbox" name="attribute" value="loyalty" checked>
                            <span>Loyalty Status</span>
                        </label>
                    </div>

                    <button onclick="showAllAttributesForPersonalization()" style="background: white; border: 1px solid #d1d5db; color: #374151; padding: 0.5rem 0.875rem; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                        + Browse All Attributes
                    </button>
                </div>

                <!-- Save Template Button -->
                <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.75rem;">
                    <button onclick="hideCustomTemplateConfig()" style="background: white; border: 1px solid #d1d5db; color: #374151; padding: 0.5625rem 1.125rem; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveCustomTemplate()" style="background: linear-gradient(135deg, #1d72f3 0%, #1e40af 100%); color: white; border: none; padding: 0.5625rem 1.125rem; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                        Save & Use Template
                    </button>
                </div>
            </div>

            <!-- Journey Configuration (Optional Separate Section) -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; display: inline-flex; align-items: center; gap: 0.5rem;">
                            Configure Journey
                            <span style="background: #fef3c7; color: #92400e; font-size: 0.6875rem; padding: 0.25rem 0.625rem; border-radius: 0.25rem; font-weight: 600;">OPTIONAL</span>
                        </h3>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Define multi-step journeys based on customer actions and responses</p>
                    </div>
                    <button onclick="toggleJourneyConfig()" id="journeyToggleBtn" style="background: #1d72f3; color: white; border: none; padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
                        Configure Journey
                    </button>
                </div>

                <!-- Journey Configuration Panel (Hidden by default) -->
                <div id="journeyConfigPanel" style="display: none;">
                    <!-- Pre-configured Journey Templates -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #0c4a6e; margin-bottom: 1rem;"> Select a Pre-configured Journey</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.875rem;">
                            <button onclick="applyJourneyTemplate('engagement')" style="background: white; border: 1px solid #93c5fd; border-radius: 0.375rem; padding: 1rem; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1d72f3'; this.style.boxShadow='0 2px 8px rgba(29, 114, 243, 0.15)'" onmouseout="this.style.borderColor='#93c5fd'; this.style.boxShadow='none'">
                                <div style="font-weight: 600; color: #1f2937; font-size: 0.9375rem; margin-bottom: 0.375rem;"> Email Engagement Flow</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4;">Email  Wait 24h  If opened  WhatsApp  If not  Meta Ads</div>
                            </button>
                            <button onclick="applyJourneyTemplate('winback')" style="background: white; border: 1px solid #93c5fd; border-radius: 0.375rem; padding: 1rem; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1d72f3'; this.style.boxShadow='0 2px 8px rgba(29, 114, 243, 0.15)'" onmouseout="this.style.borderColor='#93c5fd'; this.style.boxShadow='none'">
                                <div style="font-weight: 600; color: #1f2937; font-size: 0.9375rem; margin-bottom: 0.375rem;"> Win-back Journey</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4;">Email  Wait 48h  SMS  Wait 24h  Push notification</div>
                            </button>
                            <button onclick="applyJourneyTemplate('nurture')" style="background: white; border: 1px solid #93c5fd; border-radius: 0.375rem; padding: 1rem; text-align: left; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1d72f3'; this.style.boxShadow='0 2px 8px rgba(29, 114, 243, 0.15)'" onmouseout="this.style.borderColor='#93c5fd'; this.style.boxShadow='none'">
                                <div style="font-weight: 600; color: #1f2937; font-size: 0.9375rem; margin-bottom: 0.375rem;"> Nurture Flow</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4;">Email series  Week 1  Week 2  Week 3  CRM sync</div>
                            </button>
                            <button onclick="showCustomJourneyBuilder()" style="background: white; border: 2px dashed #93c5fd; border-radius: 0.375rem; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#1d72f3'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#93c5fd'; this.style.background='white'">
                                <div style="font-weight: 600; color: #1d72f3; font-size: 0.9375rem; margin-bottom: 0.375rem;"> Build Custom Journey</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4;">Create your own step-by-step workflow</div>
                            </button>
                        </div>
                    </div>

                    <!-- Custom Journey Builder (Hidden by default) -->
                    <div id="customJourneyBuilder" style="display: none; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Build Custom Journey</div>
                        
                        <!-- Suggested Steps -->
                        <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.8125rem; font-weight: 600; color: #0c4a6e; margin-bottom: 0.75rem;"> Quick Add Suggested Steps</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button onclick="addSuggestedJourneyStep('email-send')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     Send Email
                                </button>
                                <button onclick="addSuggestedJourneyStep('wait-24h')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     Wait 24 hours
                                </button>
                                <button onclick="addSuggestedJourneyStep('check-email-open')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     If Email Opened
                                </button>
                                <button onclick="addSuggestedJourneyStep('send-whatsapp')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     Send WhatsApp
                                </button>
                                <button onclick="addSuggestedJourneyStep('check-click')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     If Clicked
                                </button>
                                <button onclick="addSuggestedJourneyStep('activate-meta-ads')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     Activate Meta Ads
                                </button>
                                <button onclick="addSuggestedJourneyStep('send-sms')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     Send SMS
                                </button>
                                <button onclick="addSuggestedJourneyStep('sync-crm')" style="background: white; border: 1px solid #93c5fd; color: #1e40af; padding: 0.5rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='white'">
                                     Sync to CRM
                                </button>
                            </div>
                        </div>
                        
                        <!-- Journey Steps -->
                        <div id="journeySteps" style="margin-bottom: 1rem;">
                            <!-- Journey steps will be added here dynamically -->
                            <div style="background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 0.375rem; padding: 1rem; text-align: center; color: #6b7280; font-size: 0.875rem;">
                                No steps added yet. Click a suggested step above or define your own.
                            </div>
                        </div>
                        
                        <button onclick="addCustomJourneyStep()" style="background: #1d72f3; color: white; border: none; padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer;">
                            + Add Custom Step
                        </button>
                    </div>
                </div>
            </div>

            <div style="text-align: center; padding: 2rem 0;">
                <button onclick="activateSegment()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 1.125rem; font-weight: 600; padding: 1rem 3rem; border: none; border-radius: 0.5rem; cursor: pointer; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(16, 185, 129, 0.3)'">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="8 12 12 16 16 12"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                        </svg>
                        <span>Activate Segment</span>
                    </div>
                </button>
                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 1rem;">Activation will begin immediately and respect the selected channel send times</div>
            </div>

            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 1.25rem;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <div style="font-size: 0.875rem; color: #1e40af; line-height: 1.6;">
                        <strong>Pro Tip:</strong> Multi-Channel Activation template is recommended based on your segment's channel affinity data. This approach leverages the best send times for each channel to maximize engagement.
                    </div>
                </div>
            </div>

            <div class="nav-buttons">
                <button class="btn-nav btn-nav-secondary" onclick="switchTab(3)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
            </div>
        </div>

        <!-- Tab 5: Segment Performance -->
        <div id="tabContent5" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">Segment Performance</h2>
                <p class="section-description">Comprehensive analysis of activation effectiveness and ROI</p>
            </div>

            <!-- A. Activation Summary Dashboard -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Activation Summary Dashboard</h3>
                
                <!-- Top-level KPIs -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.25rem;">
                    <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem; text-align: center;">
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Total Reached</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: #1f2937;">12,487</div>
                        <div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem;"> 100% of segment</div>
                    </div>
                    <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem; text-align: center;">
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Engagement Rate</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;">42.8%</div>
                        <div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem;"> +8.6% vs avg</div>
                    </div>
                    <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem; text-align: center;">
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Conversion Rate</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;">16.4%</div>
                        <div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem;"> +4.5% vs goal</div>
                    </div>
                    <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.625rem; padding: 1rem; text-align: center;">
                        <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Revenue Generated</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: #1f2937;">$156K</div>
                        <div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem;"> +$18K vs plan</div>
                    </div>
                    <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 0.625rem; padding: 1rem; text-align: center;">
                        <div style="font-size: 0.8125rem; color: #166534; margin-bottom: 0.5rem;">ROI</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: #15803d;">4.2x</div>
                        <div style="font-size: 0.75rem; color: #166534; margin-top: 0.25rem;">$37K activation cost</div>
                    </div>
                </div>

                <!-- Success Indicators -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.875rem;">
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; padding: 0.875rem; display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; color: #166534;">Exceeding Target</div>
                            <div style="font-size: 0.8125rem; color: #16a34a;">Conversion +24% above goal</div>
                        </div>
                    </div>
                    <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 0.5rem; padding: 0.875rem; display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <div style="font-size: 1.25rem; color: white; font-weight: 700;">~</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; color: #92400e;">On Target</div>
                            <div style="font-size: 0.8125rem; color: #b45309;">Revenue within 5% of plan</div>
                        </div>
                    </div>
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; padding: 0.875rem; display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                                <polyline points="17 6 23 6 23 12"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; color: #1e40af;">Strong Momentum</div>
                            <div style="font-size: 0.8125rem; color: #2563eb;">Engagement trending up +12%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B. Engagement Analysis -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Engagement Analysis</h3>
                
                <!-- Engagement by Channel -->
                <div style="background: #f9fafb; border-radius: 0.625rem; padding: 1.25rem; margin-bottom: 1.25rem;">
                    <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Channel Performance</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Email</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Open Rate</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">48.2%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Click Rate</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">12.4%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">CTOR</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;">25.7%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Mobile Push</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Delivered</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">94.8%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Click Rate</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;">18.2%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Conversion</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;">22.1%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">SMS</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Delivered</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">98.1%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Click Rate</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">8.7%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Opt-out</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #ef4444;">0.8%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">WhatsApp</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Delivered</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">96.3%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Read Rate</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;">82.4%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Response Rate</span>
                                <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;">14.5%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Engagement by Segment Characteristics -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div style="background: #f9fafb; border-radius: 0.625rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.875rem;">Performance by LTV Tier</div>
                        <div style="display: flex; flex-direction: column; gap: 0.625rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">High LTV</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 68%; height: 100%; background: #10b981;"></div>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">68%</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Medium LTV</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 42%; height: 100%; background: #3b82f6;"></div>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">42%</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Low LTV</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 28%; height: 100%; background: #6b7280;"></div>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">28%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="background: #f9fafb; border-radius: 0.625rem; padding: 1rem;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.875rem;">Performance by Region</div>
                        <div style="display: flex; flex-direction: column; gap: 0.625rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">West Coast</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 58%; height: 100%; background: #10b981;"></div>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">58%</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">East Coast</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 45%; height: 100%; background: #3b82f6;"></div>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">45%</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.8125rem; color: #6b7280;">Other</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                        <div style="width: 32%; height: 100%; background: #6b7280;"></div>
                                    </div>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">32%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- C. Conversion Analytics -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Conversion Analytics</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.25rem;">
                    <!-- Conversion Funnel -->
                    <div style="background: #f9fafb; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Conversion Funnel</div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">Reached</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">12,487 (100%)</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 100%; height: 100%; background: #3b82f6;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">Engaged</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">5,344 (42.8%)</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 42.8%; height: 100%; background: #6366f1;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">Visited Site</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">3,124 (25.0%)</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 25%; height: 100%; background: #8b5cf6;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">Added to Cart</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;">2,456 (19.7%)</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 19.7%; height: 100%; background: #a855f7;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">Purchased</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;">2,048 (16.4%)</span>
                                </div>
                                <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 16.4%; height: 100%; background: #10b981;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Impact -->
                    <div style="background: #f9fafb; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Revenue Impact</div>
                        <div style="display: grid; gap: 0.875rem;">
                            <div style="background: white; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem;">Total Revenue</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">$156,360</div>
                            </div>
                            <div style="background: white; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem;">Revenue per Recipient</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">$12.52</div>
                            </div>
                            <div style="background: white; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem;">Average Order Value</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">$76.35</div>
                            </div>
                            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; padding: 0.875rem;">
                                <div style="font-size: 0.8125rem; color: #166534; margin-bottom: 0.375rem;">Incremental Revenue</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #15803d;">+$24.8K</div>
                                <div style="font-size: 0.75rem; color: #16a34a;">vs control group</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Efficiency -->
                <div style="background: #f9fafb; border-radius: 0.625rem; padding: 1.25rem;">
                    <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Cost Efficiency</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Cost per Acquisition</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">$18.17</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Cost per Conversion</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">$2.98</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.5rem;">Incremental CPA</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">$14.23</div>
                        </div>
                        <div style="text-align: center; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; padding: 0.75rem;">
                            <div style="font-size: 0.8125rem; color: #166534; margin-bottom: 0.5rem;">ROI</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #15803d;">4.2x</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- D. Cohort & Drift Analysis -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Cohort & Drift Analysis</h3>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    <!-- Composition Drift -->
                    <div style="background: #f9fafb; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">Composition Drift Over Time</div>
                        <div style="display: grid; gap: 0.875rem;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">LTV Distribution Shift</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;"> +3.2% High LTV</span>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">High-value customers increased from 42% to 45% during activation</div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">Engagement Level Change</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #ef4444;"> -5.1% Dormant</span>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">Dormant customers decreased, moved to active engagement tiers</div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.8125rem; color: #6b7280;">Churn Risk Progression</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;"> -8.3% High Risk</span>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">High churn risk segment reduced from 23% to 15%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Segment Health Score -->
                    <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #166534; margin-bottom: 1rem;">Segment Health Score</div>
                        <div style="text-align: center; margin-bottom: 1.25rem;">
                            <div style="font-size: 3.5rem; font-weight: 700; color: #15803d;">8.4</div>
                            <div style="font-size: 0.9375rem; color: #16a34a; font-weight: 600;">Excellent Health</div>
                        </div>
                        <div style="display: grid; gap: 0.625rem; font-size: 0.8125rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #166534;">Engagement Vitality</span>
                                <span style="font-weight: 600; color: #15803d;">9.2 / 10</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #166534;">Value Stability</span>
                                <span style="font-weight: 600; color: #15803d;">8.8 / 10</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #166534;">Growth Potential</span>
                                <span style="font-weight: 600; color: #15803d;">7.2 / 10</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- E. Comparative Performance -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Comparative Performance</h3>
                
                <div style="display: grid; gap: 1rem;">
                    <!-- vs Other Segments -->
                    <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.875rem;">
                            <div>
                                <div style="font-weight: 600; color: #166534; font-size: 0.9375rem; margin-bottom: 0.25rem;">vs. Outdoor Adventure Segment (Last Month)</div>
                                <div style="font-size: 0.8125rem; color: #16a34a;">Similar audience profile  Dec 1-24, 2025</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">+24%</div>
                                <div style="font-size: 0.75rem; color: #166534;">Better conversion</div>
                            </div>
                        </div>
                        <div style="font-size: 0.8125rem; color: #166534; line-height: 1.5;">
                            Your segment achieved 16.4% conversion vs. 13.2% in Outdoor Adventure. Refined targeting and mobile push strategy drove superior results.
                        </div>
                    </div>

                    <!-- vs Historical Activations -->
                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.875rem;">
                            <div>
                                <div style="font-weight: 600; color: #1e40af; font-size: 0.9375rem; margin-bottom: 0.25rem;">vs. 6-Month Activation Average</div>
                                <div style="font-size: 0.8125rem; color: #3b82f6;">Baseline across all segment types</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">+38%</div>
                                <div style="font-size: 0.75rem; color: #1e40af;">Above average</div>
                            </div>
                        </div>
                        <div style="font-size: 0.8125rem; color: #1e40af; line-height: 1.5;">
                            Significantly outperformed 6-month average (11.9% conversion). GRL refinement, smart splits, and optimal channel timing drove exceptional results.
                        </div>
                    </div>

                    <!-- vs Control Group -->
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 0.625rem; padding: 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.875rem;">
                            <div>
                                <div style="font-weight: 600; color: #92400e; font-size: 0.9375rem; margin-bottom: 0.25rem;">vs. Control Group (Holdout)</div>
                                <div style="font-size: 0.8125rem; color: #b45309;">3,000 customers not contacted  Natural behavior</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">+186%</div>
                                <div style="font-size: 0.75rem; color: #92400e;">Incremental lift</div>
                            </div>
                        </div>
                        <div style="font-size: 0.8125rem; color: #92400e; line-height: 1.5;">
                            Activated segment converted at 16.4% vs. 5.7% natural conversion in control group, demonstrating strong incremental impact.
                        </div>
                    </div>
                </div>
            </div>

            <!-- F. Optimization Recommendations -->
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem;">Optimization Recommendations</h3>
                
                <div style="display: grid; gap: 1.25rem;">
                    <!-- Audience Optimization -->
                    <div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937; margin-bottom: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Audience Optimization
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.875rem;">
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Include More</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">West Coast customers show +22% higher conversion</div>
                            </div>
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Exclude Next Time</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">Customers with 5+ messages/month show fatigue</div>
                            </div>
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Lookalike Opportunity</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">Expand by 8-10K similar customers</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tactical Improvements -->
                    <div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937; margin-bottom: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                            Tactical Improvements
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.875rem;">
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Best Channel</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">Mobile Push: 22.1% conversion (highest)</div>
                            </div>
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Optimal Timing</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">6:30-7:00 PM shows +8% lift in open rate</div>
                            </div>
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                                <div style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Creative Insight</div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.5;">Discount messaging outperformed by 4.2%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Next Segment Suggestions -->
                    <div>
                        <div style="font-size: 0.9375rem; font-weight: 600; color: #1f2937; margin-bottom: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                            Next Segment Suggestions
                        </div>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.375rem;">
                                <div style="font-weight: 600; color: #166534; margin-bottom: 0.375rem;">Re-engage Non-Responders</div>
                                <div style="font-size: 0.8125rem; color: #16a34a; line-height: 1.5;">Create follow-up for 4,244 customers who didn't engage. Try different messaging or channel.</div>
                            </div>
                            <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 0.375rem;">
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.375rem;">Win-Back Opportunity</div>
                                <div style="font-size: 0.8125rem; color: #2563eb; line-height: 1.5;">408 customers added to cart but didn't purchase. Target with urgency messaging + 10% discount.</div>
                            </div>
                            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.375rem;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 0.375rem;">Exclusion for Rest Period</div>
                                <div style="font-size: 0.8125rem; color: #b45309; line-height: 1.5;">Suppress 2,048 converters for 30 days to allow product experience before next outreach.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <div class="nav-buttons">
                <button class="btn-nav btn-nav-secondary" onclick="switchTab(4)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 0;
        let currentAudience = 12487;
        let addedFilters = [];

        // Agentic conversation variables
        let selectedGoal = '';
        let userOriginalGoal = ''; // Store user's original custom goal text for display
        let followupAnswers = {};
        let currentQuestionIndex = 0;
        let goalQuestionFlow = [];
        let currentFlow = null; // Store the current goal flow (including strategies)

        // Sophisticated question flows for each goal
        const goalQuestionFlows = {
            'Churn Prevention': {
                questions: [
                    {
                        text: 'How should I identify customers at risk of churning?',
                        options: [
                            { label: 'No purchase in 90+ days', value: 'no_purchase_90' },
                            { label: 'Declining engagement (fewer opens/clicks)', value: 'declining_engagement' },
                            { label: 'Subscription nearing renewal', value: 'renewal' },
                            { label: 'Low product usage frequency', value: 'low_usage' }
                        ]
                    },
                    {
                        text: 'Which customers should I prioritize for retention?',
                        options: [
                            { label: 'High lifetime value customers only', value: 'high_ltv' },
                            { label: 'Recent customers (< 6 months tenure)', value: 'recent' },
                            { label: 'Long-term customers (> 1 year)', value: 'longterm' },
                            { label: 'All at-risk customers', value: 'all' }
                        ]
                    }
                ],
                strategies: [
                    {
                        name: 'Strategy A (High-Value Retention)',
                        description: 'Top 20% LTV + declining activity + early warning signals',
                        details: 'Focus on most valuable relationships',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Broad Prevention)',
                        description: 'All at-risk + medium+ engagement history',
                        details: 'Wider net, proactive approach',
                        icon: ''
                    }
                ]
            },
            'Win-back': {
                questions: [
                    {
                        text: 'How long have these customers been inactive?',
                        options: [
                            { label: 'Recently lapsed (30-90 days)', value: 'recent_lapsed' },
                            { label: 'Moderately lapsed (90-180 days)', value: 'moderate_lapsed' },
                            { label: 'Long lapsed (180+ days)', value: 'long_lapsed' },
                            { label: 'Subscription canceled', value: 'canceled' }
                        ]
                    },
                    {
                        text: 'What past behavior indicates they might return?',
                        options: [
                            { label: 'High historical purchase frequency', value: 'frequent_past' },
                            { label: 'Strong past engagement (opens/clicks)', value: 'engaged_past' },
                            { label: 'High average order value', value: 'high_aov' },
                            { label: 'Multiple product categories purchased', value: 'multi_category' }
                        ]
                    }
                ],
                strategies: [
                    {
                        name: 'Strategy A (High-Recovery Potential)',
                        description: 'Recently lapsed + high past engagement + top 30% LTV',
                        details: 'Highest likelihood to return',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Volume Win-back)',
                        description: 'All lapsed (30-180 days) + any past purchases',
                        details: 'Broader reach, build pipeline',
                        icon: ''
                    }
                ]
            },
            'Growth & Monetization': {
                questions: [
                    {
                        text: 'What defines a customer with growth potential?',
                        options: [
                            { label: 'Active but low average order value', value: 'low_aov_active' },
                            { label: 'Single category buyers (room to expand)', value: 'single_category' },
                            { label: 'Infrequent but high-value purchases', value: 'low_freq_high_value' },
                            { label: 'Loyal customers not on premium tier', value: 'non_premium' }
                        ]
                    },
                    {
                        text: 'What growth metric matters most to you?',
                        options: [
                            { label: 'Increase purchase frequency', value: 'frequency' },
                            { label: 'Increase average order value', value: 'aov' },
                            { label: 'Expand to new categories', value: 'categories' },
                            { label: 'Upgrade to premium/subscription', value: 'upgrade' }
                        ]
                    }
                ],
                strategies: [
                    {
                        name: 'Strategy A (High-Intent Expansion)',
                        description: 'Active buyers + single category + high engagement',
                        details: 'Ready for cross-sell opportunities',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Volume Growth)',
                        description: 'All active + below median AOV or frequency',
                        details: 'Broad growth opportunity',
                        icon: ''
                    }
                ]
            },
            'Acquisition': {
                questions: [
                    {
                        text: 'What characteristics define your ideal new customer?',
                        options: [
                            { label: 'Similar to top 10% lifetime value customers', value: 'top_ltv' },
                            { label: 'Similar to most engaged customers', value: 'engaged' },
                            { label: 'Similar to customers who convert fast', value: 'fast_convert' },
                            { label: 'Similar to loyal repeat buyers', value: 'loyal' }
                        ]
                    },
                    {
                        text: 'Should I focus on specific demographics or behaviors?',
                        options: [
                            { label: 'Demographics (age, location, income)', value: 'demographics' },
                            { label: 'Behaviors (interests, online activity)', value: 'behaviors' },
                            { label: 'Purchase signals (intent, cart activity)', value: 'purchase_signals' },
                            { label: 'All characteristics combined', value: 'combined' }
                        ]
                    }
                ],
                strategies: [
                    {
                        name: 'Strategy A (Quality-First)',
                        description: 'Lookalike to top 5% LTV + strong match on all signals',
                        details: 'Smaller, high-quality prospects',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Scale-First)',
                        description: 'Lookalike to top 20% + broader match criteria',
                        details: 'Larger prospect pool, good fit',
                        icon: ''
                    }
                ]
            },
            'Service Led Marketing': {
                questions: [
                    {
                        text: 'What service issue signals should I look for?',
                        options: [
                            { label: 'Recent support case opened (< 14 days)', value: 'recent_case' },
                            { label: 'Multiple cases in short time period', value: 'multiple_cases' },
                            { label: 'Low satisfaction/NPS score', value: 'low_satisfaction' },
                            { label: 'Unresolved or escalated case', value: 'unresolved' }
                        ]
                    },
                    {
                        text: 'Which customers need priority attention?',
                        options: [
                            { label: 'High-value customers with any issue', value: 'high_value_any' },
                            { label: 'Customers with severe/critical issues', value: 'critical_issues' },
                            { label: 'At-risk of churn based on service history', value: 'churn_risk' },
                            { label: 'All customers with open cases', value: 'all_cases' }
                        ]
                    }
                ],
                strategies: [
                    {
                        name: 'Strategy A (Critical Care)',
                        description: 'High LTV + multiple/unresolved cases + low satisfaction',
                        details: 'Immediate intervention, save relationship',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Proactive Service)',
                        description: 'Any value + recent case + opportunity for improvement',
                        details: 'Build trust, improve experience',
                        icon: ''
                    }
                ]
            },
            'Cross-sell & Upsell': {
                questions: [
                    {
                        text: 'Which products to recommend?',
                        options: [
                            { label: 'Based on purchase history', value: 'history' },
                            { label: 'Based on browsing behavior', value: 'browsing' },
                            { label: 'Best-selling complementary items', value: 'bestsellers' },
                            { label: 'AI-recommended bundles', value: 'ai_bundles' }
                        ]
                    },
                    {
                        text: 'Target customers based on?',
                        options: [
                            { label: 'Recent purchasers (< 30 days)', value: 'recent' },
                            { label: 'Repeat buyers', value: 'repeat' },
                            { label: 'High lifetime value', value: 'high_ltv' }
                        ]
                    }
                ],
                strategies: [
                    {
                        name: 'Strategy A (AI-Optimized)',
                        description: 'High LTV + AI product recommendations + recent activity',
                        details: 'Highest conversion probability',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Proven Winners)',
                        description: 'Repeat buyers + best-selling combos + bundle offers',
                        details: 'Larger volume, proven success',
                        icon: ''
                    }
                ]
            }
        };

        // Dynamic questions based on goal
        const goalQuestions = {
            'Re-engage dormant customers': {
                q1: {
                    text: 'How long has it been since their last purchase?',
                    options: [
                        { emoji: '', text: '30-90 days', value: '30-90 days' },
                        { emoji: '', text: '3-6 months', value: '3-6 months' },
                        { emoji: '', text: '6-12 months', value: '6-12 months' },
                        { emoji: '', text: '1+ year', value: '1+ year' }
                    ]
                },
                q2: {
                    text: 'What incentive would work best?',
                    options: [
                        { emoji: '', text: 'Discount offer', value: 'Discount offer' },
                        { emoji: '', text: 'Free gift', value: 'Free gift' },
                        { emoji: '', text: 'Loyalty points', value: 'Loyalty points' },
                        { emoji: '', text: 'Free shipping', value: 'Free shipping' }
                    ]
                }
            },
            'Target high-value customers': {
                q1: {
                    text: 'How do you define "high-value" for this segment?',
                    options: [
                        { emoji: '', text: 'Top 10% spenders', value: 'Top 10% spenders' },
                        { emoji: '', text: 'Lifetime value >$1K', value: 'High LTV' },
                        { emoji: '', text: 'Frequent buyers', value: 'Frequent buyers' },
                        { emoji: '', text: 'Premium product buyers', value: 'Premium buyers' }
                    ]
                },
                q2: {
                    text: 'What type of exclusive offer are you planning?',
                    options: [
                        { emoji: '', text: 'Early access', value: 'Early access' },
                        { emoji: '', text: 'VIP discount', value: 'VIP discount' },
                        { emoji: '', text: 'Limited edition', value: 'Limited edition' },
                        { emoji: '', text: 'Upgrade benefits', value: 'Upgrade benefits' }
                    ]
                }
            },
            'Welcome new customers': {
                q1: {
                    text: 'How recently did they join?',
                    options: [
                        { emoji: '', text: 'Last 7 days', value: 'Last 7 days' },
                        { emoji: '', text: 'Last 30 days', value: 'Last 30 days' },
                        { emoji: '', text: 'Last 60 days', value: 'Last 60 days' },
                        { emoji: '', text: 'Last 90 days', value: 'Last 90 days' }
                    ]
                },
                q2: {
                    text: 'What\'s your primary onboarding goal?',
                    options: [
                        { emoji: '', text: 'First purchase', value: 'First purchase' },
                        { emoji: '', text: 'App download', value: 'App download' },
                        { emoji: '', text: 'Profile completion', value: 'Profile completion' },
                        { emoji: '', text: 'Engagement', value: 'Engagement' }
                    ]
                }
            },
            'Promote seasonal activation': {
                q1: {
                    text: 'Which season or event are you targeting?',
                    options: [
                        { emoji: '', text: 'Winter/Holiday', value: 'Winter' },
                        { emoji: '', text: 'Spring', value: 'Spring' },
                        { emoji: '', text: 'Summer', value: 'Summer' },
                        { emoji: '', text: 'Fall/Back-to-School', value: 'Fall' }
                    ]
                },
                q2: {
                    text: 'How urgent is this activation?',
                    options: [
                        { emoji: '', text: 'Flash sale (24-48h)', value: 'Flash sale' },
                        { emoji: '', text: 'Weekend promo', value: 'Weekend promo' },
                        { emoji: '', text: 'Week-long', value: 'Week-long' },
                        { emoji: '', text: 'Month-long', value: 'Month-long' }
                    ]
                }
            },
            'Upsell to existing customers': {
                q1: {
                    text: 'What product tier are you upselling to?',
                    options: [
                        { emoji: '', text: 'Next tier up', value: 'Next tier' },
                        { emoji: '', text: 'Premium tier', value: 'Premium tier' },
                        { emoji: '', text: 'Bundle/Package', value: 'Bundle' },
                        { emoji: '', text: 'Add-ons', value: 'Add-ons' }
                    ]
                },
                q2: {
                    text: 'Based on what customer behavior?',
                    options: [
                        { emoji: '', text: 'Repeat purchases', value: 'Repeat purchases' },
                        { emoji: '', text: 'Product views', value: 'Product views' },
                        { emoji: '', text: 'High spend', value: 'High spend' },
                        { emoji: '', text: 'Product ratings', value: 'Engagement' }
                    ]
                }
            },
            'Reduce churn risk': {
                q1: {
                    text: 'What signals indicate churn risk?',
                    options: [
                        { emoji: '', text: 'Declining activity', value: 'Declining activity' },
                        { emoji: '', text: 'No recent login', value: 'No login' },
                        { emoji: '', text: 'Abandoned carts', value: 'Abandoned carts' },
                        { emoji: '', text: 'Cancellation intent', value: 'Cancel intent' }
                    ]
                },
                q2: {
                    text: 'What retention strategy will you use?',
                    options: [
                        { emoji: '', text: 'Win-back discount', value: 'Discount' },
                        { emoji: '', text: 'Personal outreach', value: 'Outreach' },
                        { emoji: '', text: 'Surprise gift', value: 'Gift' },
                        { emoji: '', text: 'Value reminder', value: 'Value reminder' }
                    ]
                }
            },
            'default': {
                q1: {
                    text: 'What\'s your primary success metric for this segment?',
                    options: [
                        { emoji: '', text: 'Conversions', value: 'Increase conversions' },
                        { emoji: '', text: 'Engagement', value: 'Boost engagement' },
                        { emoji: '', text: 'Retention', value: 'Improve retention' },
                        { emoji: '', text: 'Revenue', value: 'Grow revenue' }
                    ]
                },
                q2: {
                    text: 'What timeframe should I focus on?',
                    options: [
                        { emoji: '', text: '30 days', value: 'Last 30 days' },
                        { emoji: '', text: '90 days', value: 'Last 90 days' },
                        { emoji: '', text: '6 months', value: 'Last 6 months' },
                        { emoji: '', text: '1 year+', value: 'Last year' }
                    ]
                }
            }
        };

        function selectGoal(goalTitle) {
            selectedGoal = goalTitle;
            userOriginalGoal = ''; // Clear custom goal since this is auto-suggested
            showFollowupQuestions();
            
            // Scroll to top to show the agent conversation
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        function startWithCustomGoal() {
            const customInput = document.getElementById('customGoalInput');
            const goal = customInput.value.trim();
            
            if (!goal) {
                alert('Please enter your goal');
                return;
            }
            
            // Store the original user input for display and semantic analysis
            userOriginalGoal = goal;
            selectedGoal = goal;
            
            // Analyze custom goal and map to appropriate flow
            const detectedGoal = detectGoalIntent(goal);
            if (detectedGoal && goalQuestionFlows[detectedGoal]) {
                // Use detected goal's question flow but keep original custom text
                selectedGoal = detectedGoal;
                showFollowupQuestions();
            } else {
                // No specific flow detected - generate contextual flow
                showFollowupQuestions();
            }
            
            // Scroll to top to show the agent conversation
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        function detectGoalIntent(goalText) {
            const lowerGoal = goalText.toLowerCase();
            
            // Win-back keywords (check first before churn)
            if (lowerGoal.includes('win back') || lowerGoal.includes('winback') || lowerGoal.includes('lapsed') || lowerGoal.includes('lapsing') || 
                lowerGoal.includes('inactive') || lowerGoal.includes('dormant') || lowerGoal.includes('haven\'t purchased')) {
                return 'Win-back';
            }
            
            // Churn/retention keywords
            if (lowerGoal.includes('churn') || lowerGoal.includes('retention') || lowerGoal.includes('at risk') || lowerGoal.includes('at-risk') ||
                lowerGoal.includes('likely to leave') || lowerGoal.includes('prevent') || lowerGoal.includes('retain')) {
                return 'Churn Prevention';
            }
            
            // Growth/monetization keywords
            if (lowerGoal.includes('share of wallet') || lowerGoal.includes('monetization') || lowerGoal.includes('increase revenue') ||
                lowerGoal.includes('grow revenue') || lowerGoal.includes('expand wallet') || lowerGoal.includes('more from existing')) {
                return 'Growth & Monetization';
            }
            
            // Upsell/cross-sell keywords
            if (lowerGoal.includes('upsell') || lowerGoal.includes('cross-sell') || lowerGoal.includes('cross sell') || 
                lowerGoal.includes('additional products') || lowerGoal.includes('bundle') || lowerGoal.includes('upgrade')) {
                return 'Cross-sell & Upsell';
            }
            
            // Acquisition keywords
            if (lowerGoal.includes('acquisition') || lowerGoal.includes('lookalike') || lowerGoal.includes('similar to') || 
                lowerGoal.includes('prospect') || lowerGoal.includes('new customer') || lowerGoal.includes('acquire')) {
                return 'Acquisition';
            }
            
            // Service keywords
            if (lowerGoal.includes('service') || lowerGoal.includes('frustrated') || lowerGoal.includes('support case') || 
                lowerGoal.includes('satisfaction') || lowerGoal.includes('complaint') || lowerGoal.includes('issue')) {
                return 'Service Led Marketing';
            }
            
            return null;
        }

        function generateContextualFlow(goalText) {
            const lowerGoal = goalText.toLowerCase();
            let questions = [];
            let strategies = [];
            
            // Detect key attributes mentioned in the goal
            const hasValue = lowerGoal.includes('high value') || lowerGoal.includes('high ltv') || lowerGoal.includes('valuable') || lowerGoal.includes('premium');
            const hasActivity = lowerGoal.includes('active') || lowerGoal.includes('inactive') || lowerGoal.includes('lapsed') || lowerGoal.includes('lapsing');
            const hasEngagement = lowerGoal.includes('engaged') || lowerGoal.includes('engagement') || lowerGoal.includes('loyal');
            const hasPurchase = lowerGoal.includes('purchas') || lowerGoal.includes('buy') || lowerGoal.includes('order');
            
            // Question 1: Define the key attribute mentioned
            if (hasValue) {
                questions.push({
                    text: 'How do you define "high value" customers?',
                    options: [
                        { label: 'Top 10% lifetime value', value: 'top_10_ltv' },
                        { label: 'Top 20% lifetime value', value: 'top_20_ltv' },
                        { label: 'LTV above $5,000', value: 'ltv_threshold' },
                        { label: 'Custom value criteria', value: 'custom_value' }
                    ]
                });
            } else if (hasActivity) {
                questions.push({
                    text: 'How do you define "lapsing" or "inactive" customers?',
                    options: [
                        { label: 'No purchase in 60+ days', value: '60_days' },
                        { label: 'No purchase in 90+ days', value: '90_days' },
                        { label: 'No purchase in 180+ days', value: '180_days' },
                        { label: 'Declining activity trend', value: 'declining' }
                    ]
                });
            } else if (hasEngagement) {
                questions.push({
                    text: 'How do you measure engagement?',
                    options: [
                        { label: 'Email open/click rates', value: 'email_engagement' },
                        { label: 'Website/app visits', value: 'digital_engagement' },
                        { label: 'Purchase frequency', value: 'purchase_freq' },
                        { label: 'Multiple interaction channels', value: 'omnichannel' }
                    ]
                });
            } else {
                questions.push({
                    text: 'What is the main characteristic of your target customers?',
                    options: [
                        { label: 'High lifetime value', value: 'high_ltv' },
                        { label: 'Purchase frequency', value: 'frequent' },
                        { label: 'Recent activity', value: 'recent' },
                        { label: 'Engagement level', value: 'engaged' }
                    ]
                });
            }
            
            // Question 2: Define prioritization or timeframe
            if (hasPurchase || hasActivity) {
                questions.push({
                    text: 'What timeframe should I consider for purchase/activity?',
                    options: [
                        { label: 'Last 30 days', value: '30_days' },
                        { label: 'Last 60 days', value: '60_days' },
                        { label: 'Last 90 days', value: '90_days' },
                        { label: 'Last 6 months', value: '180_days' }
                    ]
                });
            } else {
                questions.push({
                    text: 'How should I prioritize within this audience?',
                    options: [
                        { label: 'Focus on highest value only', value: 'highest_value' },
                        { label: 'Balance value and reach', value: 'balanced' },
                        { label: 'Include all who match criteria', value: 'all_match' },
                        { label: 'Add engagement as qualifier', value: 'engagement_filter' }
                    ]
                });
            }
            
            // Generate strategies based on goal context
            if (hasValue && hasActivity) {
                strategies = [
                    {
                        name: 'Strategy A (High-Value Recovery)',
                        description: 'Top 20% LTV + recently lapsed (60-90 days) + past engagement',
                        details: 'Highest recovery potential, premium treatment',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Broader Reactivation)',
                        description: 'All high-value + any lapse period + recent history',
                        details: 'Wider net, build back relationship',
                        icon: ''
                    }
                ];
            } else if (hasValue) {
                strategies = [
                    {
                        name: 'Strategy A (Premium Precision)',
                        description: 'Top 10% LTV + additional qualifying criteria',
                        details: 'Most valuable, personalized approach',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (High-Value Expansion)',
                        description: 'Top 30% LTV + broader match criteria',
                        details: 'Larger segment, strong value focus',
                        icon: ''
                    }
                ];
            } else {
                strategies = [
                    {
                        name: 'Strategy A (Focused Targeting)',
                        description: 'Strict criteria match + highest priority signals',
                        details: 'Smaller, highly qualified segment',
                        icon: ''
                    },
                    {
                        name: 'Strategy B (Broad Opportunity)',
                        description: 'Flexible criteria + wider reach',
                        details: 'Larger audience, balanced approach',
                        icon: ''
                    }
                ];
            }
            
            return {
                questions: questions,
                strategies: strategies
            };
        }

        function showFollowupQuestions() {
            const goalSelectionView = document.getElementById('goalSelectionView');
            const followupView = document.getElementById('followupView');
            
            // Show conversation view at the top
            followupView.style.display = 'block';
            
            // Add a divider between conversation and goal options if not already added
            if (!document.getElementById('conversationDivider')) {
                const divider = document.createElement('div');
                divider.id = 'conversationDivider';
                divider.style.cssText = 'border-top: 2px dashed #d1d5db; margin: 2rem 0 1.5rem 0; padding-top: 1.5rem;';
                divider.innerHTML = '<div style="text-align: center; margin-bottom: 1rem; position: relative; top: -1.5rem;"><span style="background: white; padding: 0 1rem; color: #6b7280; font-size: 0.875rem; font-weight: 600;">OR CHANGE YOUR SELECTION</span></div>';
                followupView.parentNode.insertBefore(divider, goalSelectionView);
            }
            
            // Clear any previous content
            const dynamicQuestion = document.getElementById('dynamicQuestion');
            const strategiesContainer = document.getElementById('strategiesContainer');
            dynamicQuestion.innerHTML = '';
            dynamicQuestion.style.display = 'none';
            strategiesContainer.innerHTML = '';
            strategiesContainer.style.display = 'none';
            
            // Get question flow for this goal
            let flow = goalQuestionFlows[selectedGoal];
            if (!flow) {
                // Create contextual flow for custom goals based on keywords
                // Use the original user input for semantic analysis
                flow = generateContextualFlow(userOriginalGoal || selectedGoal);
            }
            
            // Store the current flow for later access
            currentFlow = flow;
            goalQuestionFlow = flow.questions;
            currentQuestionIndex = 0;
            followupAnswers = {};
            
            // Show user's selected goal - use original text if available (custom goal)
            const displayGoal = userOriginalGoal || selectedGoal;
            const userGoalHTML = `
                <div class="chat-message user-message">
                    <div class="chat-bubble">
                        <div class="chat-bubble-text">${displayGoal}</div>
                    </div>
                </div>
            `;
            dynamicQuestion.insertAdjacentHTML('beforeend', userGoalHTML);
            dynamicQuestion.style.display = 'block';
            
            // Agent acknowledges after a short delay
            setTimeout(() => {
                const agentAckHTML = `
                    <div class="chat-message">
                        <div class="chat-avatar">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                <line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                        </div>
                        <div class="chat-bubble">
                            <div class="chat-bubble-text">Great! Let me ask you a few questions to refine your segment. </div>
                        </div>
                    </div>
                `;
                dynamicQuestion.insertAdjacentHTML('beforeend', agentAckHTML);
                
                // Show first question after another delay
                setTimeout(() => {
                    showNextQuestion();
                }, 600);
            }, 400);
        }

        function showNextQuestion() {
            if (currentQuestionIndex >= goalQuestionFlow.length) {
                // All questions answered - show strategies
                showStrategies();
                return;
            }
            
            const question = goalQuestionFlow[currentQuestionIndex];
            const questionElement = document.getElementById('dynamicQuestion');
            
            // Build options HTML with A, B, C, D labels
            const optionsHTML = question.options.map((opt, index) => {
                const label = String.fromCharCode(65 + index); // A, B, C, D...
                return `<button class="chat-option" onclick="answerDynamicQuestion('${opt.value}', '${opt.label.replace(/'/g, "\\'")}')">
                    ${label}) ${opt.label}
                </button>`;
            }).join('');
            
            // Create new question message element with text input
            const newQuestionHTML = `
                <div class="chat-message" id="question${currentQuestionIndex}">
                    <div class="chat-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                    </div>
                    <div class="chat-bubble">
                        <div class="chat-bubble-text">${question.text}</div>
                        <div class="chat-options" id="questionOptions${currentQuestionIndex}">
                            ${optionsHTML}
                            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                                <input type="text" id="customAnswer${currentQuestionIndex}" placeholder="Or type your own answer..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background: white; color: #1f2937; font-size: 0.875rem;" onkeypress="if(event.key === 'Enter') { const val = this.value.trim(); if(val) answerDynamicQuestion(val, val); }">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append new question (don't replace existing content)
            questionElement.insertAdjacentHTML('beforeend', newQuestionHTML);
            
            // Scroll to bottom
            setTimeout(() => {
                const followupView = document.getElementById('followupView');
                followupView.scrollTop = followupView.scrollHeight;
            }, 100);
        }

        function answerDynamicQuestion(value, label) {
            // Store answer
            followupAnswers[`question${currentQuestionIndex}`] = { value, label };
            
            // Hide the options for this question
            const optionsContainer = document.getElementById(`questionOptions${currentQuestionIndex}`);
            if (optionsContainer) {
                optionsContainer.style.display = 'none';
            }
            
            // Show user's answer in same format
            const userAnswerHTML = `
                <div class="chat-message user-message">
                    <div class="chat-bubble">
                        <div class="chat-bubble-text">${label}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('dynamicQuestion').insertAdjacentHTML('beforeend', userAnswerHTML);
            
            // Move to next question
            currentQuestionIndex++;
            
            setTimeout(() => {
                showNextQuestion();
                // Scroll to bottom
                const followupView = document.getElementById('followupView');
                followupView.scrollTop = followupView.scrollHeight;
            }, 600);
        }

        function showStrategies() {
            const flow = currentFlow || goalQuestionFlows[selectedGoal];
            const strategies = flow.strategies;
            
            // Show agent message introducing strategies
            const strategiesContainer = document.getElementById('strategiesContainer');
            strategiesContainer.innerHTML = `
                <div class="chat-message">
                    <div class="chat-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                    </div>
                    <div class="chat-bubble">
                        <div class="chat-bubble-text">Based on your answers, I've prepared two strategies for you to choose from:</div>
                    </div>
                </div>
                
                <div class="strategies-grid">
                    ${strategies.map((strategy, index) => `
                        <div class="strategy-card" onclick="selectStrategy(${index})">
                            <div class="strategy-icon">${strategy.icon}</div>
                            <div class="strategy-name">${strategy.name}</div>
                            <div class="strategy-description">${strategy.description}</div>
                            <div class="strategy-details">${strategy.details}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            strategiesContainer.style.display = 'block';
            
            // Scroll to bottom
            setTimeout(() => {
                const followupView = document.getElementById('followupView');
                followupView.scrollTop = followupView.scrollHeight;
            }, 100);
        }

        function selectStrategy(strategyIndex) {
            const flow = currentFlow || goalQuestionFlows[selectedGoal];
            const strategy = flow.strategies[strategyIndex];
            
            // Hide all strategy cards
            const strategyCards = document.querySelectorAll('.strategy-card');
            strategyCards.forEach(card => card.style.display = 'none');
            
            // Show user's selection
            const confirmHTML = `
                <div class="chat-message user-message">
                    <div class="chat-bubble">
                        <div class="chat-bubble-text">${strategy.name}</div>
                    </div>
                </div>
            `;
            document.getElementById('strategiesContainer').insertAdjacentHTML('beforeend', confirmHTML);
            
            // Agent confirms and proceeds
            setTimeout(() => {
                const agentConfirmHTML = `
                    <div class="chat-message">
                        <div class="chat-avatar">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                <line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                        </div>
                        <div class="chat-bubble">
                            <div class="chat-bubble-text">Perfect! Building your segment using ${strategy.name}... </div>
                        </div>
                    </div>
                `;
                document.getElementById('strategiesContainer').insertAdjacentHTML('beforeend', agentConfirmHTML);
                
                // Scroll to bottom
                const followupView = document.getElementById('followupView');
                followupView.scrollTop = followupView.scrollHeight;
                
                setTimeout(() => {
                    proceedToSegment();
                }, 1500);
            }, 400);
        }

        function proceedToSegment() {
            // Hide segments list page, welcome state, and Data Cloud nav
            document.getElementById('segmentsListPage').style.display = 'none';
            document.getElementById('welcomeState').style.display = 'none';
            document.getElementById('dataCloudNav').style.display = 'none';
            
            // Show app header
            document.querySelector('.app-header').style.display = 'flex';
            
            // Show toolbar and tab navigation
            document.getElementById('segmentToolbar').style.display = 'flex';
            document.getElementById('tabNavigation').style.display = 'flex';
            
            // Show first tab
            document.getElementById('tabContent0').classList.add('active');
            
            // Show global agent bar
            document.getElementById('globalAgentBar').classList.add('active');
            
            // Switch to first tab
            switchTab(0);
        }

        // Segments List Page Functions
        function showCreationModal() {
            document.getElementById('creationModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeCreationModal() {
            document.getElementById('creationModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function startWithAgent() {
            // Close modal
            closeCreationModal();
            
            // Hide segments list page and Data Cloud nav
            document.getElementById('segmentsListPage').style.display = 'none';
            document.getElementById('dataCloudNav').style.display = 'none';
            
            // Show app header and welcome state
            document.querySelector('.app-header').style.display = 'flex';
            document.getElementById('welcomeState').style.display = 'flex';
        }

        function startManualBuilder() {
            // Close modal
            closeCreationModal();
            
            // Hide segments list page and Data Cloud nav
            document.getElementById('segmentsListPage').style.display = 'none';
            document.getElementById('dataCloudNav').style.display = 'none';
            
            // Show app header
            document.querySelector('.app-header').style.display = 'flex';
            
            // Call the existing manual builder function
            goToManualBuilder();
        }

        function useRecommendedSegment(segmentName) {
            console.log('Using recommended segment:', segmentName);
            
            // Hide welcome state
            document.getElementById('welcomeState').style.display = 'none';
            
            // Show toolbar and tab navigation
            document.getElementById('segmentToolbar').style.display = 'flex';
            document.getElementById('tabNavigation').style.display = 'flex';
            
            // Show global agent bar
            document.getElementById('globalAgentBar').classList.add('active');
            
            // Set segment title and description based on selected segment
            document.getElementById('segmentTitle').textContent = segmentName;
            
            // Set segment descriptions based on which was selected
            if (segmentName === 'High-Value At-Risk Customers') {
                document.getElementById('segmentDescription').textContent = 'AI-recommended segment targeting high lifetime value customers showing signs of declining engagement';
                
                // Show pre-configured filters with BOTH natural language (front) and technical (back)
                const filter1 = document.getElementById('filter1');
                const filter2 = document.getElementById('filter2');
                const filter3 = document.getElementById('filter3');
                
                if (filter1) {
                    filter1.style.display = 'flex';
                    filter1.classList.remove('flipped'); // Start with natural language view
                    // Front: Conversational language
                    filter1.querySelector('.filter-face-front .filter-text').textContent = 'Our high-value customers who\'ve reached the $2,500 lifetime spend milestone';
                    // Back: Technical formula
                    filter1.querySelector('.filter-face-back .filter-label').textContent = 'Lifetime Value';
                    filter1.querySelector('.filter-face-back .filter-operator').textContent = 'is greater than';
                    filter1.querySelector('.filter-face-back .filter-value').textContent = '$2,500';
                }
                if (filter2) {
                    filter2.style.display = 'flex';
                    filter2.classList.remove('flipped');
                    // Front: Conversational language
                    filter2.querySelector('.filter-face-front .filter-text').textContent = 'Customers whose engagement has fallen off a cliff - down 40% in just 30 days';
                    // Back: Technical formula
                    filter2.querySelector('.filter-face-back .filter-label').textContent = 'Engagement Score';
                    filter2.querySelector('.filter-face-back .filter-operator').textContent = 'decreased by';
                    filter2.querySelector('.filter-face-back .filter-value').textContent = '40% (last 30 days)';
                }
                if (filter3) {
                    filter3.style.display = 'flex';
                    filter3.classList.remove('flipped');
                    // Front: Conversational language
                    filter3.querySelector('.filter-face-front .filter-text').textContent = 'People who\'ve bought from us recently - within the last 3 months';
                    // Back: Technical formula
                    filter3.querySelector('.filter-face-back .filter-label').textContent = 'Last Purchase Date';
                    filter3.querySelector('.filter-face-back .filter-operator').textContent = 'within last';
                    filter3.querySelector('.filter-face-back .filter-value').textContent = '90 days';
                }
                
            } else if (segmentName === 'Winter Campaign - Cold Climate') {
                document.getElementById('segmentDescription').textContent = 'AI-recommended segment for winter campaign targeting outdoor enthusiasts in cold climates';
                
                const filter1 = document.getElementById('filter1');
                const filter2 = document.getElementById('filter2');
                const filter3 = document.getElementById('filter3');
                
                if (filter1) {
                    filter1.style.display = 'flex';
                    filter1.classList.remove('flipped');
                    // Front: Conversational language
                    filter1.querySelector('.filter-face-front .filter-text').textContent = 'Outdoor enthusiasts and winter sports lovers who live for the snow';
                    // Back: Technical formula
                    filter1.querySelector('.filter-face-back .filter-label').textContent = 'Product Interest';
                    filter1.querySelector('.filter-face-back .filter-operator').textContent = 'includes any of';
                    filter1.querySelector('.filter-face-back .filter-value').textContent = 'Outdoor, Winter Sports, Skiing, Snowboarding';
                }
                if (filter2) {
                    filter2.style.display = 'flex';
                    filter2.classList.remove('flipped');
                    // Front: Conversational language
                    filter2.querySelector('.filter-face-front .filter-text').textContent = 'People living where winter isn\'t just a season - it\'s a lifestyle (cold climate states)';
                    // Back: Technical formula
                    filter2.querySelector('.filter-face-back .filter-label').textContent = 'Geography - State';
                    filter2.querySelector('.filter-face-back .filter-operator').textContent = 'is in';
                    filter2.querySelector('.filter-face-back .filter-value').textContent = 'Alaska, Colorado, Montana, Vermont, Wyoming, Minnesota';
                }
                if (filter3) {
                    filter3.style.display = 'flex';
                    filter3.classList.remove('flipped');
                    // Front: Conversational language
                    filter3.querySelector('.filter-face-front .filter-text').textContent = 'Customers who\'ve been checking out our winter gear in the past 2 weeks';
                    // Back: Technical formula
                    filter3.querySelector('.filter-face-back .filter-label').textContent = 'Web Activity';
                    filter3.querySelector('.filter-face-back .filter-operator').textContent = 'viewed category';
                    filter3.querySelector('.filter-face-back .filter-value').textContent = 'Winter Gear (last 14 days)';
                }
                
            } else if (segmentName === 'Loyalty Upgrade Opportunity') {
                document.getElementById('segmentDescription').textContent = 'AI-recommended segment identifying repeat customers ready for loyalty program enrollment';
                
                const filter1 = document.getElementById('filter1');
                const filter2 = document.getElementById('filter2');
                const filter3 = document.getElementById('filter3');
                
                if (filter1) {
                    filter1.style.display = 'flex';
                    filter1.classList.remove('flipped');
                    // Front: Conversational language
                    filter1.querySelector('.filter-face-front .filter-text').textContent = 'Repeat customers who\'ve come back at least 3 times - they clearly like us';
                    // Back: Technical formula
                    filter1.querySelector('.filter-face-back .filter-label').textContent = 'Purchase Count';
                    filter1.querySelector('.filter-face-back .filter-operator').textContent = 'is at least';
                    filter1.querySelector('.filter-face-back .filter-value').textContent = '3';
                }
                if (filter2) {
                    filter2.style.display = 'flex';
                    filter2.classList.remove('flipped');
                    // Front: Conversational language
                    filter2.querySelector('.filter-face-front .filter-text').textContent = 'People who\'ve spent over $500 with us - showing real commitment';
                    // Back: Technical formula
                    filter2.querySelector('.filter-face-back .filter-label').textContent = 'Total Spend (All Time)';
                    filter2.querySelector('.filter-face-back .filter-operator').textContent = 'is greater than';
                    filter2.querySelector('.filter-face-back .filter-value').textContent = '$500';
                }
                if (filter3) {
                    filter3.style.display = 'flex';
                    filter3.classList.remove('flipped');
                    // Front: Conversational language
                    filter3.querySelector('.filter-face-front .filter-text').textContent = 'Customers missing out on our loyalty perks - not enrolled yet';
                    // Back: Technical formula
                    filter3.querySelector('.filter-face-back .filter-label').textContent = 'Loyalty Program Status';
                    filter3.querySelector('.filter-face-back .filter-operator').textContent = 'is equal to';
                    filter3.querySelector('.filter-face-back .filter-value').textContent = 'Not Enrolled';
                }
                
            } else if (segmentName === 'Email Re-Engagement') {
                document.getElementById('segmentDescription').textContent = 'AI-recommended segment for re-engaging previously active email subscribers';
                
                const filter1 = document.getElementById('filter1');
                const filter2 = document.getElementById('filter2');
                const filter3 = document.getElementById('filter3');
                
                if (filter1) {
                    filter1.style.display = 'flex';
                    filter1.classList.remove('flipped');
                    // Front: Conversational language
                    filter1.querySelector('.filter-face-front .filter-text').textContent = 'Radio silence for 3 months - no opens, no clicks, nothing';
                    // Back: Technical formula
                    filter1.querySelector('.filter-face-back .filter-label').textContent = 'Email Engagement';
                    filter1.querySelector('.filter-face-back .filter-operator').textContent = 'no activity in last';
                    filter1.querySelector('.filter-face-back .filter-value').textContent = '90 days';
                }
                if (filter2) {
                    filter2.style.display = 'flex';
                    filter2.classList.remove('flipped');
                    // Front: Conversational language
                    filter2.querySelector('.filter-face-front .filter-text').textContent = 'Former email superstars who used to convert like crazy (15%+ historically)';
                    // Back: Technical formula
                    filter2.querySelector('.filter-face-back .filter-label').textContent = 'Historical Conversion Rate';
                    filter2.querySelector('.filter-face-back .filter-operator').textContent = 'is greater than';
                    filter2.querySelector('.filter-face-back .filter-value').textContent = '15%';
                }
                if (filter3) {
                    filter3.style.display = 'flex';
                    filter3.classList.remove('flipped');
                    // Front: Conversational language
                    filter3.querySelector('.filter-face-front .filter-text').textContent = 'Still on our list - haven\'t hit that unsubscribe button yet';
                    // Back: Technical formula
                    filter3.querySelector('.filter-face-back .filter-label').textContent = 'Email Subscription Status';
                    filter3.querySelector('.filter-face-back .filter-operator').textContent = 'is equal to';
                    filter3.querySelector('.filter-face-back .filter-value').textContent = 'Active (Not Unsubscribed)';
                }
            }
            
            // Hide empty state
            const emptyState = document.getElementById('emptyStateFilters');
            if (emptyState) emptyState.style.display = 'none';
            
            // Show AND column if we have multiple filters
            const andColumn = document.getElementById('andColumn');
            if (andColumn) andColumn.style.display = 'flex';
            
            // Switch to Definition tab
            switchTab('definition');
            
            // Update segment size display with estimated count
            updateSegmentSizeDisplay();
        }
        
        function goToManualBuilder() {
            // Hide welcome state and go directly to Segment Definition
            document.getElementById('welcomeState').style.display = 'none';
            
            // Show toolbar and tab navigation
            document.getElementById('segmentToolbar').style.display = 'flex';
            document.getElementById('tabNavigation').style.display = 'flex';
            
            // Show global agent bar
            document.getElementById('globalAgentBar').classList.add('active');
            
            // Clear the segment title and description for manual building
            document.getElementById('segmentTitle').textContent = 'New Segment';
            document.getElementById('segmentDescription').textContent = 'Build your custom segment by adding filters and rules manually';
            
            // Hide all pre-added filters
            const filter1 = document.getElementById('filter1');
            const filter2 = document.getElementById('filter2');
            const filter3 = document.getElementById('filter3');
            if (filter1) filter1.style.display = 'none';
            if (filter2) filter2.style.display = 'none';
            if (filter3) filter3.style.display = 'none';
            
            // Show empty state
            const emptyState = document.getElementById('emptyStateFilters');
            if (emptyState) emptyState.style.display = 'block';
            
            // Hide AND column
            const andColumn = document.getElementById('andColumn');
            if (andColumn) andColumn.style.display = 'none';
            
            // Go directly to Segment Definition tab (tab 0)
            switchTab(0);
        }

        function toggleFilterView(filterId, event) {
            // Prevent bubbling if triggered from actions
            if (event && event.target.closest('.filter-actions')) {
                return;
            }
            
            const filterCard = document.getElementById(filterId);
            if (filterCard) {
                filterCard.classList.toggle('flipped');
            }
        }
        
        // Function to create a new filter with conversational description
        function createFilterWithDescription(filterId, label, operator, value, customConversationalText = null) {
            const filterCard = document.getElementById(filterId);
            if (!filterCard) return;
            
            // Generate conversational text automatically or use custom
            const conversationalText = customConversationalText || generateConversationalFilterText(label, operator, value);
            
            // Update front face (conversational)
            const frontText = filterCard.querySelector('.filter-face-front .filter-text');
            if (frontText) {
                frontText.textContent = conversationalText;
            }
            
            // Update back face (technical formula)
            const backLabel = filterCard.querySelector('.filter-face-back .filter-label');
            const backOperator = filterCard.querySelector('.filter-face-back .filter-operator');
            const backValue = filterCard.querySelector('.filter-face-back .filter-value');
            
            if (backLabel) backLabel.textContent = label;
            if (backOperator) backOperator.textContent = operator;
            if (backValue) backValue.textContent = value;
            
            // Show the filter and reset to front view
            filterCard.style.display = 'flex';
            filterCard.classList.remove('flipped');
            
            console.log(`Created filter: ${conversationalText} [${label} ${operator} ${value}]`);
        }
        
        // Helper function to generate conversational descriptions for filters
        function generateConversationalFilterText(label, operator, value) {
            const lowerLabel = label.toLowerCase();
            const lowerOperator = operator.toLowerCase();
            
            // Age range patterns
            if (lowerLabel.includes('age')) {
                if (value.includes('-')) {
                    // Age range like "25-44"
                    const ages = value.split('-');
                    if (ages[0] && ages[1]) {
                        return `People aged between ${ages[0].trim()} and ${ages[1].trim()} years old`;
                    }
                } else if (lowerOperator.includes('greater') || lowerOperator.includes('>')) {
                    return `Customers ${value}+ years old`;
                } else if (lowerOperator.includes('less') || lowerOperator.includes('<')) {
                    return `Customers under ${value} years old`;
                } else if (lowerOperator.includes('equal') || lowerOperator.includes('=')) {
                    return `Customers who are ${value} years old`;
                }
            }
            
            // Gender patterns
            if (lowerLabel.includes('gender')) {
                const lowerValue = value.toLowerCase();
                if (lowerValue.includes('female') || lowerValue.includes('woman') || lowerValue.includes('women')) {
                    return `Women in our customer base`;
                } else if (lowerValue.includes('male') || lowerValue.includes('man') || lowerValue.includes('men')) {
                    return `Men in our customer base`;
                } else {
                    return `Customers identifying as ${value}`;
                }
            }
            
            // Income patterns
            if (lowerLabel.includes('income')) {
                if (lowerOperator.includes('greater') || lowerOperator.includes('>')) {
                    return `Higher-income customers earning over ${value} annually`;
                } else if (lowerOperator.includes('less') || lowerOperator.includes('<')) {
                    return `Customers with income under ${value}`;
                } else {
                    return `Customers with ${value} income level`;
                }
            }
            
            // Lifetime Value / Spend patterns
            if (lowerLabel.includes('lifetime value') || lowerLabel.includes('ltv')) {
                if (lowerOperator.includes('greater') || lowerOperator.includes('>')) {
                    return `Our biggest spenders who've hit the ${value} spend milestone`;
                } else if (lowerOperator.includes('less') || lowerOperator.includes('<')) {
                    return `Customers still under ${value} in lifetime value`;
                }
            }
            
            // Spend / Revenue patterns
            if (lowerLabel.includes('spend') || lowerLabel.includes('revenue')) {
                if (lowerOperator.includes('greater') || lowerOperator.includes('>')) {
                    return `People who've spent over ${value} with us - showing real commitment`;
                } else if (lowerOperator.includes('less') || lowerOperator.includes('<')) {
                    return `Lower-spending customers under ${value}`;
                }
            }
            
            // Purchase count patterns
            if (lowerLabel.includes('purchase count') || lowerLabel.includes('order count')) {
                if (lowerOperator.includes('at least') || lowerOperator.includes('>=')) {
                    return `Repeat customers who've come back at least ${value} times - they clearly like us`;
                } else if (lowerOperator.includes('exactly') || lowerOperator.includes('=')) {
                    return `Customers who've made exactly ${value} purchases`;
                }
            }
            
            // Engagement patterns
            if (lowerLabel.includes('engagement')) {
                if (lowerOperator.includes('decreased') || lowerOperator.includes('drop')) {
                    return `Customers whose engagement has fallen off a cliff - down ${value}`;
                } else if (lowerOperator.includes('no activity')) {
                    return `Radio silence for ${value} - no activity at all`;
                }
            }
            
            // Activity / Last seen patterns
            if (lowerLabel.includes('last activity') || lowerLabel.includes('last seen') || lowerLabel.includes('inactive')) {
                if (lowerOperator.includes('more than') || lowerOperator.includes('>')) {
                    return `Customers we haven't seen in over ${value}`;
                } else if (lowerOperator.includes('within') || lowerOperator.includes('last')) {
                    return `People who've been active in the last ${value}`;
                }
            }
            
            // Purchase date patterns
            if (lowerLabel.includes('purchase date') || lowerLabel.includes('last purchase')) {
                if (lowerOperator.includes('within') || lowerOperator.includes('last')) {
                    return `People who've bought from us recently - within the last ${value}`;
                } else if (lowerOperator.includes('more than') || lowerOperator.includes('>')) {
                    return `Customers who haven't purchased in over ${value}`;
                }
            }
            
            // Product interest patterns
            if (lowerLabel.includes('product interest') || lowerLabel.includes('category interest')) {
                return `People who have their eye on ${value}`;
            }
            
            // Geography patterns
            if (lowerLabel.includes('geography') || lowerLabel.includes('state') || lowerLabel.includes('location')) {
                if (lowerOperator.includes('in') || lowerOperator.includes('includes')) {
                    return `People living in ${value}`;
                }
            }
            
            // Email patterns
            if (lowerLabel.includes('email')) {
                if (lowerLabel.includes('subscription') && value.toLowerCase().includes('active')) {
                    return `Still on our list - haven't hit that unsubscribe button yet`;
                } else if (lowerLabel.includes('engagement') && lowerOperator.includes('no activity')) {
                    return `Radio silence for ${value} - no opens, no clicks, nothing`;
                }
            }
            
            // Conversion rate patterns
            if (lowerLabel.includes('conversion')) {
                if (lowerOperator.includes('greater') || lowerOperator.includes('>')) {
                    return `Former superstars who used to convert like crazy (${value}+ historically)`;
                }
            }
            
            // Loyalty status patterns
            if (lowerLabel.includes('loyalty')) {
                if (value.toLowerCase().includes('not enrolled')) {
                    return `Customers missing out on our loyalty perks - not enrolled yet`;
                } else if (value.toLowerCase().includes('enrolled') || value.toLowerCase().includes('member')) {
                    return `Our loyal members in the ${value} program`;
                }
            }
            
            // Web activity patterns
            if (lowerLabel.includes('web activity') || lowerLabel.includes('browsing')) {
                return `Customers who've been checking out ${value}`;
            }
            
            // Default fallback - make it conversational anyway
            return `${label} ${operator} ${value}`.replace(/([A-Z])/g, ' $1').trim().toLowerCase();
        }
        
        function removeFilter(filterId) {
            const filter = document.getElementById(filterId);
            if (filter) {
                filter.style.display = 'none';
            }
            
            // Check if any filters are still visible
            const allFilters = document.querySelectorAll('.filter-card:not(#emptyStateFilters)');
            let hasVisibleFilters = false;
            
            allFilters.forEach(f => {
                if (f.style.display !== 'none' && f.id) {
                    hasVisibleFilters = true;
                }
            });
            
            // Show empty state if no filters are visible
            const emptyState = document.getElementById('emptyStateFilters');
            const andColumn = document.getElementById('andColumn');
            
            if (!hasVisibleFilters) {
                if (emptyState) emptyState.style.display = 'block';
                if (andColumn) andColumn.style.display = 'none';
            } else {
                if (emptyState) emptyState.style.display = 'none';
                if (andColumn) andColumn.style.display = 'flex';
            }
        }

        function removeExclusion(exclusionId) {
            const exclusion = document.getElementById(exclusionId);
            if (exclusion) {
                exclusion.style.display = 'none';
            }
            
            // Check if any exclusions are still visible
            const allExclusions = document.querySelectorAll('.exclude-card:not(#emptyStateExclusions)');
            let hasVisibleExclusions = false;
            
            allExclusions.forEach(e => {
                if (e.style.display !== 'none' && e.id) {
                    hasVisibleExclusions = true;
                }
            });
            
            // Show empty state if no exclusions are visible
            const emptyState = document.getElementById('emptyStateExclusions');
            
            if (!hasVisibleExclusions) {
                if (emptyState) emptyState.style.display = 'block';
            } else {
                if (emptyState) emptyState.style.display = 'none';
            }
        }

        function startSegment(event) {
            event.preventDefault();
            const goal = document.getElementById('goalInput').value;
            
            // Keep segment name as is
            
            // Hide welcome
            document.getElementById('welcomeState').style.display = 'none';
            
            // Show toolbar and tab navigation
            document.getElementById('segmentToolbar').style.display = 'flex';
            document.getElementById('tabNavigation').style.display = 'flex';
            
            // Show global agent bar
            document.getElementById('globalAgentBar').classList.add('active');
            
            // Show first tab
            document.getElementById('tabContent0').classList.add('active');
            
            // Switch to first tab
            switchTab(0);
        }

        function switchTab(index) {
            // Hide all tabs (0 through 5 = 6 tabs total, after removing preview/insights/overlap)
            for (let i = 0; i <= 5; i++) {
                const tabContent = document.getElementById('tabContent' + i);
                const tab = document.getElementById('tab' + i);
                if (tabContent) tabContent.classList.remove('active');
                if (tab) tab.classList.remove('active');
            }
            
            // Show selected tab
            document.getElementById('tabContent' + index).classList.add('active');
            document.getElementById('tab' + index).classList.add('active');
            
            currentTab = index;
            agentState.currentTab = index;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openValidationOverlay(type) {
            const overlay = document.getElementById('validationOverlay');
            const overlayBody = document.getElementById('validationOverlayBody');
            const breadcrumbTitle = document.getElementById('validationBreadcrumbTitle');
            
            // Map type to tab content and title
            const contentMap = {
                'preview': { contentId: 'tabContentPreview', title: 'Preview Sample' },
                'insights': { contentId: 'tabContentInsights', title: 'View Insights' },
                'overlap': { contentId: 'tabContentOverlap', title: 'Check Overlap' }
            };
            
            const config = contentMap[type];
            if (!config) return;
            
            // Update breadcrumb
            breadcrumbTitle.textContent = config.title;
            
            // Clone the tab content and inject into overlay
            const sourceContent = document.getElementById(config.contentId);
            if (sourceContent) {
                overlayBody.innerHTML = sourceContent.innerHTML;
            }
            
            // Show overlay with animation
            overlay.classList.add('active');
            
            // Show global agent bar
            document.getElementById('globalAgentBar').classList.add('active');
            
            // Scroll overlay to top
            setTimeout(() => {
                overlayBody.scrollTop = 0;
            }, 50);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            // Add ESC key listener
            document.addEventListener('keydown', handleEscapeKey);
        }

        function closeValidationOverlay() {
            const overlay = document.getElementById('validationOverlay');
            
            // Hide overlay
            overlay.classList.remove('active');
            
            // Restore body scroll
            document.body.style.overflow = '';
            
            // Remove ESC key listener
            document.removeEventListener('keydown', handleEscapeKey);
        }

        // Add suggested filter from overlap analysis
        function addSuggestionFilter(filterName, isExclusion) {
            // Close the overlay first
            closeValidationOverlay();
            
            // Wait for overlay to close, then add filter
            setTimeout(() => {
                // Add the filter using existing function
                addQuickFilter(filterName, '', isExclusion, 'filter');
                
                // Show success message briefly
                const message = document.createElement('div');
                message.style.cssText = 'position: fixed; top: 120px; right: 20px; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-weight: 600; animation: slideInRight 0.3s ease-out;';
                message.textContent = isExclusion ? ' Exclusion added to segment rules' : ' Filter added to segment rules';
                document.body.appendChild(message);
                
                // Remove message after 2.5 seconds
                setTimeout(() => {
                    message.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => message.remove(), 300);
                }, 2500);
            }, 300);
        }

        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                closeValidationOverlay();
            }
        }

        function activateSegment() {
            // Show activation popup
            const popup = document.getElementById('activationPopup');
            popup.style.display = 'flex';
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeActivationPopup() {
            // Hide popup
            const popup = document.getElementById('activationPopup');
            popup.style.display = 'none';
            
            // Restore body scroll
            document.body.style.overflow = '';
            
            // Navigate to Performance tab (Tab 5)
            switchTab(5);
        }

        function showCustomTemplateConfig() {
            document.getElementById('customTemplateConfig').style.display = 'block';
            // Scroll to the config section
            document.getElementById('customTemplateConfig').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideCustomTemplateConfig() {
            document.getElementById('customTemplateConfig').style.display = 'none';
        }

        // Contact Point Functions
        function addContactPoint() {
            const contactPoints = [
                { icon: '', name: 'WhatsApp', desc: 'Messaging app' },
                { icon: '', name: 'Phone', desc: 'Voice call' },
                { icon: '', name: 'Meta Ads', desc: 'Social media' },
                { icon: '', name: 'Salesforce CRM', desc: 'CRM sync' }
            ];
            
            // Simple selection for now (can be enhanced later)
            const selection = prompt('Enter contact point:\n1. WhatsApp\n2. Phone\n3. Meta Ads\n4. Salesforce CRM', '1');
            if (selection && selection >= 1 && selection <= 4) {
                const selected = contactPoints[parseInt(selection) - 1];
                const list = document.getElementById('contactPointsList');
                const currentCount = list.querySelectorAll('.contact-point-item').length;
                
                const newItem = document.createElement('div');
                newItem.className = 'contact-point-item';
                newItem.draggable = true;
                newItem.innerHTML = `
                    <div style="background: #f3f4f6; border: 1px solid #d1d5db; color: #6b7280; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8125rem; font-weight: 700;">${currentCount + 1}</div>
                    <div style="font-size: 1.125rem;">${selected.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; font-size: 0.875rem;">${selected.name}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${selected.desc}</div>
                    </div>
                    <span style="background: #f3f4f6; color: #6b7280; font-size: 0.6875rem; padding: 0.25rem 0.625rem; border-radius: 0.25rem; font-weight: 600;">FALLBACK</span>
                    <button onclick="this.closest('.contact-point-item').remove()" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0.25rem;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                `;
                newItem.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.875rem; display: flex; align-items: center; gap: 0.75rem; cursor: move; transition: all 0.2s;';
                list.appendChild(newItem);
            }
        }

        // Activation Filter Functions
        function showActivationFilterModal() {
            // Reuse the personalization modal but for filters
            showPersonalizationModal();
        }

        // Journey Configuration Functions
        function toggleJourneyConfig() {
            const panel = document.getElementById('journeyConfigPanel');
            const btn = document.getElementById('journeyToggleBtn');
            
            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                btn.textContent = 'Hide Journey Config';
            } else {
                panel.style.display = 'none';
                btn.textContent = 'Configure Journey';
            }
        }

        function applyJourneyTemplate(templateName) {
            const journeySteps = document.getElementById('journeySteps');
            journeySteps.innerHTML = '';
            
            const templates = {
                'engagement': [
                    { action: 'Send Email', channel: 'Email', icon: '' },
                    { action: 'Wait', duration: '24 hours', icon: '' },
                    { action: 'If Email Opened', condition: 'email_open', icon: '' },
                    { action: 'Send WhatsApp', channel: 'WhatsApp', icon: '' },
                    { action: 'Else', condition: 'not_opened', icon: '' },
                    { action: 'Activate Meta Ads', channel: 'Meta Ads', icon: '' }
                ],
                'winback': [
                    { action: 'Send Email', channel: 'Email', icon: '' },
                    { action: 'Wait', duration: '48 hours', icon: '' },
                    { action: 'Send SMS', channel: 'SMS', icon: '' },
                    { action: 'Wait', duration: '24 hours', icon: '' },
                    { action: 'Send Push', channel: 'Push', icon: '' }
                ],
                'nurture': [
                    { action: 'Send Email Week 1', channel: 'Email', icon: '' },
                    { action: 'Wait', duration: '7 days', icon: '' },
                    { action: 'Send Email Week 2', channel: 'Email', icon: '' },
                    { action: 'Wait', duration: '7 days', icon: '' },
                    { action: 'Send Email Week 3', channel: 'Email', icon: '' },
                    { action: 'Sync to CRM', channel: 'CRM', icon: '' }
                ]
            };
            
            const steps = templates[templateName] || [];
            steps.forEach((step, index) => {
                addJourneyStepToDisplay(index + 1, step);
            });
            
            alert(`Applied ${templateName} journey template with ${steps.length} steps`);
        }

        function showCustomJourneyBuilder() {
            const builder = document.getElementById('customJourneyBuilder');
            builder.style.display = 'block';
            builder.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function addSuggestedJourneyStep(stepType) {
            // Map step types to step data
            const stepMap = {
                'email-send': { action: 'Send Email', channel: 'Email', icon: '' },
                'wait-24h': { action: 'Wait', duration: '24 hours', icon: '' },
                'check-email-open': { action: 'If Email Opened', condition: 'email_open', icon: '' },
                'send-whatsapp': { action: 'Send WhatsApp', channel: 'WhatsApp', icon: '' },
                'check-click': { action: 'If Clicked', condition: 'click', icon: '' },
                'activate-meta-ads': { action: 'Activate Meta Ads', channel: 'Meta Ads', icon: '' },
                'send-sms': { action: 'Send SMS', channel: 'SMS', icon: '' },
                'sync-crm': { action: 'Sync to CRM', channel: 'CRM', icon: '' }
            };
            
            const step = stepMap[stepType];
            if (step) {
                const journeySteps = document.getElementById('journeySteps');
                const stepCount = journeySteps.querySelectorAll('[id^="journeyStep"]').length + 1;
                addJourneyStepToDisplay(stepCount, step);
            }
        }

        function addJourneyStepToDisplay(stepNumber, step) {
            const journeySteps = document.getElementById('journeySteps');
            
            // Remove empty state if present
            const emptyState = journeySteps.querySelector('[style*="dashed"]');
            if (emptyState) emptyState.remove();
            
            const stepDiv = document.createElement('div');
            stepDiv.id = `journeyStep${stepNumber}`;
            stepDiv.innerHTML = `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="background: #f0f9ff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600; color: #1d72f3;">
                            ${stepNumber}
                        </div>
                        <div style="font-size: 1.25rem;">${step.icon}</div>
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 0.9375rem;">${step.action}</div>
                            <div style="font-size: 0.8125rem; color: #6b7280;">
                                ${step.channel ? `<strong>Channel:</strong> ${step.channel}` : ''}
                                ${step.duration ? `<strong>Duration:</strong> ${step.duration}` : ''}
                                ${step.condition ? `<strong>Condition:</strong> ${step.condition}` : ''}
                            </div>
                        </div>
                    </div>
                    <button onclick="this.closest('[id^=journeyStep]').remove()" style="background: #fee2e2; color: #991b1b; border: none; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">Remove</button>
                </div>
            `;
            journeySteps.appendChild(stepDiv);
        }

        // Personalization Attribute Selector
        let selectedPersonalizationAttrs = ['Customer Name', 'LTV Tier', 'Loyalty Status'];

        function addPersonalizationAttribute() {
            showPersonalizationModal();
        }

        function showAllAttributesForPersonalization() {
            showPersonalizationModal();
        }

        function showPersonalizationModal() {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'personalizationModal';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out;';
            
            overlay.innerHTML = `
                <div style="background: white; border-radius: 0.5rem; max-width: 900px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); animation: slideDown 0.3s ease-out;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1d72f3 0%, #1e40af 100%); padding: 1rem 1.25rem; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="font-size: 0.9375rem; font-weight: 600; margin-bottom: 0.25rem;">Add Personalization Attributes & Metrics</h2>
                                <p style="font-size: 0.8125rem; opacity: 0.9;">Select data fields to personalize your messages</p>
                            </div>
                            <button onclick="closePersonalizationModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Items Bar -->
                    <div style="background: #f0f9ff; border-bottom: 1px solid #bae6fd; padding: 0.75rem 1.25rem;">
                        <div style="font-size: 0.75rem; font-weight: 600; color: #0c4a6e; margin-bottom: 0.375rem;">
                            Selected (<span id="selectedCount">${selectedPersonalizationAttrs.length}</span>)
                        </div>
                        <div id="selectedItemsDisplay" style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                            ${selectedPersonalizationAttrs.map(attr => `
                                <div style="background: white; border: 1px solid #93c5fd; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.375rem;">
                                    ${attr}
                                    <button onclick="removePersonalizationAttr('${attr}')" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 0; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                        </svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Search -->
                    <div style="padding: 1rem 1.25rem 0 1.25rem;">
                        <div style="position: relative;">
                            <input type="text" id="personalizationSearch" placeholder="Search attributes, metrics, scores..." onkeyup="searchPersonalizationItems(this.value)" style="width: 100%; padding: 0.625rem 0.625rem 0.625rem 2.25rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.8125rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" style="position: absolute; left: 0.625rem; top: 50%; transform: translateY(-50%);">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div style="padding: 0 1.25rem;">
                        <div style="display: flex; gap: 0.5rem; border-bottom: 1px solid #e5e7eb; margin-top: 0.75rem;">
                            <button class="personalization-tab active" onclick="switchPersonalizationTab('attributes')" id="ptab-attributes" style="padding: 0.5rem 0.875rem; border: none; background: none; font-size: 0.8125rem; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s;">
                                Attributes
                            </button>
                            <button class="personalization-tab" onclick="switchPersonalizationTab('metrics')" id="ptab-metrics" style="padding: 0.5rem 0.875rem; border: none; background: none; font-size: 0.8125rem; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s;">
                                Metrics
                            </button>
                            <button class="personalization-tab" onclick="switchPersonalizationTab('scores')" id="ptab-scores" style="padding: 0.5rem 0.875rem; border: none; background: none; font-size: 0.8125rem; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s;">
                                Predictive Scores
                            </button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div style="padding: 1rem 1.25rem; max-height: 400px; overflow-y: auto;" id="personalizationContent">
                        ${getPersonalizationTabContent('attributes')}
                    </div>

                    <!-- Footer -->
                    <div style="background: #f9fafb; border-top: 1px solid #e5e7eb; padding: 0.75rem 1.25rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
                        <button onclick="closePersonalizationModal()" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; color: #374151; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="savePersonalizationSelection()" style="padding: 0.5rem 1rem; border: none; background: #1d72f3; color: white; border-radius: 0.25rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                            Add Selected (${selectedPersonalizationAttrs.length})
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Focus on search
            setTimeout(() => {
                document.getElementById('personalizationSearch').focus();
            }, 100);
        }

        function getPersonalizationTabContent(tab) {
            const items = {
                attributes: [
                    { name: 'Customer Name', icon: '', desc: 'First and last name' },
                    { name: 'Email Address', icon: '', desc: 'Contact email' },
                    { name: 'Phone Number', icon: '', desc: 'Primary phone' },
                    { name: 'Location', icon: '', desc: 'City, state, country' },
                    { name: 'Age', icon: '', desc: 'Customer age' },
                    { name: 'Gender', icon: '', desc: 'Gender identity' },
                    { name: 'LTV Tier', icon: '', desc: 'Lifetime value tier' },
                    { name: 'Loyalty Status', icon: '', desc: 'Loyalty program tier' },
                    { name: 'Last Purchase Date', icon: '', desc: 'Most recent order date' },
                    { name: 'Last Purchase Amount', icon: '', desc: 'Most recent order value' },
                    { name: 'Favorite Category', icon: '', desc: 'Top product category' },
                    { name: 'Favorite Product', icon: '', desc: 'Most purchased item' },
                    { name: 'Account Creation Date', icon: '', desc: 'When account was created' },
                    { name: 'Birthday', icon: '', desc: 'Date of birth' },
                    { name: 'Membership Level', icon: '', desc: 'Current membership tier' },
                    { name: 'Preferred Channel', icon: '', desc: 'Email, SMS, or Push' },
                    { name: 'Language', icon: '', desc: 'Preferred language' },
                    { name: 'Time Zone', icon: '', desc: 'Customer time zone' }
                ],
                metrics: [
                    { name: 'Total Spend', icon: '', desc: 'All-time purchase total' },
                    { name: 'Average Order Value', icon: '', desc: 'Avg spend per order' },
                    { name: 'Order Count', icon: '', desc: 'Total number of orders' },
                    { name: 'Purchase Frequency', icon: '', desc: 'Orders per month' },
                    { name: 'Days Since Last Purchase', icon: '', desc: 'Recency in days' },
                    { name: 'Engagement Score', icon: '', desc: 'Overall engagement metric' },
                    { name: 'Email Open Rate', icon: '', desc: 'Email engagement %' },
                    { name: 'Site Visit Count', icon: '', desc: 'Website visits' },
                    { name: 'Customer Health Score', icon: '', desc: 'Composite health metric' },
                    { name: 'ROI Score', icon: '', desc: 'Revenue / marketing cost' },
                    { name: 'Cart Abandonment Rate', icon: '', desc: 'Abandoned cart %' },
                    { name: 'Product Views', icon: '', desc: 'Total product page views' }
                ],
                scores: [
                    { name: 'Purchase Propensity', icon: '', desc: 'Likelihood to buy soon' },
                    { name: 'Churn Risk', icon: '', desc: 'Probability of churning' },
                    { name: 'Product Affinity - Outdoor', icon: '', desc: 'Interest in outdoor gear' },
                    { name: 'Product Affinity - Electronics', icon: '', desc: 'Interest in electronics' },
                    { name: 'Upsell Potential', icon: '', desc: 'Upgrade likelihood' },
                    { name: 'Cross-sell Potential', icon: '', desc: 'Additional product interest' },
                    { name: 'Brand Loyalty Score', icon: '', desc: 'Brand affinity level' },
                    { name: 'Email Response Propensity', icon: '', desc: 'Email engagement likelihood' },
                    { name: 'Win-back Opportunity', icon: '', desc: 'Reactivation potential' },
                    { name: 'Referral Likelihood', icon: '', desc: 'Propensity to refer' }
                ]
            };

            const tabItems = items[tab] || [];
            
            return `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    ${tabItems.map(item => {
                        const isSelected = selectedPersonalizationAttrs.includes(item.name);
                        return `
                            <div onclick="togglePersonalizationItem('${item.name}')" style="padding: 0.625rem 0.75rem; border: 1px solid ${isSelected ? '#93c5fd' : '#e5e7eb'}; background: ${isSelected ? '#f0f9ff' : 'white'}; border-radius: 0.25rem; cursor: pointer; transition: all 0.2s;" onmouseover="if (!this.querySelector('input').checked) { this.style.borderColor='#9ca3af'; }" onmouseout="if (!this.querySelector('input').checked) { this.style.borderColor='#e5e7eb'; }">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" ${isSelected ? 'checked' : ''} style="pointer-events: none;">
                                    <span style="font-size: 0.875rem;">${item.icon}</span>
                                    <span style="font-size: 0.8125rem; font-weight: 600; color: #1f2937; flex: 1;">${item.name}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function switchPersonalizationTab(tab) {
            // Update tab styling
            document.querySelectorAll('.personalization-tab').forEach(btn => {
                btn.style.color = '#6b7280';
                btn.style.borderColor = 'transparent';
            });
            const activeTab = document.getElementById(`ptab-${tab}`);
            activeTab.style.color = '#1d72f3';
            activeTab.style.borderColor = '#1d72f3';
            
            // Update content
            document.getElementById('personalizationContent').innerHTML = getPersonalizationTabContent(tab);
        }

        function togglePersonalizationItem(name) {
            const index = selectedPersonalizationAttrs.indexOf(name);
            if (index > -1) {
                selectedPersonalizationAttrs.splice(index, 1);
            } else {
                selectedPersonalizationAttrs.push(name);
            }
            
            // Update display
            updatePersonalizationDisplay();
        }

        function removePersonalizationAttr(name) {
            const index = selectedPersonalizationAttrs.indexOf(name);
            if (index > -1) {
                selectedPersonalizationAttrs.splice(index, 1);
            }
            updatePersonalizationDisplay();
        }

        function updatePersonalizationDisplay() {
            const selectedItemsDisplay = document.getElementById('selectedItemsDisplay');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedItemsDisplay) {
                selectedItemsDisplay.innerHTML = selectedPersonalizationAttrs.map(attr => `
                    <div style="background: white; border: 1px solid #93c5fd; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                        ${attr}
                        <button onclick="removePersonalizationAttr('${attr}')" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `).join('');
            }
            
            if (selectedCount) {
                selectedCount.textContent = selectedPersonalizationAttrs.length;
            }
            
            // Update button text in footer
            const saveBtn = document.querySelector('#personalizationModal button[onclick="savePersonalizationSelection()"]');
            if (saveBtn) {
                saveBtn.textContent = `Add Selected (${selectedPersonalizationAttrs.length})`;
            }
            
            // Refresh current tab to update checkboxes
            const activeTab = document.querySelector('.personalization-tab[style*="color: rgb(29, 114, 243)"]');
            if (activeTab) {
                const tabName = activeTab.id.replace('ptab-', '');
                document.getElementById('personalizationContent').innerHTML = getPersonalizationTabContent(tabName);
            }
        }

        function searchPersonalizationItems(query) {
            if (!query) {
                // Reset to current tab
                const activeTab = document.querySelector('.personalization-tab[style*="color: rgb(29, 114, 243)"]');
                if (activeTab) {
                    const tabName = activeTab.id.replace('ptab-', '');
                    document.getElementById('personalizationContent').innerHTML = getPersonalizationTabContent(tabName);
                }
                return;
            }
            
            // Search across all tabs
            const allItems = [
                ...getPersonalizationTabContent('attributes').match(/name="([^"]+)"/g).map(m => m.match(/name="([^"]+)"/)[1]),
                ...getPersonalizationTabContent('metrics').match(/name="([^"]+)"/g).map(m => m.match(/name="([^"]+)"/)[1]),
                ...getPersonalizationTabContent('scores').match(/name="([^"]+)"/g).map(m => m.match(/name="([^"]+)"/)[1])
            ];
            
            // Simple filter for now - just refresh with current tab
            const activeTab = document.querySelector('.personalization-tab[style*="color: rgb(29, 114, 243)"]');
            if (activeTab) {
                const tabName = activeTab.id.replace('ptab-', '');
                document.getElementById('personalizationContent').innerHTML = getPersonalizationTabContent(tabName);
            }
        }

        function closePersonalizationModal() {
            const modal = document.getElementById('personalizationModal');
            if (modal) {
                modal.remove();
            }
        }

        function savePersonalizationSelection() {
            // Update the displayed attributes in the template
            const selectedAttrsContainer = document.getElementById('selectedAttributes');
            if (selectedAttrsContainer) {
                selectedAttrsContainer.innerHTML = selectedPersonalizationAttrs.map(attr => `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer;">
                        <input type="checkbox" name="attribute" value="${attr.toLowerCase().replace(/\s+/g, '_')}" checked>
                        <span>${attr}</span>
                    </label>
                `).join('');
            }
            
            closePersonalizationModal();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.textContent = ` ${selectedPersonalizationAttrs.length} attributes added for personalization`;
            successMsg.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #10b981; color: white; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;';
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
        }

        function searchAttributesForPersonalization(query) {
            // Existing search functionality - now integrated into modal
            console.log('Search for:', query);
        }

        function showRowActions(button) {
            // Remove any existing dropdowns
            const existingDropdown = document.querySelector('.row-actions-dropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }

            // Create dropdown menu
            const dropdown = document.createElement('div');
            dropdown.className = 'row-actions-dropdown';
            dropdown.style.cssText = `
                position: absolute;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
                min-width: 180px;
                z-index: 1000;
                overflow: hidden;
            `;

            const actions = [
                { label: 'View Details', icon: 'eye' },
                { label: 'Search Similar', icon: 'search' },
                { label: 'Add to Segment', icon: 'plus' },
                { label: 'Export Row', icon: 'download' }
            ];

            actions.forEach((action, index) => {
                const actionBtn = document.createElement('div');
                actionBtn.style.cssText = `
                    padding: 0.75rem 1rem;
                    cursor: pointer;
                    transition: background 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    font-size: 0.875rem;
                    color: #1f2937;
                    ${index !== actions.length - 1 ? 'border-bottom: 1px solid #f3f4f6;' : ''}
                `;
                actionBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${action.icon === 'eye' ? '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>' : ''}
                        ${action.icon === 'search' ? '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>' : ''}
                        ${action.icon === 'plus' ? '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' : ''}
                        ${action.icon === 'download' ? '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>' : ''}
                    </svg>
                    <span>${action.label}</span>
                `;
                actionBtn.onmouseover = function() { this.style.background = '#f9fafb'; };
                actionBtn.onmouseout = function() { this.style.background = 'white'; };
                actionBtn.onclick = function() {
                    alert(action.label + ' clicked!');
                    dropdown.remove();
                };
                dropdown.appendChild(actionBtn);
            });

            // Position the dropdown
            const rect = button.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.left = (rect.left - 150) + 'px';

            document.body.appendChild(dropdown);

            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && e.target !== button) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }

        function loadAdditionalChart(chartType) {
            alert('Loading ' + chartType + ' distribution chart...');
            // In a real implementation, this would dynamically add the chart to the distribution section
        }

        // Available attributes for search
        const availableAttributes = [
            'Customer Name', 'Email Address', 'Phone Number', 'LTV Tier', 'Loyalty Status', 
            'Favorite Category', 'Last Purchase Date', 'Product Recommendations', 'Browse History',
            'Abandoned Cart Items', 'Total Orders', 'Average Order Value', 'Preferred Channel',
            'Age', 'Gender', 'Location', 'Zip Code', 'Account Manager Name', 'Account Value',
            'Subscription Status', 'VIP Benefits', 'Purchase History', 'Wishlist Items',
            'Engagement Score', 'Churn Risk', 'Next Best Action', 'Customer Segment'
        ];

        function searchAttributes(query) {
            const searchResults = document.getElementById('attributeSearchResults');
            
            if (!query || query.trim() === '') {
                searchResults.style.display = 'none';
                return;
            }

            const filtered = availableAttributes.filter(attr => 
                attr.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length === 0) {
                searchResults.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6b7280; font-size: 0.875rem;">No attributes found</div>';
                searchResults.style.display = 'block';
                return;
            }

            const resultsHTML = filtered.map(attr => `
                <div onclick="addAttribute('${attr}')" style="padding: 0.75rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; font-size: 0.875rem; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                    ${attr}
                </div>
            `).join('');

            searchResults.innerHTML = resultsHTML;
            searchResults.style.display = 'block';
        }

        function addAttribute(attributeName) {
            const container = document.getElementById('selectedAttributes');
            const value = attributeName.toLowerCase().replace(/\s+/g, '-');
            
            // Check if already added
            const existing = container.querySelector(`input[value="${value}"]`);
            if (existing) {
                document.getElementById('attributeSearch').value = '';
                document.getElementById('attributeSearchResults').style.display = 'none';
                return;
            }

            const attrHTML = `
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer;">
                    <input type="checkbox" name="attribute" value="${value}" checked>
                    <span>${attributeName}</span>
                </label>
            `;

            container.insertAdjacentHTML('beforeend', attrHTML);
            document.getElementById('attributeSearch').value = '';
            document.getElementById('attributeSearchResults').style.display = 'none';
        }

        function showAllAttributes() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            const content = `
                <div style="background: white; border-radius: 0.75rem; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1f2937;">All Available Attributes</h3>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        ${availableAttributes.map(attr => `
                            <div onclick="addAttribute('${attr}'); this.closest('[style*=fixed]').remove();" style="padding: 0.875rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f9fafb'">
                                ${attr}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        // Journey Step Management
        let journeyStepCount = 0;

        const suggestedSteps = {
            'email-send': { action: 'Send Message', channel: 'Email', description: 'Send personalized email' },
            'wait-24h': { action: 'Wait Duration', channel: 'N/A', description: 'Wait 24 hours', duration: '24 hours' },
            'check-email-open': { action: 'Branch (If/Else)', channel: 'Email', description: 'Check if email was opened', condition: 'If email opened' },
            'send-whatsapp': { action: 'Send Message', channel: 'WhatsApp', description: 'Send WhatsApp message' },
            'check-click': { action: 'Branch (If/Else)', channel: 'All', description: 'Check if link was clicked', condition: 'If clicked' },
            'activate-meta-ads': { action: 'Sync to Platform', channel: 'Meta Ads', description: 'Activate Meta Ads retargeting' },
            'send-sms': { action: 'Send Message', channel: 'SMS', description: 'Send SMS message' },
            'sync-crm': { action: 'Sync to Platform', channel: 'Salesforce CRM', description: 'Sync to CRM and create task' }
        };

        function addSuggestedStep(stepType) {
            journeyStepCount++;
            const stepsContainer = document.getElementById('journeySteps');
            
            // Remove empty state if it exists
            if (journeyStepCount === 1) {
                stepsContainer.innerHTML = '';
            }

            const step = suggestedSteps[stepType];
            const stepHTML = `
                <div id="step-${journeyStepCount}" style="background: #f0f9ff; border: 1px solid #93c5fd; border-radius: 0.375rem; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                                Step ${journeyStepCount}: ${step.description}
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.8125rem; color: #1e40af;">
                                <span><strong>Action:</strong> ${step.action}</span>
                                <span><strong>Channel:</strong> ${step.channel}</span>
                                ${step.condition ? `<span><strong>Condition:</strong> ${step.condition}</span>` : ''}
                                ${step.duration ? `<span><strong>Duration:</strong> ${step.duration}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="removeJourneyStep(${journeyStepCount})" style="background: #fee2e2; color: #991b1b; border: none; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">Remove</button>
                    </div>
                </div>
            `;
            
            stepsContainer.insertAdjacentHTML('beforeend', stepHTML);
        }

        function addCustomJourneyStep() {
            journeyStepCount++;
            const stepsContainer = document.getElementById('journeySteps');
            
            // Remove empty state if it exists
            if (journeyStepCount === 1) {
                stepsContainer.innerHTML = '';
            }
            
            const stepHTML = `
                <div id="step-${journeyStepCount}" style="background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: between; align-items: start; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.875rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem;">
                                Step ${journeyStepCount}
                                <button onclick="removeJourneyStep(${journeyStepCount})" style="float: right; background: #fee2e2; color: #991b1b; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">Remove</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.375rem;">Action Type</label>
                                    <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                        <option>Send Message</option>
                                        <option>Wait for Event</option>
                                        <option>Wait Duration</option>
                                        <option>Branch (If/Else)</option>
                                        <option>Sync to Platform</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.375rem;">Channel/Platform</label>
                                    <select style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                        <option>Email</option>
                                        <option>SMS</option>
                                        <option>WhatsApp</option>
                                        <option>Mobile Push</option>
                                        <option>Meta Ads</option>
                                        <option>Salesforce CRM</option>
                                        <option>Marketing Cloud</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.375rem;">Condition/Trigger (Optional)</label>
                                <input type="text" placeholder="e.g., If email opened, If no click in 24h" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                            </div>
                            
                            <div>
                                <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.375rem;">Wait Duration (Optional)</label>
                                <input type="text" placeholder="e.g., 24 hours, 48 hours, 3 days" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            stepsContainer.insertAdjacentHTML('beforeend', stepHTML);
        }

        function removeJourneyStep(stepId) {
            const step = document.getElementById(`step-${stepId}`);
            if (step) {
                step.remove();
                journeyStepCount--;
                
                // Show empty state if no steps left
                if (journeyStepCount === 0) {
                    document.getElementById('journeySteps').innerHTML = '<div style="background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 0.375rem; padding: 1rem; text-align: center; color: #6b7280; font-size: 0.875rem;">No steps added yet. Click "Add Step" below to start building your journey.</div>';
                }
            }
        }

        function saveCustomTemplate() {
            alert('Custom template saved successfully! You can now activate your segment with this template.');
            hideCustomTemplateConfig();
            
            // Optionally scroll back to activation button
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        // Create template from agent natural language input
        function createTemplateFromAgent(input) {
            // Show custom template config
            showCustomTemplateConfig();
            
            const inputLower = input.toLowerCase();
            
            // Extract channels from input
            const channelKeywords = {
                'email': ['email', 'mail'],
                'sms': ['sms', 'text'],
                'whatsapp': ['whatsapp', 'wa'],
                'push': ['push', 'push notification', 'mobile push'],
                'metaads': ['meta', 'facebook', 'fb', 'instagram', 'ig', 'social'],
                'crm': ['crm', 'salesforce', 'sales']
            };
            
            // Extract attributes from input
            const attributeKeywords = {
                'Customer Name': ['name', 'customer name'],
                'LTV Tier': ['ltv', 'lifetime value', 'value tier'],
                'Loyalty Status': ['loyalty', 'loyalty status'],
                'Favorite Category': ['category', 'favorite', 'preference'],
                'Product Recommendations': ['product', 'recommendation', 'suggest'],
                'Last Purchase Date': ['last purchase', 'purchase date', 'recent purchase']
            };
            
            // Auto-check channels
            Object.entries(channelKeywords).forEach(([channel, keywords]) => {
                const checkbox = document.querySelector(`input[name="channel"][value="${channel}"]`);
                if (checkbox && keywords.some(kw => inputLower.includes(kw))) {
                    checkbox.checked = true;
                }
            });
            
            // Auto-add attributes
            Object.entries(attributeKeywords).forEach(([attr, keywords]) => {
                if (keywords.some(kw => inputLower.includes(kw))) {
                    addAttribute(attr);
                }
            });
            
            // Parse journey flow intelligently
            parseAndBuildJourney(inputLower);
            
            // Scroll to the config section
            setTimeout(() => {
                document.getElementById('customTemplateConfig').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 200);
        }

        function parseAndBuildJourney(inputLower) {
            // Remove all existing journey steps first
            journeyStepCount = 0;
            document.getElementById('journeySteps').innerHTML = '<div style="background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 0.375rem; padding: 1rem; text-align: center; color: #6b7280; font-size: 0.875rem;">No steps added yet.</div>';
            
            // Tokenize the input into meaningful chunks
            // Replace common separators with a consistent one
            let normalized = inputLower
                .replace(/,/g, ' then ')
                .replace(/\band\b/g, ' then ')
                .replace(/\bafter that\b/g, ' then ')
                .replace(/\bafterwards\b/g, ' then ');
            
            // Split by sequence indicators
            const parts = normalized.split(/\s+then\s+/);
            
            // Process each part
            parts.forEach((part, index) => {
                part = part.trim();
                
                // Check for conditionals: "if X send Y"
                const conditionalMatch = part.match(/if\s+(not\s+)?(opened?|clicked?)\s+send\s+(\w+)/);
                if (conditionalMatch) {
                    const isNegative = !!conditionalMatch[1];
                    const condition = conditionalMatch[2];
                    const channel = conditionalMatch[3];
                    
                    // Add the condition check step
                    if (condition.includes('open')) {
                        addSuggestedStep('check-email-open');
                    } else if (condition.includes('click')) {
                        addSuggestedStep('check-click');
                    }
                    
                    // Add the action step
                    if (channel.includes('whatsapp') || channel.includes('wa')) {
                        addSuggestedStep('send-whatsapp');
                    } else if (channel.includes('sms')) {
                        addSuggestedStep('send-sms');
                    } else if (channel.includes('email')) {
                        addSuggestedStep('email-send');
                    } else if (channel.includes('push')) {
                        addSuggestedStep('send-sms'); // Using SMS as placeholder for push
                    }
                    return;
                }
                
                // Check for "if not" patterns: "if not opened wait X and send Y"
                const ifNotMatch = part.match(/if\s+not\s+(opened?|clicked?)\s+wait\s+.*?(\d+)\s*(hour|day|hr)s?\s+.*?send\s+(\w+)/);
                if (ifNotMatch) {
                    const condition = ifNotMatch[1];
                    const duration = ifNotMatch[2];
                    const unit = ifNotMatch[3];
                    const channel = ifNotMatch[4];
                    
                    // Add condition check
                    if (condition.includes('open')) {
                        addSuggestedStep('check-email-open');
                    } else if (condition.includes('click')) {
                        addSuggestedStep('check-click');
                    }
                    
                    // Add wait step
                    addSuggestedStep('wait-24h');
                    
                    // Add send step
                    if (channel.includes('push')) {
                        addSuggestedStep('send-sms'); // Placeholder
                    } else if (channel.includes('whatsapp')) {
                        addSuggestedStep('send-whatsapp');
                    } else if (channel.includes('sms')) {
                        addSuggestedStep('send-sms');
                    } else if (channel.includes('email')) {
                        addSuggestedStep('email-send');
                    }
                    return;
                }
                
                // Simple action patterns
                // Send email
                if (part.includes('send email') || part.includes('email')) {
                    addSuggestedStep('email-send');
                }
                
                // Wait patterns
                if (part.match(/wait\s+(\d+)\s*(hour|day|hr)s?/)) {
                    addSuggestedStep('wait-24h');
                }
                
                // Send WhatsApp
                if (part.includes('whatsapp') || part.includes('wa')) {
                    addSuggestedStep('send-whatsapp');
                }
                
                // Send SMS
                if (part.includes('sms') || part.includes('text message')) {
                    addSuggestedStep('send-sms');
                }
                
                // Send Push
                if (part.includes('push notification') || part.includes('mobile push') || part.includes('send push')) {
                    addSuggestedStep('send-sms'); // Using SMS as placeholder
                }
                
                // Activate Meta Ads
                if (part.includes('meta') || part.includes('facebook') || part.includes('ads')) {
                    addSuggestedStep('activate-meta-ads');
                }
                
                // Sync CRM
                if (part.includes('crm') || part.includes('salesforce')) {
                    addSuggestedStep('sync-crm');
                }
                
                // Check if opened
                if (part.match(/if\s+(opened?|email opened?)/)) {
                    addSuggestedStep('check-email-open');
                }
                
                // Check if clicked
                if (part.match(/if\s+(clicked?|link clicked?)/)) {
                    addSuggestedStep('check-click');
                }
            });
        }

        function toggleOverlapDetails(id) {
            const detailsDiv = document.getElementById(id + '-details');
            if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        function updateOverlapVisualization(segmentType) {
            const data = {
                outdoor: {
                    name: 'Outdoor\nAdventures',
                    count: '18,245',
                    overlap: '42%',
                    overlapCount: '5,244',
                    color: '#10b981',
                    bgColor: '#f0fdf4',
                    borderColor: '#86efac',
                    textColor: '#166534',
                    history: 'Ran last week and last month with strong engagement',
                    details: [
                        { label: 'Last Week (Winter Sports Promo):', value: '35% responded' },
                        { label: 'Last Month (Holiday Gift Guide):', value: '52% responded' }
                    ],
                    recommendation: 'Coordinate messaging timing to avoid message fatigue. Consider suppressing overlapping users for 2-3 weeks.',
                    period: 'week month',
                    fatigue: {
                        contacted7days: '28%',
                        contacted7daysCount: '5,109',
                        highFreq: '24%',
                        highFreqCount: '4,379',
                        score: '7.4',
                        riskLevel: 'High Risk',
                        warning: '24% of customers in this segment (4,379 people) have received high message frequency.'
                    }
                },
                premium: {
                    name: 'Premium\nBuyers',
                    count: '9,832',
                    overlap: '28%',
                    overlapCount: '3,496',
                    color: '#f59e0b',
                    bgColor: '#fffbeb',
                    borderColor: '#fde68a',
                    textColor: '#92400e',
                    history: 'Active segment with high purchasing power',
                    details: [
                        { label: 'Average purchase value:', value: '$485 (35% above avg)' },
                        { label: 'Loyalty tier:', value: 'Mostly Gold/Platinum' }
                    ],
                    recommendation: 'Prioritize exclusive product launches and VIP experiences for this high-value overlap.',
                    period: 'all',
                    fatigue: {
                        contacted7days: '31%',
                        contacted7daysCount: '3,868',
                        highFreq: '27%',
                        highFreqCount: '3,370',
                        score: '7.8',
                        riskLevel: 'High Risk',
                        warning: '27% of customers in this segment (3,370 people) have received high message frequency.'
                    }
                },
                winter: {
                    name: 'Winter\nSports',
                    count: '14,620',
                    overlap: '35%',
                    overlapCount: '4,370',
                    color: '#8b5cf6',
                    bgColor: '#faf5ff',
                    borderColor: '#e9d5ff',
                    textColor: '#6b21a8',
                    history: 'Activation ran Jan 13-19, 2026 (Last Week)',
                    details: [
                        { label: 'Response rate:', value: '18.2% (above average)' },
                        { label: 'Activation ROI:', value: '$124K revenue' }
                    ],
                    recommendation: 'Wait 2-3 weeks before next outreach. High engagement suggests strong sports equipment interest.',
                    period: 'week',
                    fatigue: {
                        contacted7days: '18%',
                        contacted7daysCount: '2,632',
                        highFreq: '14%',
                        highFreqCount: '2,047',
                        score: '5.2',
                        riskLevel: 'Moderate Risk',
                        warning: '14% of customers in this segment (2,047 people) have received high message frequency.'
                    }
                },
                holiday: {
                    name: 'Holiday\nGift Guide',
                    count: '21,340',
                    overlap: '52%',
                    overlapCount: '6,493',
                    color: '#ec4899',
                    bgColor: '#fdf2f8',
                    borderColor: '#fbcfe8',
                    textColor: '#9f1239',
                    history: 'Activation ran Dec 1-24, 2025 (Last Month)',
                    details: [
                        { label: 'Conversion rate:', value: '14.8% (excellent)' },
                        { label: 'Average order value:', value: '$287' }
                    ],
                    recommendation: 'Strong seasonal responsiveness. Leverage gift-giving occasions and holiday themes for this audience.',
                    period: 'month',
                    fatigue: {
                        contacted7days: '35%',
                        contacted7daysCount: '7,469',
                        highFreq: '29%',
                        highFreqCount: '6,189',
                        score: '8.1',
                        riskLevel: 'Very High Risk',
                        warning: '29% of customers in this segment (6,189 people) have received high message frequency.'
                    }
                },
                loyalty: {
                    name: 'Gold Tier\nLoyalty',
                    count: '15,420',
                    overlap: '38%',
                    overlapCount: '4,745',
                    color: '#3b82f6',
                    bgColor: '#eff6ff',
                    borderColor: '#bfdbfe',
                    textColor: '#1e40af',
                    history: 'Active loyalty program members',
                    details: [
                        { label: 'Average tenure:', value: '3.2 years' },
                        { label: 'Points balance:', value: 'Avg 8,420 points' }
                    ],
                    recommendation: 'Leverage loyalty rewards and exclusive member benefits to drive engagement and retention.',
                    period: 'all',
                    fatigue: {
                        contacted7days: '20%',
                        contacted7daysCount: '3,084',
                        highFreq: '16%',
                        highFreqCount: '2,467',
                        score: '5.9',
                        riskLevel: 'Moderate Risk',
                        warning: '16% of customers in this segment (2,467 people) have received high message frequency.'
                    }
                },
                recentBuyers: {
                    name: 'Recent\nBuyers',
                    count: '7,892',
                    overlap: '22%',
                    overlapCount: '2,747',
                    color: '#06b6d4',
                    bgColor: '#ecfeff',
                    borderColor: '#a5f3fc',
                    textColor: '#155e75',
                    history: 'Purchased within last 30 days',
                    details: [
                        { label: 'Purchase recency:', value: 'Avg 12 days ago' },
                        { label: 'Repeat purchase rate:', value: '34%' }
                    ],
                    recommendation: 'Target with complementary products and accessories. High conversion potential for cross-sell.',
                    period: 'all',
                    fatigue: {
                        contacted7days: '12%',
                        contacted7daysCount: '947',
                        highFreq: '8%',
                        highFreqCount: '631',
                        score: '3.4',
                        riskLevel: 'Low Risk',
                        warning: '8% of customers in this segment (631 people) have received high message frequency.'
                    }
                }
            };

            const segment = data[segmentType];
            
            // Update comparison label in Venn diagram
            const labelLines = segment.name.split('\n');
            document.getElementById('vennCompareLabel').innerHTML = `
                <tspan x="300" dy="-10">${labelLines[0]}</tspan>
                <tspan x="300" dy="20">${labelLines[1]}</tspan>
                <tspan x="300" dy="20" font-size="20" font-weight="700">${segment.count}</tspan>
            `;
            
            // Update right circle color
            document.getElementById('vennCircle2').setAttribute('fill', segment.color);
            document.getElementById('vennCircle2').setAttribute('fill-opacity', '0.3');
            document.getElementById('vennCircle2').setAttribute('stroke', segment.color);
            
            // Update overlap text - select the third text element in the SVG
            const svgElement = document.querySelector('#vennCircle1').closest('svg');
            const allTextElements = svgElement.querySelectorAll('text');
            const overlapText = allTextElements[2]; // Third text element is the overlap
            if (overlapText) {
                overlapText.innerHTML = `
                    <tspan x="200" y="140">Overlap</tspan>
                    <tspan x="200" y="165" font-size="24">${segment.overlap}</tspan>
                    <tspan x="200" y="190" font-size="14" font-weight="600">${segment.overlapCount}</tspan>
                `;
            }
            
            // Update details box
            let detailsHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <div style="width: 12px; height: 12px; background: ${segment.color}; border-radius: 50%;"></div>
                    <div style="font-weight: 600; color: ${segment.textColor}; font-size: 0.9375rem;">${segment.name.replace('\n', ' ')}</div>
                </div>
                <div style="font-size: 0.875rem; color: ${segment.textColor}; line-height: 1.6; margin-bottom: 0.75rem;">
                    <strong>Activation History:</strong> ${segment.history}
                </div>
                <div style="display: grid; gap: 0.5rem; font-size: 0.8125rem; color: ${segment.textColor};">
            `;
            
            segment.details.forEach(detail => {
                detailsHTML += `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${detail.label}</span>
                        <strong>${detail.value}</strong>
                    </div>
                `;
            });
            
            detailsHTML += `
                </div>
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid ${segment.borderColor}; font-size: 0.8125rem; color: ${segment.textColor};">
                    <strong> Recommendation:</strong> ${segment.recommendation}
                </div>
            `;
            
            document.getElementById('overlapDetails').innerHTML = detailsHTML;
            document.getElementById('overlapDetails').style.background = segment.bgColor;
            document.getElementById('overlapDetails').style.borderColor = segment.borderColor;
            
            // Update fatigue data if available
            if (segment.fatigue) {
                document.getElementById('fatigue7days').textContent = segment.fatigue.contacted7days;
                document.getElementById('fatigue7daysCount').textContent = segment.fatigue.contacted7daysCount + ' customers from this segment';
                document.getElementById('fatigueHighFreq').textContent = segment.fatigue.highFreq;
                document.getElementById('fatigueHighFreqCount').textContent = segment.fatigue.highFreqCount + ' customers receiving 6+ msgs/month';
                document.getElementById('fatigueScore').textContent = segment.fatigue.score + '/10';
                document.getElementById('fatigueRiskLevel').textContent = segment.fatigue.riskLevel + ' for this segment';
                document.getElementById('fatigueScoreDetail').textContent = segment.fatigue.score;
                document.getElementById('fatigueRiskLevelDetail').textContent = segment.fatigue.riskLevel;
                document.getElementById('fatigueWarning').innerHTML = `<div style="font-size: 0.8125rem; color: #6b7280; line-height: 1.5;"><strong> Warning:</strong> ${segment.fatigue.warning} Consider suppressing or reducing contact frequency to avoid fatigue.</div>`;
            }
            
            // Update filter button highlighting based on segment period
            const period = segment.period;
            let activeFilter = 'all';
            if (period === 'week') {
                activeFilter = 'week';
            } else if (period === 'month') {
                activeFilter = 'month';
            } else if (period.includes('week') && period.includes('month')) {
                activeFilter = 'all'; // Default to all for mixed periods
            } else if (period === 'all') {
                activeFilter = 'all';
            }
            
            // Update button states
            document.getElementById('filterWeek').style.background = activeFilter === 'week' ? '#1d72f3' : 'white';
            document.getElementById('filterWeek').style.color = activeFilter === 'week' ? 'white' : '#6b7280';
            document.getElementById('filterWeek').style.borderColor = activeFilter === 'week' ? '#1d72f3' : '#d1d5db';
            
            document.getElementById('filterMonth').style.background = activeFilter === 'month' ? '#1d72f3' : 'white';
            document.getElementById('filterMonth').style.color = activeFilter === 'month' ? 'white' : '#6b7280';
            document.getElementById('filterMonth').style.borderColor = activeFilter === 'month' ? '#1d72f3' : '#d1d5db';
            
            document.getElementById('filterAll').style.background = activeFilter === 'all' ? '#1d72f3' : 'white';
            document.getElementById('filterAll').style.color = activeFilter === 'all' ? 'white' : '#6b7280';
            document.getElementById('filterAll').style.borderColor = activeFilter === 'all' ? '#1d72f3' : '#d1d5db';
        }

        function filterOverlapSegments(period) {
            // Update button states
            document.getElementById('filterWeek').style.background = period === 'week' ? '#1d72f3' : 'white';
            document.getElementById('filterWeek').style.color = period === 'week' ? 'white' : '#6b7280';
            document.getElementById('filterWeek').style.borderColor = period === 'week' ? '#1d72f3' : '#d1d5db';
            
            document.getElementById('filterMonth').style.background = period === 'month' ? '#1d72f3' : 'white';
            document.getElementById('filterMonth').style.color = period === 'month' ? 'white' : '#6b7280';
            document.getElementById('filterMonth').style.borderColor = period === 'month' ? '#1d72f3' : '#d1d5db';
            
            document.getElementById('filterAll').style.background = period === 'all' ? '#1d72f3' : 'white';
            document.getElementById('filterAll').style.color = period === 'all' ? 'white' : '#6b7280';
            document.getElementById('filterAll').style.borderColor = period === 'all' ? '#1d72f3' : '#d1d5db';

            // Filter list items
            const listItems = document.querySelectorAll('.overlap-list-item');
            const selectOptions = document.querySelectorAll('#overlapSegmentSelector option');
            
            listItems.forEach(item => {
                const itemPeriod = item.getAttribute('data-period');
                if (period === 'all' || itemPeriod.includes(period)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // Filter dropdown options
            selectOptions.forEach(option => {
                const optionPeriod = option.getAttribute('data-period');
                if (period === 'all' || optionPeriod.includes(period)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });

            // Select first visible option
            const firstVisible = Array.from(selectOptions).find(opt => opt.style.display !== 'none');
            if (firstVisible) {
                document.getElementById('overlapSegmentSelector').value = firstVisible.value;
                updateOverlapVisualization(firstVisible.value);
            }
        }

        let exclusionMode = false;

        // Filter Builder Functions
        function toggleFilterBuilder() {
            const panel = document.getElementById('filterBuilderPanel');
            const arrow = document.getElementById('filterBuilderArrow');
            exclusionMode = false;
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                arrow.classList.remove('open');
            } else {
                panel.classList.add('open');
                arrow.classList.add('open');
            }
        }

        function toggleFilterBuilderForExclusion() {
            const panel = document.getElementById('filterBuilderPanel');
            const arrow = document.getElementById('filterBuilderArrow');
            exclusionMode = true;
            
            panel.classList.add('open');
            arrow.classList.add('open');
        }

        function switchFilterTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.filter-tab');
            const contents = document.querySelectorAll('.filter-tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('content-' + tabName).classList.add('active');
        }

        function showAttributeConfig(attributeName, attributeType) {
            // For now, just add the attribute as a quick filter
            // In a full implementation, this would show a config modal
            addQuickFilter(attributeName + ' (configure)', '', exclusionMode);
        }

        // Backwards compatibility
        function toggleQuickFilters() {
            toggleFilterBuilder();
        }

        function toggleQuickFiltersForExclusion() {
            toggleFilterBuilderForExclusion();
        }

        // Old function placeholder
        function oldToggleForExclusion() {
            const panel = document.getElementById('filterBuilderPanel');
            const arrow = document.getElementById('filterBuilderArrow');
            exclusionMode = true;
            
            panel.classList.add('open');
            arrow.classList.add('open');
            
            // Update panel title to indicate exclusion mode
            const title = panel.querySelector('.filter-panel-header h3');
            const originalTitle = title ? title.textContent : '';
            title.textContent = 'Select Filters to Exclude';
            title.style.color = '#6b7280';
            
            // Reset on close
            setTimeout(() => {
                const observer = new MutationObserver(() => {
                    if (!panel.classList.contains('open')) {
                        title.textContent = 'Select from Quick Filters to Refine Segment';
                        title.style.color = '';
                        exclusionMode = false;
                        observer.disconnect();
                    }
                });
                observer.observe(panel, { attributes: true, attributeFilter: ['class'] });
            }, 100);
        }

        function addQuickFilter(name, icon, isExclusion = false, filterType = 'filter') {
            if (addedFilters.includes(name)) {
                toggleQuickFilters();
                return;
            }
            
            addedFilters.push(name);
            
            // Parse name and value
            let filterLabel, filterOperator, filterValue;
            if (name.includes(':')) {
                const parts = name.split(':');
                filterLabel = parts[0].trim();
                filterValue = parts[1].trim();
                
                // Determine operator from value
                if (filterValue.includes('>')) {
                    filterOperator = 'is greater than';
                    filterValue = filterValue.replace('>', '').trim();
                } else if (filterValue.includes('<')) {
                    filterOperator = 'is less than';
                    filterValue = filterValue.replace('<', '').trim();
                } else if (filterValue.includes('between')) {
                    filterOperator = 'is between';
                } else {
                    filterOperator = 'is equal to';
                }
            } else {
                filterLabel = name;
                filterOperator = 'is configured';
                filterValue = '[To be set]';
            }
            
            if (isExclusion) {
                // Add to exclusion list (keeping simple format for exclusions)
                const excludesList = document.getElementById('excludesList');
                const emptyState = document.getElementById('emptyStateExclusions');
                
                if (emptyState) emptyState.style.display = 'none';
                
                const newExclude = document.createElement('div');
                newExclude.className = 'exclude-card';
                newExclude.innerHTML = `
                    <div class="exclude-content">
                        <span class="exclude-text"><strong>${filterLabel}</strong> ${filterType === 'segment' ? 'excluded' : 'is ' + filterValue}</span>
                    </div>
                    <div class="exclude-actions">
                        <button class="icon-btn" onclick="this.closest('.exclude-card').remove(); checkEmptyExclusions();">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                excludesList.appendChild(newExclude);
            } else {
                // Get filters column
                const filtersColumn = document.getElementById('filtersColumn');
                const emptyState = document.getElementById('emptyStateFilters');
                const andColumn = document.getElementById('andColumn');
                
                // Hide empty state and show AND column
                if (emptyState) emptyState.style.display = 'none';
                if (andColumn) andColumn.style.display = 'flex';
                
                // Generate conversational text
                const conversationalText = generateConversationalFilterText(filterLabel, filterOperator, filterValue);
                
                // Generate unique ID for this filter
                const filterId = 'filter-' + Date.now();
                
                // Create new filter card with FLIP CARD structure
                const newFilter = document.createElement('div');
                newFilter.className = 'filter-card';
                newFilter.id = filterId;
                newFilter.onclick = function(event) { toggleFilterView(filterId, event); };
                
                newFilter.innerHTML = `
                    <div class="filter-card-inner">
                        <!-- Front Face: Conversational Language -->
                        <div class="filter-face filter-face-front">
                            <div class="filter-content">
                                <span class="filter-text">${conversationalText}</span>
                            </div>
                            <div class="filter-actions">
                                <button class="icon-btn" onclick="event.stopPropagation(); this.closest('.filter-card').remove(); checkEmptyFilters();">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    </svg>
                                </button>
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                    <span style="font-size: 0.6875rem; color: #6b7280;">Click for formula</span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#1d72f3" stroke-width="2">
                                        <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <!-- Back Face: Technical Formula -->
                        <div class="filter-face filter-face-back">
                            <div class="filter-content">
                                <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                    <span class="filter-label" style="padding: 0.25rem 0.625rem; background: #dbeafe; color: #1e40af; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">${filterLabel}</span>
                                    <span class="filter-operator" style="font-size: 0.875rem; color: #6b7280;">${filterOperator}</span>
                                    <span class="filter-value" style="padding: 0.25rem 0.625rem; background: #fef3c7; color: #92400e; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;">${filterValue}</span>
                                </div>
                            </div>
                            <div class="filter-actions">
                                <button class="icon-btn" onclick="event.stopPropagation(); this.closest('.filter-card').remove(); checkEmptyFilters();">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    </svg>
                                </button>
                                <div style="display: flex; align-items: center; gap: 0.375rem; margin-left: 0.5rem;">
                                    <span style="font-size: 0.6875rem; color: #6b7280;">Click to flip back</span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                        <path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                filtersColumn.appendChild(newFilter);
            }
            
            // Update audience count
            currentAudience -= 1500;
            updateAudienceDisplay();
            
            // Close panel
            if (exclusionMode) {
                toggleQuickFiltersForExclusion();
            } else {
                toggleQuickFilters();
            }
        }

        function getFilterTypeBadge(filterType) {
            const badges = {
                'attribute': '<span class="filter-type-badge badge-attribute">Attribute</span>',
                'filter': '<span class="filter-type-badge badge-filter">Filter</span>',
                'metric': '<span class="filter-type-badge badge-metric">Metric</span>',
                'score': '<span class="filter-type-badge badge-score">AI Score</span>',
                'segment': '<span class="filter-type-badge badge-segment">Segment</span>'
            };
            return badges[filterType] || badges['filter'];
        }

        function checkEmptyFilters() {
            const filtersColumn = document.getElementById('filtersColumn');
            const emptyState = document.getElementById('emptyStateFilters');
            const filterCards = filtersColumn.querySelectorAll('.filter-card');
            
            if (filterCards.length === 0 && emptyState) {
                emptyState.style.display = 'block';
            }
        }

        function checkEmptyExclusions() {
            const excludesList = document.getElementById('excludesList');
            const emptyState = document.getElementById('emptyStateExclusions');
            const excludeCards = excludesList.querySelectorAll('.exclude-card');
            
            if (excludeCards.length === 0 && emptyState) {
                emptyState.style.display = 'block';
            }
        }

        // Metric Builder Functions
        function toggleMetricBuilder() {
            const builder = document.getElementById('inlineMetricBuilder');
            const isVisible = builder.style.display === 'block';
            
            if (isVisible) {
                closeMetricBuilder();
            } else {
                builder.style.display = 'block';
                // Focus on agent input
                setTimeout(() => {
                    builder.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    document.getElementById('metricAgentInput').focus();
                }, 100);
            }
        }

        function toggleMetricExamples() {
            const examples = document.getElementById('metricExamples');
            examples.style.display = examples.style.display === 'none' ? 'block' : 'none';
        }

        function toggleManualForm() {
            const manualForm = document.getElementById('manualMetricForm');
            const isVisible = manualForm.style.display === 'block';
            
            if (isVisible) {
                manualForm.style.display = 'none';
            } else {
                manualForm.style.display = 'block';
                // Scroll to manual form
                setTimeout(() => {
                    manualForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            }
        }

        function parseMetricFromAgent() {
            const input = document.getElementById('metricAgentInput').value.trim().toLowerCase();
            
            if (!input) {
                alert('Please describe the metric you want to build');
                return;
            }
            
            // Remove any previous guidance messages
            const builder = document.getElementById('inlineMetricBuilder');
            const prevGuidance = builder.querySelector('[style*="fef3c7"]');
            if (prevGuidance) prevGuidance.remove();
            
            // Parse the description
            let metricName = '';
            let attr1 = '';
            let attr2 = '';
            let formula = '';
            let operator = '>';
            let threshold = '';
            
            // Extract threshold (any number in the description)
            const numberMatch = input.match(/(\d+(?:\.\d+)?)/);
            if (numberMatch) {
                threshold = numberMatch[1];
            }
            
            // Detect operator
            if (input.includes('more than') || input.includes('greater than') || input.includes('above') || input.includes('over') || input.includes('>')) {
                operator = '>';
            } else if (input.includes('less than') || input.includes('below') || input.includes('under') || input.includes('<')) {
                operator = '<';
            } else if (input.includes('at least') || input.includes('minimum') || input.includes('>=')) {
                operator = '>=';
            } else if (input.includes('at most') || input.includes('maximum') || input.includes('<=')) {
                operator = '<=';
            } else if (input.includes('equal to') || input.includes('exactly') || input.includes('=')) {
                operator = '=';
            }
            
            // Detect attributes and formulas
            // Revenue/Money related
            if (input.includes('spend') || input.includes('spending')) {
                attr1 = 'TotalSpend';
                if (!metricName) metricName = 'High Spenders';
            }
            if (input.includes('revenue')) {
                attr1 = 'Revenue';
                if (!metricName) metricName = 'High Revenue';
            }
            if (input.includes('lifetime value') || input.includes('ltv')) {
                attr1 = 'LifetimeValue';
                if (!metricName) metricName = 'High LTV';
            }
            if (input.includes('projected value')) {
                attr1 = 'ProjectedValue';
                if (!metricName) metricName = 'High Projected Value';
            }
            
            // Activity related
            if (input.includes('order') || input.includes('purchase')) {
                if (input.includes('count') || input.includes('number of')) {
                    attr2 = 'OrderCount';
                } else {
                    attr2 = 'OrderCount';
                }
            }
            if (input.includes('email open') || input.includes('opens')) {
                if (!attr1) {
                    attr1 = 'EmailOpens';
                    if (!metricName) metricName = 'Email Engagement';
                } else {
                    attr2 = 'EmailOpens';
                }
            }
            if (input.includes('site visit') || input.includes('website visit')) {
                if (!attr1) {
                    attr1 = 'SiteVisits';
                    if (!metricName) metricName = 'Site Engagement';
                } else {
                    attr2 = 'SiteVisits';
                }
            }
            if (input.includes('marketing cost')) {
                attr2 = 'MarketingCost';
            }
            if (input.includes('months active')) {
                attr2 = 'MonthsActive';
            }
            
            // Detect formula type
            if (input.includes('per order') || input.includes('per purchase') || (input.includes('spend') && input.includes('order'))) {
                attr1 = 'TotalSpend';
                attr2 = 'OrderCount';
                formula = 'DIVIDE';
                if (!metricName) metricName = 'High AOV Shoppers';
            } else if (input.includes('average order value') || input.includes('aov')) {
                attr1 = 'TotalSpend';
                attr2 = 'OrderCount';
                formula = 'DIVIDE';
                metricName = 'High AOV Shoppers';
            } else if (input.includes('average') || input.includes('avg')) {
                formula = 'AVG';
            } else if (input.includes('total') || input.includes('sum')) {
                formula = 'SUM';
            } else if (input.includes('divided by') || input.includes('divide by') || input.includes('/') || input.includes('ratio')) {
                formula = 'DIVIDE';
            } else if (input.includes('multiplied by') || input.includes('multiply by') || input.includes('') || input.includes('*')) {
                formula = 'MULTIPLY';
            } else if (input.includes('count')) {
                formula = 'COUNT';
            } else if (input.includes('roi') || input.includes('return on investment')) {
                attr1 = 'Revenue';
                attr2 = 'MarketingCost';
                formula = 'DIVIDE';
                metricName = 'High ROI Customers';
            } else if (input.includes('engagement score') || input.includes('engagement rate')) {
                attr1 = 'EmailOpens';
                attr2 = 'SiteVisits';
                formula = 'AVG';
                metricName = 'Highly Engaged';
            } else if (input.includes('frequency') || (input.includes('per month') && input.includes('order'))) {
                attr1 = 'OrderCount';
                attr2 = 'MonthsActive';
                formula = 'DIVIDE';
                metricName = 'Frequent Buyers';
            } else {
                // Default to single attribute threshold
                if (attr1 && !formula) {
                    formula = 'SUM'; // Just use the attribute as-is
                }
            }
            
            // If no attribute detected, try to infer from context
            if (!attr1) {
                if (input.includes('customer') || input.includes('shopper') || input.includes('buyer')) {
                    attr1 = 'TotalSpend';
                    formula = 'SUM';
                    metricName = 'Custom Metric';
                }
            }
            
            // Generate metric name from description if not already set
            if (!metricName) {
                // Extract first few meaningful words
                const words = input.split(' ').filter(w => !['who', 'with', 'the', 'a', 'an', 'in', 'on', 'at', 'to', 'for', 'of'].includes(w));
                metricName = words.slice(0, 3).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            }
            
            // Validate we have enough information
            if (!attr1 || !formula || !threshold) {
                // Show helpful guidance
                const guidance = document.createElement('div');
                guidance.style.cssText = 'margin-top: 1rem; padding: 1rem; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 0.375rem; font-size: 0.8125rem; color: #92400e;';
                guidance.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 0.5rem;"> I need more details to build this metric</div>
                    <div style="margin-bottom: 0.5rem;">Try being more specific with:</div>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        <li>What to measure (e.g., "spend", "orders", "revenue")</li>
                        <li>How to calculate (e.g., "divided by", "average", "total")</li>
                        <li>The threshold (e.g., "more than 500", "above 75")</li>
                    </ul>
                    <div style="margin-top: 0.75rem; font-weight: 600;">Examples:</div>
                    <div style="margin-top: 0.25rem;"> "customers who spend more than $500 per order"</div>
                    <div> "average lifetime value above 1000"</div>
                    <div> "total revenue divided by marketing cost greater than 5"</div>
                    <div style="margin-top: 0.75rem;">
                        <button onclick="toggleManualForm(); this.parentElement.parentElement.remove();" style="padding: 0.5rem 1rem; background: #1d72f3; color: white; border: none; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer;">
                            Or Build Manually
                        </button>
                    </div>
                `;
                
                const agentInput = document.getElementById('metricAgentInput');
                agentInput.parentNode.insertBefore(guidance, agentInput.nextSibling.nextSibling);
                
                return;
            }
            
            // Auto-fill the form (for if user wants to refine manually later)
            document.getElementById('metricNameInput').value = metricName;
            document.getElementById('metricAttribute1').value = attr1;
            document.getElementById('metricAttribute2').value = attr2;
            document.getElementById('metricFormula').value = formula;
            document.getElementById('metricOperator').value = operator;
            document.getElementById('metricThreshold').value = threshold;
            
            // Trigger preview update
            const event = new Event('change');
            document.getElementById('metricAttribute1').dispatchEvent(event);
            
            // Store current metric in global variable for refinements
            window.currentMetricState = {
                name: metricName,
                attr1: attr1,
                attr2: attr2,
                formula: formula,
                operator: operator,
                threshold: threshold,
                originalInput: document.getElementById('metricAgentInput').value,
                chatHistory: [] // Store conversation history
            };
            
            // Switch to two-panel conversational view
            console.log('Switching to conversational view');
            const initialInput = document.getElementById('metricInitialInput');
            const conversationalView = document.getElementById('metricConversationalView');
            
            if (initialInput) initialInput.style.display = 'none';
            if (conversationalView) {
                conversationalView.style.display = 'block';
                console.log('Conversational view should now be visible');
            } else {
                console.error('Conversational view element not found!');
            }
            
            // Update formula preview panel
            updateMetricFormulaPreview();
            
            // Initialize chat history - only clear if this is a fresh start
            const chatHistory = document.getElementById('metricChatHistory');
            if (!chatHistory) {
                console.error('Chat history element not found!');
                return;
            }
            
            console.log('Initializing chat history');
            console.log('Original input:', window.currentMetricState.originalInput);
            
            // Wait for DOM to be ready, then add messages
            setTimeout(() => {
                const chatHistory = document.getElementById('metricChatHistory');
                if (!chatHistory) {
                    console.error(' Chat history not found after delay');
                    return;
                }
                
                console.log(' Chat history element ready');
                
                // Build messages as HTML string
                const userMessage = window.currentMetricState.originalInput;
                const agentMessage = ` Built <strong>${metricName}</strong>. You can see the formula on the right <br><br>Feel free to refine by typing commands like "change threshold to 1000" or "use a different operator".`;
                
                // Store in chat history
                window.currentMetricState.chatHistory = [
                    { role: 'user', message: userMessage, timestamp: Date.now() },
                    { role: 'agent', message: agentMessage, timestamp: Date.now() }
                ];
                
                // Set innerHTML directly
                chatHistory.innerHTML = `
                    <div style="padding: 10px; margin-bottom: 8px; background: #dbeafe; color: #1e40af; border-left: 4px solid #1d72f3; border-radius: 4px; font-size: 13px; line-height: 1.5;">
                        <strong>You:</strong> ${userMessage}
                    </div>
                    <div style="padding: 10px; margin-bottom: 8px; background: #f0fdf4; color: #166534; border-left: 4px solid #10b981; border-radius: 4px; font-size: 13px; line-height: 1.5;">
                        <strong>Agent:</strong> ${agentMessage}
                    </div>
                `;
                
                console.log(' Messages added directly via innerHTML. Children:', chatHistory.children.length);
                
                // Scroll to bottom
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }, 200);
            
            console.log('Chat initialized. Stored history:', window.currentMetricState.chatHistory.length, 'messages, DOM:', chatHistory.children.length);
            
            // Verify chat history is visible
            setTimeout(() => {
                verifyChatHistory();
            }, 100);
            
            // Clear input and focus on chat input
            document.getElementById('metricAgentInput').value = '';
            
            // Focus on the refinement input
            setTimeout(() => {
                document.getElementById('metricRefinementInput').focus();
            }, 150);
        }
        
        function buildFormulaText(name, attr1, attr2, formula, operator, threshold) {
            let formulaText = '';
            if (formula === 'DIVIDE') {
                formulaText = `${attr1} / ${attr2} ${operator} ${threshold}`;
            } else if (formula === 'SUM') {
                formulaText = `${attr1} ${attr2 ? '+ ' + attr2 : ''} ${operator} ${threshold}`;
            } else if (formula === 'MULTIPLY') {
                formulaText = `${attr1}  ${attr2} ${operator} ${threshold}`;
            } else if (formula === 'AVG') {
                formulaText = `AVG(${attr1}${attr2 ? ', ' + attr2 : ''}) ${operator} ${threshold}`;
            } else if (formula === 'COUNT') {
                formulaText = `COUNT(${attr1}) ${operator} ${threshold}`;
            }
            return formulaText;
        }
        
        function updateMetricFormulaPreview() {
            const state = window.currentMetricState;
            const formulaText = document.getElementById('formulaPreview').textContent || buildFormulaText(state.name, state.attr1, state.attr2, state.formula, state.operator, state.threshold);
            
            document.getElementById('metricFormulaPreview').innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <div style="font-size: 0.875rem; font-weight: 600; color: #1d72f3; margin-bottom: 0.375rem;">${state.name}</div>
                    <div style="padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.25rem; font-family: 'Courier New', monospace; font-size: 0.75rem; color: #374151; word-break: break-word;">
                        ${formulaText}
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.625rem;">
                    <div style="flex: 1; padding: 0.375rem 0.5rem; background: white; border: 1px solid #bae6fd; border-radius: 0.25rem; text-align: center;">
                        <div style="font-size: 0.6875rem; color: #6b7280; margin-bottom: 0.125rem;">Operator</div>
                        <div style="font-size: 0.8125rem; font-weight: 600; color: #0c4a6e;">${state.operator}</div>
                    </div>
                    <div style="flex: 1; padding: 0.375rem 0.5rem; background: white; border: 1px solid #bae6fd; border-radius: 0.25rem; text-align: center;">
                        <div style="font-size: 0.6875rem; color: #6b7280; margin-bottom: 0.125rem;">Threshold</div>
                        <div style="font-size: 0.8125rem; font-weight: 600; color: #0c4a6e;">${state.threshold}</div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.375rem;">
                    <button onclick="saveCustomMetric()" style="flex: 1; padding: 0.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; cursor: pointer;">
                         Add to Segment
                    </button>
                    <button onclick="toggleManualForm()" style="flex: 1; padding: 0.5rem; background: white; color: #374151; border: 1px solid #d1d5db; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; cursor: pointer;">
                        Edit Manually
                    </button>
                </div>
            `;
        }
        
        function verifyChatHistory() {
            const chatHistory = document.getElementById('metricChatHistory');
            if (!chatHistory) {
                console.error(' Chat history DOM element not found');
                return;
            }
            
            const domCount = chatHistory.children.length;
            const storedCount = window.currentMetricState?.chatHistory?.length || 0;
            
            console.log(' Chat History Status:');
            console.log('  - DOM messages:', domCount);
            console.log('  - Stored messages:', storedCount);
            console.log('  - Element visible:', chatHistory.offsetParent !== null);
            console.log('  - Element height:', chatHistory.offsetHeight);
            
            if (domCount !== storedCount) {
                console.warn(' MISMATCH: DOM has', domCount, 'messages but storage has', storedCount);
            }
            
            return { domCount, storedCount };
        }
        
        function rebuildChatDisplay() {
            const chatHistory = document.getElementById('metricChatHistory');
            if (!chatHistory || !window.currentMetricState || !window.currentMetricState.chatHistory) {
                console.error('Cannot rebuild chat - missing elements');
                return;
            }
            
            console.log(' Rebuilding chat display from', window.currentMetricState.chatHistory.length, 'stored messages');
            
            // Build HTML string from all messages
            let html = '';
            window.currentMetricState.chatHistory.forEach(msg => {
                if (msg.role === 'user') {
                    html += `<div style="padding: 10px; margin-bottom: 8px; background: #dbeafe; color: #1e40af; border-left: 4px solid #1d72f3; border-radius: 4px; font-size: 13px; line-height: 1.5;">
                        <strong>You:</strong> ${msg.message}
                    </div>`;
                } else {
                    html += `<div style="padding: 10px; margin-bottom: 8px; background: #f0fdf4; color: #166534; border-left: 4px solid #10b981; border-radius: 4px; font-size: 13px; line-height: 1.5;">
                        <strong>Agent:</strong> ${msg.message}
                    </div>`;
                }
            });
            
            // Set all at once
            chatHistory.innerHTML = html;
            
            console.log(' Chat display rebuilt. DOM children:', chatHistory.children.length);
            
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        function restoreChatHistory() {
            // This function is now deprecated, use rebuildChatDisplay instead
            rebuildChatDisplay();
        }
        
        function addChatMessage(role, message) {
            console.log(' addChatMessage called with role:', role, 'message:', message);
            
            const chatHistory = document.getElementById('metricChatHistory');
            console.log(' Found chatHistory element?', !!chatHistory);
            
            if (!chatHistory) {
                console.error(' Chat history element not found');
                alert('ERROR: Chat history element not found!');
                return;
            }
            
            console.log(` Adding ${role} message:`, message);
            
            // Store in persistent history
            if (window.currentMetricState && window.currentMetricState.chatHistory) {
                window.currentMetricState.chatHistory.push({
                    role: role,
                    message: message,
                    timestamp: Date.now()
                });
                console.log('Stored in history. Total messages:', window.currentMetricState.chatHistory.length);
            }
            
            const messageDiv = document.createElement('div');
            console.log('Created messageDiv element:', messageDiv);
            
            if (role === 'user') {
                // More visible styling for user messages
                messageDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: #dbeafe; color: #1e40af; border-left: 4px solid #1d72f3; border-radius: 4px; font-size: 13px; line-height: 1.5;';
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
                console.log('User message HTML set:', messageDiv.innerHTML);
            } else {
                // More visible styling for agent messages
                messageDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: #f0fdf4; color: #166534; border-left: 4px solid #10b981; border-radius: 4px; font-size: 13px; line-height: 1.5;';
                messageDiv.innerHTML = `<strong>Agent:</strong> ${message}`;
                console.log('Agent message HTML set:', messageDiv.innerHTML);
            }
            
            console.log('About to appendChild to chatHistory...');
            console.log('chatHistory before append:', chatHistory.children.length, 'children');
            chatHistory.appendChild(messageDiv);
            console.log('After appendChild:', chatHistory.children.length, 'children');
            console.log('Message appended to DOM, total messages now:', chatHistory.children.length);
            console.log('chatHistory innerHTML length:', chatHistory.innerHTML.length);
            
            // Scroll to bottom
            setTimeout(() => {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }, 10);
        }
        
        function refineMetricFromChat() {
            const input = document.getElementById('metricRefinementInput').value.trim();
            if (!input) return;
            
            console.log('=== REFINING METRIC ===');
            console.log('User input:', input);
            console.log('Current chat history length:', window.currentMetricState?.chatHistory?.length || 0);
            
            // Check if currentMetricState exists
            if (!window.currentMetricState) {
                console.error('No current metric state found');
                alert('Please build a metric first before refining');
                return;
            }
            
            // Add user message to chat history
            console.log('Adding user message to chat...');
            window.currentMetricState.chatHistory.push({
                role: 'user',
                message: input,
                timestamp: Date.now()
            });
            console.log('After adding user message, history length:', window.currentMetricState.chatHistory.length);
            
            // Clear input
            document.getElementById('metricRefinementInput').value = '';
            
            // Parse refinement command
            const lowerInput = input.toLowerCase();
            const state = window.currentMetricState;
            let updated = false;
            let changes = [];
            
            console.log('Current state:', state);
            
            // Check for threshold changes - very flexible matching
            const thresholdMatch = input.match(/(\d+(?:\.\d+)?)/);
            if (thresholdMatch) {
                // If there's a number and certain keywords, or if ONLY a number is provided
                const hasKeyword = lowerInput.includes('threshold') || 
                    lowerInput.includes('value') || 
                    lowerInput.includes('change') ||
                    lowerInput.includes('make') ||
                    lowerInput.includes('set') ||
                    lowerInput.includes('use') ||
                    lowerInput.includes('to');
                
                // Also match if input is mostly just a number
                const isJustNumber = input.trim() === thresholdMatch[1];
                
                if (hasKeyword || isJustNumber) {
                    const oldThreshold = state.threshold;
                    state.threshold = thresholdMatch[1];
                    changes.push(`threshold from ${oldThreshold} to ${state.threshold}`);
                    updated = true;
                    console.log('Updated threshold to:', state.threshold);
                }
            }
            
            // Check for operator changes - more comprehensive
            const operatorChanged = false;
            if (lowerInput.includes('greater than') || lowerInput.includes('more than') || (lowerInput.includes('use') && lowerInput.includes('>'))) {
                if (state.operator !== '>') {
                    changes.push(`operator to "greater than (>)"`);
                    state.operator = '>';
                    updated = true;
                }
            } else if (lowerInput.includes('less than') || lowerInput.includes('below') || (lowerInput.includes('use') && lowerInput.includes('<'))) {
                if (state.operator !== '<') {
                    changes.push(`operator to "less than (<)"`);
                    state.operator = '<';
                    updated = true;
                }
            } else if (lowerInput.includes('at least') || lowerInput.includes('minimum') || lowerInput.includes('>=')) {
                if (state.operator !== '>=') {
                    changes.push(`operator to "at least ()"`);
                    state.operator = '>=';
                    updated = true;
                }
            } else if (lowerInput.includes('at most') || lowerInput.includes('maximum') || lowerInput.includes('<=')) {
                if (state.operator !== '<=') {
                    changes.push(`operator to "at most ()"`);
                    state.operator = '<=';
                    updated = true;
                }
            }
            
            // Check for attribute changes
            if (lowerInput.includes('spend') || lowerInput.includes('spending')) {
                if (state.attr1 !== 'TotalSpend') {
                    state.attr1 = 'TotalSpend';
                    changes.push(`attribute to "Total Spend"`);
                    updated = true;
                }
            }
            if (lowerInput.includes('revenue')) {
                if (state.attr1 !== 'Revenue') {
                    state.attr1 = 'Revenue';
                    changes.push(`attribute to "Revenue"`);
                    updated = true;
                }
            }
            if (lowerInput.includes('order') && lowerInput.includes('count')) {
                if (!state.attr2 || state.attr2 !== 'OrderCount') {
                    state.attr2 = 'OrderCount';
                    changes.push(`second attribute to "Order Count"`);
                    updated = true;
                }
            }
            if (lowerInput.includes('lifetime') && lowerInput.includes('value')) {
                if (state.attr1 !== 'LifetimeValue') {
                    state.attr1 = 'LifetimeValue';
                    changes.push(`attribute to "Lifetime Value"`);
                    updated = true;
                }
            }
            
            // Check for name changes
            if (lowerInput.includes('rename') || lowerInput.includes('call it') || lowerInput.includes('name it')) {
                const nameMatch = input.match(/(?:rename|call it|name it)\s+["']?([^"']+)["']?/i);
                if (nameMatch && nameMatch[1]) {
                    state.name = nameMatch[1].trim();
                    changes.push(`name to "${state.name}"`);
                    updated = true;
                }
            }
            
            if (updated) {
                console.log('Changes detected:', changes);
                console.log('Updated state:', state);
                
                // Update the form
                document.getElementById('metricNameInput').value = state.name;
                document.getElementById('metricAttribute1').value = state.attr1;
                document.getElementById('metricAttribute2').value = state.attr2;
                document.getElementById('metricFormula').value = state.formula;
                document.getElementById('metricOperator').value = state.operator;
                document.getElementById('metricThreshold').value = state.threshold;
                
                // Trigger preview update
                const event = new Event('change');
                document.getElementById('metricAttribute1').dispatchEvent(event);
                
                // Update the formula preview panel
                updateMetricFormulaPreview();
                
                console.log('Formula preview updated');
                
                // Add agent response with specific changes
                const changeText = changes.length > 0 ? changes.join(', ') : 'the metric';
                console.log('Adding agent response...');
                const agentMsg = `Yes, I'll make those changes.  Updated ${changeText}. Check the formula on the right `;
                window.currentMetricState.chatHistory.push({
                    role: 'agent',
                    message: agentMsg,
                    timestamp: Date.now()
                });
                console.log('After adding agent response, history length:', window.currentMetricState.chatHistory.length);
            } else {
                console.log('No changes detected from input:', input);
                // Agent couldn't understand
                console.log('Adding "not understood" message...');
                const helpMsg = `I'm not quite sure what you'd like to change. Could you try:<br> "1000" or "change to 1000"<br> "use greater than"<br> "rename to High Spenders"`;
                window.currentMetricState.chatHistory.push({
                    role: 'agent',
                    message: helpMsg,
                    timestamp: Date.now()
                });
                console.log('After adding agent message, history length:', window.currentMetricState.chatHistory.length);
            }
            
            console.log('=== REFINEMENT COMPLETE ===');
            console.log('Total conversation history:', window.currentMetricState.chatHistory.length, 'messages');
            
            // Rebuild the chat display from stored history
            rebuildChatDisplay();
        }

        function addQuickMetric(name, attr1, attr2, formula, operator, threshold, timeWindow) {
            // Ensure metric builder is visible
            const builder = document.getElementById('inlineMetricBuilder');
            if (builder.style.display === 'none') {
                builder.style.display = 'block';
            }
            
            // Populate form fields
            document.getElementById('metricNameInput').value = name;
            document.getElementById('metricAttribute1').value = attr1;
            if (attr2) {
                document.getElementById('metricAttribute2').value = attr2;
            } else {
                document.getElementById('metricAttribute2').value = '';
            }
            
            // Set formula based on the operation
            const formulaSelect = document.getElementById('metricFormula');
            let formulaValue = '';
            if (formula === 'divide') {
                formulaValue = 'DIVIDE';
                formulaSelect.value = 'DIVIDE';
            } else if (formula === 'add') {
                formulaValue = 'SUM';
                formulaSelect.value = 'SUM';
            } else if (formula === 'none') {
                formulaValue = 'COUNT';
                formulaSelect.value = 'COUNT';
            }
            
            document.getElementById('metricOperator').value = operator;
            document.getElementById('metricThreshold').value = threshold;
            
            // Set time window
            const timeWindowSelect = document.getElementById('metricTimeWindow');
            if (timeWindow === '7days') {
                timeWindowSelect.value = '7days';
            } else if (timeWindow === '30days') {
                timeWindowSelect.value = '30days';
            } else if (timeWindow === '90days') {
                timeWindowSelect.value = '90days';
            } else if (timeWindow === 'currentyear') {
                timeWindowSelect.value = 'currentyear';
            } else {
                timeWindowSelect.value = 'all';
            }
            
            // Trigger preview update
            const event = new Event('change');
            document.getElementById('metricAttribute1').dispatchEvent(event);
            
            // Store current metric in global variable
            window.currentMetricState = {
                name: name,
                attr1: attr1,
                attr2: attr2,
                formula: formulaValue,
                operator: operator,
                threshold: threshold,
                originalInput: `I want to use: ${name}`,
                chatHistory: [] // Store conversation history
            };
            
            // Switch to conversational view
            console.log('Quick metric: Switching to conversational view');
            const initialInput = document.getElementById('metricInitialInput');
            const conversationalView = document.getElementById('metricConversationalView');
            
            if (initialInput) initialInput.style.display = 'none';
            if (conversationalView) {
                conversationalView.style.display = 'block';
                console.log('Quick metric: Conversational view should now be visible');
            } else {
                console.error('Quick metric: Conversational view element not found!');
            }
            
            // Update formula preview panel
            updateMetricFormulaPreview();
            
            // Initialize chat history
            const chatHistory = document.getElementById('metricChatHistory');
            if (!chatHistory) {
                console.error('Chat history element not found!');
                return;
            }
            
            console.log('Quick metric selected:', name);
            console.log('Initializing chat history for quick metric');
            
            // Wait for DOM to be ready, then add messages
            setTimeout(() => {
                const chatHistory = document.getElementById('metricChatHistory');
                if (!chatHistory) {
                    console.error(' Quick metric - Chat history not found after delay');
                    return;
                }
                
                console.log(' Quick metric - Chat history element ready');
                
                // Build messages as HTML string
                const userMessage = `I want to use: ${name}`;
                const agentMessage = ` Selected <strong>${name}</strong>. You can see the formula on the right <br><br>Want to make changes? Just type your request below.`;
                
                // Store in chat history
                window.currentMetricState.chatHistory = [
                    { role: 'user', message: userMessage, timestamp: Date.now() },
                    { role: 'agent', message: agentMessage, timestamp: Date.now() }
                ];
                
                // Set innerHTML directly
                chatHistory.innerHTML = `
                    <div style="padding: 10px; margin-bottom: 8px; background: #dbeafe; color: #1e40af; border-left: 4px solid #1d72f3; border-radius: 4px; font-size: 13px; line-height: 1.5;">
                        <strong>You:</strong> ${userMessage}
                    </div>
                    <div style="padding: 10px; margin-bottom: 8px; background: #f0fdf4; color: #166534; border-left: 4px solid #10b981; border-radius: 4px; font-size: 13px; line-height: 1.5;">
                        <strong>Agent:</strong> ${agentMessage}
                    </div>
                `;
                
                console.log(' Quick metric messages added. Children:', chatHistory.children.length);
                
                // Scroll to bottom
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }, 200);
            
            // Focus on the chat input
            setTimeout(() => {
                document.getElementById('metricRefinementInput').focus();
            }, 150);
        }

        function closeMetricBuilder() {
            const builder = document.getElementById('inlineMetricBuilder');
            builder.style.display = 'none';
            
            // Reset views - show initial input, hide conversational view
            document.getElementById('metricInitialInput').style.display = 'block';
            document.getElementById('metricConversationalView').style.display = 'none';
            
            // Hide manual form
            document.getElementById('manualMetricForm').style.display = 'none';
            
            // Reset form
            document.getElementById('metricAgentInput').value = '';
            document.getElementById('metricRefinementInput').value = '';
            document.getElementById('metricExamples').style.display = 'none';
            document.getElementById('metricNameInput').value = '';
            document.getElementById('metricAttribute1').value = '';
            document.getElementById('metricAttribute2').value = '';
            document.getElementById('metricFormula').value = '';
            document.getElementById('metricOperator').value = '>';
            document.getElementById('metricThreshold').value = '';
            
            // Clear chat history
            document.getElementById('metricChatHistory').innerHTML = '';
            
            // Clear current metric state
            window.currentMetricState = null;
            document.getElementById('formulaPreview').textContent = 'Select attributes and formula to see preview';
            
            // Remove any guidance or confirmation messages
            const guidance = builder.querySelector('[style*="fef3c7"]');
            if (guidance) guidance.remove();
            const confirmation = builder.querySelector('[style*="ecfdf5"]');
            if (confirmation) confirmation.remove();
        }

        function saveCustomMetric() {
            const metricName = document.getElementById('metricNameInput').value.trim();
            const attr1 = document.getElementById('metricAttribute1').value;
            const attr2 = document.getElementById('metricAttribute2').value;
            const formula = document.getElementById('metricFormula').value;
            const operator = document.getElementById('metricOperator').value;
            const threshold = document.getElementById('metricThreshold').value;
            
            // Validation
            if (!metricName) {
                alert('Please enter a metric name');
                return;
            }
            if (!attr1) {
                alert('Please select at least one attribute');
                return;
            }
            if (!formula) {
                alert('Please select a formula');
                return;
            }
            if (!threshold) {
                alert('Please enter a threshold value');
                return;
            }
            
            // Build formula string
            let formulaStr = '';
            if (formula === 'SUM') {
                formulaStr = attr2 ? `${attr1} + ${attr2}` : `SUM(${attr1})`;
            } else if (formula === 'AVG') {
                formulaStr = attr2 ? `(${attr1} + ${attr2}) / 2` : `AVG(${attr1})`;
            } else if (formula === 'DIVIDE') {
                formulaStr = attr2 ? `${attr1} / ${attr2}` : `${attr1} / 1`;
            } else if (formula === 'MULTIPLY') {
                formulaStr = attr2 ? `${attr1}  ${attr2}` : `${attr1}  1`;
            } else if (formula === 'COUNT') {
                formulaStr = `COUNT(${attr1})`;
            } else if (formula === 'MIN') {
                formulaStr = `MIN(${attr1})`;
            } else if (formula === 'MAX') {
                formulaStr = `MAX(${attr1})`;
            }
            
            // Build filter string for display
            const filterString = `${metricName}: ${operator} ${threshold}`;
            
            // Add to segment using existing function
            addQuickFilter(filterString, '', exclusionMode, 'metric');
            
            // Show success message before closing
            const successMsg = document.createElement('div');
            successMsg.textContent = ` Custom metric "${metricName}" added to segment`;
            successMsg.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #10b981; color: white; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;';
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
            
            // Close builder
            closeMetricBuilder();
        }

        // Update formula preview as user selects options
        document.addEventListener('DOMContentLoaded', function() {
            const attr1Select = document.getElementById('metricAttribute1');
            const attr2Select = document.getElementById('metricAttribute2');
            const formulaSelect = document.getElementById('metricFormula');
            const operatorSelect = document.getElementById('metricOperator');
            const thresholdInput = document.getElementById('metricThreshold');
            
            if (attr1Select && attr2Select && formulaSelect && operatorSelect && thresholdInput) {
                const updatePreview = () => {
                    const attr1 = attr1Select.value;
                    const attr2 = attr2Select.value;
                    const formula = formulaSelect.value;
                    const operator = operatorSelect.value;
                    const threshold = thresholdInput.value;
                    
                    const preview = document.getElementById('formulaPreview');
                    if (!attr1 || !formula) {
                        preview.textContent = 'Select attributes and formula to see preview';
                        return;
                    }
                    
                    let formulaStr = '';
                    if (formula === 'SUM') {
                        formulaStr = attr2 ? `${attr1} + ${attr2}` : `SUM(${attr1})`;
                    } else if (formula === 'AVG') {
                        formulaStr = attr2 ? `(${attr1} + ${attr2}) / 2` : `AVG(${attr1})`;
                    } else if (formula === 'DIVIDE') {
                        formulaStr = attr2 ? `${attr1} / ${attr2}` : `${attr1}`;
                    } else if (formula === 'MULTIPLY') {
                        formulaStr = attr2 ? `${attr1}  ${attr2}` : `${attr1}`;
                    } else if (formula === 'COUNT') {
                        formulaStr = `COUNT(${attr1})`;
                    } else if (formula === 'MIN') {
                        formulaStr = `MIN(${attr1})`;
                    } else if (formula === 'MAX') {
                        formulaStr = `MAX(${attr1})`;
                    }
                    
                    const fullFormula = threshold ? `${formulaStr} ${operator} ${threshold}` : formulaStr;
                    preview.textContent = fullFormula;
                };
                
                attr1Select.addEventListener('change', updatePreview);
                attr2Select.addEventListener('change', updatePreview);
                formulaSelect.addEventListener('change', updatePreview);
                operatorSelect.addEventListener('change', updatePreview);
                thresholdInput.addEventListener('input', updatePreview);
            }
        });

        function updateAudienceDisplay() {
            // Update final audience in Save & Activate tab
            const finalAudience = document.getElementById('finalAudience');
            if (finalAudience) {
                finalAudience.textContent = currentAudience.toLocaleString();
            }
            
            // Update toolbar audience count
            const toolbarAudienceElement = document.getElementById('toolbarAudienceCount');
            if (toolbarAudienceElement) {
                toolbarAudienceElement.textContent = currentAudience.toLocaleString();
            }
        }

        function updateDistributionChart(attribute) {
            console.log('Switching distribution chart to:', attribute);
            // In a real implementation, this would update the charts based on selected attribute
            // For now, it just logs the selection
        }

        function updateSplit(value) {
            const percentA = parseInt(value);
            const percentB = 100 - percentA;
            
            document.getElementById('splitA').textContent = percentA;
            document.getElementById('splitB').textContent = percentB;
            document.getElementById('splitACard').textContent = percentA;
            document.getElementById('splitBCard').textContent = percentB;
            
            const audienceA = Math.floor(currentAudience * percentA / 100);
            const audienceB = currentAudience - audienceA;
            
            document.getElementById('audienceA').textContent = audienceA.toLocaleString();
            document.getElementById('audienceB').textContent = audienceB.toLocaleString();
            
            // Update slider gradient
            const slider = document.getElementById('splitSlider');
            slider.style.background = `linear-gradient(to right, #1d72f3 0%, #1d72f3 ${percentA}%, #10b981 ${percentA}%, #10b981 100%)`;
        }

        function resetSplit() {
            document.getElementById('splitSlider').value = 50;
            updateSplit(50);
        }

        // Close quick filters when clicking outside
        document.addEventListener('click', function(event) {
            const trigger = event.target.closest('.quick-filters-trigger');
            const panel = document.getElementById('quickFiltersPanel');
            const arrow = document.getElementById('triggerArrow');
            
            if (!trigger && !event.target.closest('.quick-filters-panel') && panel.classList.contains('open')) {
                panel.classList.remove('open');
                arrow.classList.remove('open');
            }
        });

        // ========================================
        // GLOBAL AGENTIC COMMAND BAR
        // ========================================

        // Global agent state
        const agentState = {
            currentTab: 0,
            pendingAction: null,
            isProcessing: false,
            chatHistory: [],
            isExpanded: true,
            awaitingConfirmation: false,
            pendingActionData: null
        };

        // Comprehensive action database - maps natural language to UI actions
        const actionDatabase = {
            // SEGMENT DEFINITION TAB (0)
            segmentDefinition: {
                tab: 0,
                name: 'Segment Definition',
                keywords: ['filter', 'segment', 'attribute', 'definition', 'criteria', 'add', 'include', 'exclude'],
                actions: {
                    'age': { 
                        patterns: ['age', 'age group', 'age range', '25-45', 'age 25', 'older', 'younger', 'millennials'],
                        execute: () => addQuickFilter('Age: 25-44', '', false, 'filter'),
                        confirm: 'add Age 25-44 filter (Millennials and Gen X)'
                    },
                    'gender_female': { 
                        patterns: ['female', 'women', 'woman', 'she', 'her'],
                        execute: () => addQuickFilter('Gender: Female', '', false, 'attribute'),
                        confirm: 'add Female gender filter'
                    },
                    'gender_male': { 
                        patterns: ['male', 'men', 'man', 'he', 'him'],
                        execute: () => addQuickFilter('Gender: Male', '', false, 'attribute'),
                        confirm: 'add Male gender filter'
                    },
                    'ltv': { 
                        patterns: ['high ltv', 'lifetime value', 'high value', 'ltv', 'valuable', 'high spending'],
                        execute: () => addQuickFilter('Lifetime Value: > $100', '', false, 'metric'),
                        confirm: 'add High Lifetime Value filter (>$100)'
                    },
                    'premium': { 
                        patterns: ['premium', 'premium tier', 'premium customer', 'vip', 'top tier'],
                        execute: () => addQuickFilter('Loyalty Tier: Gold or Platinum', '', false, 'filter'),
                        confirm: 'add Premium Tier filter (Gold or Platinum)'
                    },
                    'active': { 
                        patterns: ['active', 'active status', 'active customer', 'engaged'],
                        execute: () => addQuickFilter('Email Status: Active', '', false, 'attribute'),
                        confirm: 'add Active Status filter'
                    },
                    'email_opted': { 
                        patterns: ['email', 'email opted', 'opted in', 'email preference', 'subscribed'],
                        execute: () => addQuickFilter('Email Opens: Last 30 days', '', false, 'filter'),
                        confirm: 'add Email Engaged filter (opened in last 30 days)'
                    },
                    'recent_purchase': { 
                        patterns: ['recent purchase', 'recent buy', 'recently bought', 'recent activity'],
                        execute: () => addQuickFilter('Purchase Date: Last 60 days', '', false, 'filter'),
                        confirm: 'add Recent Purchase filter (last 60 days)'
                    },
                    'location': { 
                        patterns: ['location', 'region', 'geography', 'area', 'city', 'state'],
                        execute: () => addQuickFilter('Region: Pacific Northwest', '', false, 'filter'),
                        confirm: 'add Pacific Northwest Region filter (WA, OR, ID)'
                    },
                    'income': { 
                        patterns: ['income', 'salary', 'earnings', 'high income', 'wealthy'],
                        execute: () => addQuickFilter('Income Level: > $100k', '', false, 'attribute'),
                        confirm: 'add High Income filter (>$100k annually)'
                    },
                    'loyalty': { 
                        patterns: ['loyalty', 'loyal', 'repeat', 'frequent buyer', 'returning'],
                        execute: () => addQuickFilter('Loyalty Tier: Gold or Platinum', '', false, 'filter'),
                        confirm: 'add Loyalty Members filter (Gold+)'
                    },
                    'outdoor': { 
                        patterns: ['outdoor', 'hiking', 'camping', 'nature', 'adventure'],
                        execute: () => addQuickFilter('Interest: Winter Sports', '', false, 'filter'),
                        confirm: 'add Outdoor/Winter Enthusiast filter'
                    },
                    // Exclusion filters
                    'exclude_contacted': { 
                        patterns: ['exclude contacted', 'exclude recent contact', 'not contacted', 'exclude 7 days', 'exclude last week'],
                        execute: () => addQuickFilter('Contact Recency: less than 7 days', 'exclusion', true),
                        confirm: 'exclude customers contacted in last 7 days'
                    },
                    'exclude_age': { 
                        patterns: ['exclude age', 'exclude young', 'exclude old', 'not age'],
                        execute: () => addQuickFilter('Age Group: Under 25', 'exclusion', true),
                        confirm: 'exclude Age Group Under 25'
                    },
                    'exclude_device': { 
                        patterns: ['exclude mobile', 'exclude device', 'not mobile', 'exclude desktop'],
                        execute: () => addQuickFilter('Device: Mobile', 'exclusion', true),
                        confirm: 'exclude Mobile device users'
                    },
                    'exclude_region': { 
                        patterns: ['exclude region', 'exclude location', 'not in region', 'exclude area'],
                        execute: () => addQuickFilter('Region: Specific Area', 'exclusion', true),
                        confirm: 'exclude specific region'
                    }
                }
            },

            // RANK AND LIMIT TAB (1)
            rankLimit: {
                tab: 1,
                name: 'Rank and Limit',
                keywords: ['rank', 'limit', 'group', 'grl', 'top', 'prioritize', 'sort', 'order'],
                actions: {
                    'explain': {
                        patterns: ['explain', 'what is', 'how does', 'help', 'info', 'tell me about'],
                        execute: () => {},
                        respond: 'Rank and Limit lets you prioritize your segment. Group by attributes, rank by metrics (like LTV or recency), and set a limit on how many customers to target.'
                    },
                    'set_limit': {
                        patterns: ['set limit', 'limit to', 'top 1000', 'top 5000', 'limit 500', 'restrict to'],
                        execute: () => {},
                        respond: 'You can set the limit using the Limit field. Try values like 500, 1000, or 5000 depending on your segment size.'
                    }
                }
            },

            // SEGMENT PREVIEW TAB (2)
            segmentPreview: {
                tab: 2,
                name: 'Segment Preview',
                keywords: ['preview', 'sample', 'records', 'data', 'view', 'show data', 'records', 'population'],
                actions: {
                    'view_records': {
                        patterns: ['show records', 'view data', 'see sample', 'preview data', 'show population'],
                        execute: () => {},
                        respond: 'Here you can see a sample of 50 records from your segment, along with key insights like average LTV, total spend, and demographic breakdowns.'
                    }
                }
            },

            // SEGMENT INSIGHTS TAB (3)
            segmentInsights: {
                tab: 3,
                name: 'Segment Insights',
                keywords: ['insights', 'analysis', 'composition', 'risk', 'behavior', 'impact', 'overview', 'metrics'],
                actions: {
                    'view_insights': {
                        patterns: ['show insights', 'view analysis', 'see composition', 'show metrics', 'overview'],
                        execute: () => {},
                        respond: 'This tab shows comprehensive insights including audience composition, risk distribution, churn scores, overlap analysis, and projected business impact of your segment.'
                    }
                }
            },

            // OVERLAP ANALYSIS TAB (4)
            overlapAnalysis: {
                tab: 4,
                name: 'Overlap Analysis',
                keywords: ['overlap', 'overlap analysis', 'segment overlap', 'common', 'intersection', 'shared', 'venn'],
                actions: {
                    'view_overlap': {
                        patterns: ['show overlap', 'view overlap', 'see overlap', 'overlap with', 'compare segments'],
                        execute: () => {},
                        respond: 'You can compare your segment with other active and historical segments to see how much overlap exists. Use the dropdown to select which segment to compare with.'
                    }
                }
            },

            // CHANNEL AFFINITY TAB (5)
            channelAffinity: {
                tab: 5,
                name: 'Channel Affinity',
                keywords: ['channel', 'affinity', 'email', 'sms', 'push', 'in-app', 'notification', 'message', 'contact'],
                actions: {
                    'view': {
                        patterns: ['show', 'view', 'see', 'display', 'what are', 'channel preference'],
                        execute: () => {},
                        respond: 'Here you can see which channels your segment prefers: Email (45%), SMS (22%), Push (15%), and In-App (18%). Each channel also shows the best time to send.'
                    },
                    'best_time': {
                        patterns: ['best time', 'when to send', 'optimal time', 'timing', 'schedule'],
                        execute: () => {},
                        respond: 'The best times to reach this segment are: Email (6-8 PM), SMS (10 AM-12 PM), Push (7-9 PM), and In-App (12-2 PM).'
                    }
                }
            },

            // SMART SPLITS TAB (6)
            smartSplits: {
                tab: 6,
                name: 'Smart Splits',
                keywords: ['split', 'variant', 'test', 'a/b', 'control', 'experiment', 'version'],
                actions: {
                    'add_split': {
                        patterns: ['add split', 'create split', 'new split', 'add variant', 'another split'],
                        execute: () => {
                            const splits = document.querySelectorAll('.split-card').length;
                            if (splits < 4) {
                                alert('Click the "+ Add Split" button to create a new variant');
                            }
                        },
                        respond: 'Click the "+ Add Split" button below to create a new test variant. You can have up to 4 splits for thorough testing.'
                    },
                    'explain': {
                        patterns: ['explain', 'why split', 'what is', 'how does', 'benefit', 'why use'],
                        execute: () => {},
                        respond: 'Smart Splits let you A/B test different approaches with your segment. Test different messages, offers, or channels to see what works best before rolling out to everyone.'
                    }
                }
            },

            // ACTIVATE TAB (7)
            activate: {
                tab: 7,
                name: 'Activate',
                keywords: ['activate', 'launch', 'deploy', 'send', 'start', 'go live', 'create template', 'template', 'journey', 'workflow'],
                actions: {
                    'activate_segment': {
                        patterns: ['activate', 'launch', 'start', 'deploy', 'go live', 'send'],
                        execute: () => {},
                        respond: 'Select an activation template and click "Activate Segment" to launch your segment. You can choose multi-channel, email-only, or custom workflows.'
                    },
                    'create_template': {
                        patterns: [
                            'create template', 'build template', 'new template', 'custom template', 'make template',
                            'send email', 'send sms', 'send whatsapp', 'send push',
                            'if opened', 'if clicked', 'if not',
                            'journey', 'workflow', 'set up journey', 'configure journey'
                        ],
                        execute: (input) => {
                            // Create template - always delay slightly for UI responsiveness
                            setTimeout(() => createTemplateFromAgent(input || ''), 300);
                        },
                        confirm: 'create a custom template',
                        respond: 'Creating a custom template for you based on your journey...'
                    }
                }
            },

            // SEGMENT PERFORMANCE TAB (8)
            segmentPerformance: {
                tab: 8,
                name: 'Segment Performance',
                keywords: ['performance', 'results', 'metrics', 'success', 'roi', 'conversion', 'engagement'],
                actions: {
                    'view_results': {
                        patterns: ['show results', 'view performance', 'see metrics', 'how did it perform', 'results'],
                        execute: () => {
                            setTimeout(() => {
                                const overlapSection = document.querySelector('.overlap-section');
                                if (overlapSection) {
                                    overlapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 300);
                        },
                        respond: 'Here\'s the segment overlap analysis showing how your segment intersects with other segments.'
                    },
                    'demographics': {
                        patterns: ['demographic', 'demographics', 'gender', 'age', 'profile', 'audience'],
                        execute: () => {
                            setTimeout(() => {
                                const insightsGrid = document.querySelector('.insights-grid');
                                if (insightsGrid) {
                                    insightsGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 300);
                        },
                        respond: 'Here are the demographic insights for your segment including gender ratio, age distribution, and reachable audience.'
                    },
                    'reach': {
                        patterns: ['reach', 'reachable', 'audience size', 'how many', 'size'],
                        execute: () => {},
                        respond: 'Your segment has a total reachable audience shown in the insights cards above. Check "Total Reachable" for the exact count.'
                    }
                }
            },

            // ACTIVATE TAB (5)
            activate: {
                tab: 5,
                name: 'Activate',
                keywords: ['activate', 'launch', 'deploy', 'template', 'start', 'begin', 'go live'],
                actions: {
                    'template': {
                        patterns: ['template', 'select template', 'choose template', 'activation template', 'use template'],
                        execute: () => {},
                        respond: 'Select an activation template from the dropdown above. Templates include Email Activation, Multi-Channel Journey, and SMS Blast options.'
                    },
                    'launch': {
                        patterns: ['launch', 'activate', 'start', 'go', 'deploy', 'begin'],
                        execute: () => {},
                        respond: 'Once you\'ve selected a template, click the "Activate Segment" button to launch your segment activation.'
                    }
                }
            },

            // SEGMENT PERFORMANCE TAB (6)
            performance: {
                tab: 6,
                name: 'Segment Performance',
                keywords: ['performance', 'results', 'metrics', 'stats', 'how did', 'success', 'outcome'],
                actions: {
                    'view': {
                        patterns: ['show', 'view', 'see', 'results', 'how did', 'performance'],
                        execute: () => {},
                        respond: 'Here are the performance metrics for your segment including engagement rates, conversion rates, and ROI across all splits.'
                    },
                    'recommendations': {
                        patterns: ['recommend', 'suggestion', 'next steps', 'what next', 'improve', 'optimize'],
                        execute: () => {
                            setTimeout(() => {
                                const recommendations = document.querySelector('.recommendations-section');
                                if (recommendations) {
                                    recommendations.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 300);
                        },
                        respond: 'Here are AI-powered recommendations to optimize your segment based on performance data.'
                    }
                }
            }
        };

        function processAgentCommand(command) {
            if (agentState.isProcessing) return;
            agentState.isProcessing = true;

            const lowerCommand = command.toLowerCase().trim();
            
            // Check if we're awaiting a confirmation
            if (agentState.awaitingConfirmation) {
                handleConfirmationResponse(lowerCommand);
                agentState.isProcessing = false;
                return;
            }
            
            // Add user message to chat history
            addChatMessage('user', command);
            
            // First, try to find the best matching action across ALL tabs
            const match = findBestActionMatch(lowerCommand);
            
            if (!match) {
                // No match found - provide helpful suggestion
                const suggestion = "I'm not sure what you mean. Try: 'Show overlap analysis', 'Add age filter', 'Go to Smart Splits', or 'Explain rank and limit'";
                addChatMessage('agent', suggestion);
                showChatExpansion();
                agentState.isProcessing = false;
                return;
            }

            // Store original command in match for actions that need it
            match.originalCommand = command;

            // Check if action belongs to current tab or needs navigation
            if (match.tab !== agentState.currentTab) {
                // CROSS-TAB: Ask for confirmation in chat
                const message = `I can ${match.action.confirm || 'help with that'} in the ${match.tabConfig.name} tab. Would you like me to take you there?`;
                addChatMessage('agent', message, ['Yes, take me there', 'No thanks', 'Stay here']);
                
                // Store pending action
                agentState.awaitingConfirmation = true;
                agentState.pendingActionData = {
                    type: 'cross-tab',
                    match: match
                };
                
                showChatExpansion();
            } else {
                // SAME-TAB: Check if needs confirmation
                const needsConfirmation = match.action.execute.toString().includes('addQuickFilter');
                const isTemplateCreation = match.action.execute.toString().includes('createTemplateFromAgent');
                
                if (needsConfirmation) {
                    // Filter addition - ask confirmation
                    const confirmMsg = `Would you like me to ${match.action.confirm}?`;
                    addChatMessage('agent', confirmMsg, ['Yes, do it', 'No thanks', 'Add different filter']);
                    
                    // Store pending action
                    agentState.awaitingConfirmation = true;
                    agentState.pendingActionData = {
                        type: 'same-tab-action',
                        match: match
                    };
                    
                    showChatExpansion();
                } else {
                    // Direct execution (info/view commands and template creation)
                    if (match.action.respond) {
                        addChatMessage('agent', match.action.respond);
                    }
                    executeActionWithChat(match);
                    
                    // For template creation, add follow-up message
                    if (isTemplateCreation) {
                        setTimeout(() => {
                            addChatMessage('agent', 'I\'ve set up a template based on your journey. Review the steps, channels, and attributes, then click "Save & Use Template" when ready!');
                        }, 500);
                    }
                    
                    showChatExpansion();
                }
            }
            
            agentState.isProcessing = false;
        }

        function handleConfirmationResponse(response) {
            // Add user's response to chat
            addChatMessage('user', response);
            
            // Check for positive confirmation
            const isPositive = /^(yes|yeah|yep|sure|ok|okay|confirm|do it|go ahead|proceed|take me|switch)/.test(response);
            const isNegative = /^(no|nope|nah|cancel|stop|dont|don't|stay|never mind|nevermind)/.test(response);
            
            if (isPositive) {
                const pendingData = agentState.pendingActionData;
                
                if (pendingData.type === 'cross-tab') {
                    // Execute cross-tab navigation
                    addChatMessage('agent', `Taking you to ${pendingData.match.tabConfig.name}...`);
                    setTimeout(() => {
                        switchTab(pendingData.match.tab);
                        setTimeout(() => {
                            executeActionWithChat(pendingData.match);
                            addChatMessage('agent', ' Done!');
                        }, 400);
                    }, 300);
                } else if (pendingData.type === 'same-tab-action') {
                    // Execute same-tab action
                    executeActionWithChat(pendingData.match);
                    addChatMessage('agent', ' Done!');
                }
                
                // Reset confirmation state
                agentState.awaitingConfirmation = false;
                agentState.pendingActionData = null;
                
            } else if (isNegative) {
                addChatMessage('agent', 'No problem! Let me know if you need anything else.');
                
                // Reset confirmation state
                agentState.awaitingConfirmation = false;
                agentState.pendingActionData = null;
            } else {
                // Unclear response - ask again
                addChatMessage('agent', 'I didn\'t quite catch that. Please type "yes" to confirm or "no" to cancel.', ['Yes', 'No']);
            }
        }

        function addChatMessage(sender, message, suggestions = []) {
            agentState.chatHistory.push({ sender, message, suggestions, timestamp: Date.now() });
            
            // Keep only last 20 messages
            if (agentState.chatHistory.length > 20) {
                agentState.chatHistory.shift();
            }
            
            renderChatMessages();
        }

        function renderChatMessages() {
            const messagesContainer = document.getElementById('agentChatMessages');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = agentState.chatHistory.map((msg, index) => {
                const isUser = msg.sender === 'user';
                const isLastMessage = index === agentState.chatHistory.length - 1;
                const showSuggestions = !isUser && msg.suggestions && msg.suggestions.length > 0 && isLastMessage;
                
                return `
                    <div class="agent-chat-message ${isUser ? 'user-msg' : ''}">
                        <div class="agent-msg-avatar ${isUser ? 'user' : 'agent'}">
                            ${isUser ? `
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            ` : `
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                                </svg>
                            `}
                        </div>
                        <div>
                            <div class="agent-msg-bubble">${msg.message}</div>
                            ${showSuggestions ? `
                                <div class="agent-msg-suggestions">
                                    ${msg.suggestions.map(sug => `
                                        <div class="agent-suggestion-chip" onclick="selectSuggestion('${sug.replace(/'/g, "\\'")}')">
                                            ${sug}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function selectSuggestion(text) {
            // Set input value and trigger command
            const input = document.getElementById('agentCommandInput');
            if (input) {
                input.value = text;
                processAgentCommand(text);
                input.value = '';
            }
        }

        function showChatExpansion() {
            const expansion = document.getElementById('agentChatExpansion');
            expansion.classList.add('show');
            expansion.classList.remove('collapsed');
            agentState.isExpanded = true;
        }

        function hideChatExpansion() {
            const expansion = document.getElementById('agentChatExpansion');
            expansion.classList.add('collapsed');
            expansion.classList.remove('show');
            agentState.isExpanded = false;
        }

        function executeActionWithChat(match) {
            // Execute the action - pass original command if available
            if (match.originalCommand) {
                match.action.execute(match.originalCommand);
            } else {
                match.action.execute();
            }
            
            // Add highlight animation to newly added element
            if (match.action.confirm && match.action.confirm.includes('filter')) {
                setTimeout(() => {
                    const filterCards = document.querySelectorAll('.filter-card');
                    if (filterCards.length > 0) {
                        const lastFilter = filterCards[filterCards.length - 1];
                        lastFilter.classList.add('action-highlight');
                        setTimeout(() => lastFilter.classList.remove('action-highlight'), 600);
                    }
                }, 100);
            }
        }


        function findBestActionMatch(command) {
            let bestMatch = null;
            let highestScore = 0;

            // Search through all tab configurations
            for (const [key, tabConfig] of Object.entries(actionDatabase)) {
                // Check if command mentions this tab's keywords
                const tabMentioned = tabConfig.keywords.some(kw => command.includes(kw));
                
                // Search through all actions in this tab
                for (const [actionKey, action] of Object.entries(tabConfig.actions)) {
                    // Calculate match score based on pattern matches
                    let score = 0;
                    let matchedPattern = null;
                    
                    for (const pattern of action.patterns) {
                        if (command.includes(pattern)) {
                            // Longer patterns = better match
                            const patternScore = pattern.split(' ').length;
                            if (patternScore > score) {
                                score = patternScore;
                                matchedPattern = pattern;
                            }
                        }
                    }
                    
                    // Boost score if tab was explicitly mentioned
                    if (tabMentioned && score > 0) {
                        score += 2;
                    }
                    
                    // Update best match if this is better
                    if (score > highestScore) {
                        highestScore = score;
                        bestMatch = {
                            tab: tabConfig.tab,
                            tabConfig: tabConfig,
                            actionKey: actionKey,
                            action: action,
                            matchedPattern: matchedPattern,
                            score: score
                        };
                    }
                }
            }

            return bestMatch;
        }




        // Handle Enter key in agent input
        document.addEventListener('DOMContentLoaded', () => {
            const agentInput = document.getElementById('agentCommandInput');
            if (agentInput) {
                agentInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const command = agentInput.value.trim();
                        if (command) {
                            processAgentCommand(command);
                            agentInput.value = '';
                        }
                    }
                });
            }
        });

        // Update agent state when tabs change
        const originalSwitchTab = switchTab;
        switchTab = function(tabIndex) {
            originalSwitchTab(tabIndex);
            agentState.currentTab = tabIndex;
        };
    </script>

    <!-- Global Agentic Command Bar (Hidden on landing page) -->
    <div class="global-agent-bar" id="globalAgentBar">
        <div class="agent-command-container">
            <div class="agent-bar-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
            </div>
            <input 
                type="text" 
                class="agent-command-input" 
                id="agentCommandInput" 
                placeholder="Ask me anything... (e.g., 'Show overlap analysis' or 'Add high LTV filter')"
            >
            <div class="agent-status-indicator">
                <svg class="sparkle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0L14.59 8.41L23 11L14.59 13.59L12 22L9.41 13.59L1 11L9.41 8.41L12 0Z"/>
                </svg>
                Ready
            </div>
        </div>
    </div>

    <!-- Agent Chat Expansion (expands from bottom bar) -->
    <div class="agent-chat-expansion" id="agentChatExpansion">
        <div class="agent-chat-container">
            <div class="agent-chat-header-bar">
                <div class="agent-chat-header-left">
                    <div class="agent-typing-indicator" id="agentTypingIndicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span style="display: none;" id="agentReadyText">AI Assistant</span>
                </div>
                <button class="agent-chat-collapse-icon" onclick="hideChatExpansion()" title="Minimize chat">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="19 9 12 2 5 9"/>
                    </svg>
                </button>
            </div>
            <div class="agent-chat-messages-container" id="agentChatMessages">
                <!-- Messages will be rendered here dynamically -->
            </div>
        </div>
    </div>

    <!-- Activation Success Popup -->
    <div id="activationPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10001; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 1rem; padding: 2.5rem; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popupSlideIn 0.3s ease-out;">
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <h2 style="font-size: 1.75rem; font-weight: 700; color: #1f2937; margin-bottom: 0.75rem;">Segment Activated!</h2>
                <p style="font-size: 1rem; color: #6b7280; line-height: 1.6; margin-bottom: 2rem;">
                    Your segment "High Value Outdoor Enthusiasts" has been successfully activated and is now running across all configured channels.
                </p>
                <button onclick="closeActivationPopup()" style="width: 100%; padding: 1rem 2rem; background: linear-gradient(135deg, #1d72f3 0%, #1557b0 100%); border: none; border-radius: 0.75rem; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(29, 114, 243, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(29, 114, 243, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(29, 114, 243, 0.2)'">
                    View Performance Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Validation Overlays -->
    <div id="validationOverlay" class="validation-overlay">
        <div class="validation-overlay-backdrop" onclick="closeValidationOverlay()"></div>
        <div class="validation-overlay-content">
            <!-- Overlay Header -->
            <div class="validation-overlay-header">
                <button class="validation-back-btn" onclick="closeValidationOverlay()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Rules
                </button>
                <div class="validation-breadcrumb">
                    <span style="color: #9ca3af;">Segment Definition</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2" style="margin: 0 0.5rem;">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                    <span id="validationBreadcrumbTitle" style="color: #1f2937; font-weight: 600;">Preview</span>
                </div>
                <button class="validation-close-btn" onclick="closeValidationOverlay()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Overlay Body - Content will be injected here -->
            <div id="validationOverlayBody" class="validation-overlay-body">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

</body>
</html>
